{% extends 'attendance/base.html' %}

{% block title %}Management Dashboard{% endblock %}

{% block content %}
<style>
    body, table, button, input { font-family: "Times New Roman", Times, serif; }

    /* --- Modal Styles --- */
    .custom-modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.75); display: none;
        justify-content: center; align-items: center; z-index: 2000;
        opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(3px);
    }
    .custom-modal-overlay.active { display: flex; opacity: 1; }
    
    .custom-modal-box {
        background: white; width: 90%; max-width: 900px;
        border-radius: 12px; transform: scale(0.9); transition: transform 0.3s;
        overflow: hidden; position: relative;
        /* Desktop Default: Fixed height */
        max-height: 90vh; display: flex; flex-direction: column;
    }
    .custom-modal-overlay.active .custom-modal-box { transform: scale(1); }

    .modal-close-btn {
        position: absolute; top: 10px; right: 20px; font-size: 30px;
        cursor: pointer; z-index: 100; color: #333; background: rgba(255,255,255,0.8);
        width: 40px; height: 40px; border-radius: 50%;
        text-align: center; line-height: 40px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .modal-close-btn:hover { color: red; background: white; }

    /* --- Split View (Shared by Images and Maps) --- */
    .split-view { 
        display: flex; 
        height: 500px; /* Default Height for Desktop */
        width: 100%;
    }
    .split-half { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        padding: 10px; 
        border-right: 1px solid #ddd; 
        background: #f8f9fa; 
    }
    .split-half:last-child { border-right: none; }
    
    .split-header { 
        text-align: center; font-weight: bold; margin-bottom: 10px; font-size: 1.2rem; 
    }
    
    .content-wrapper { 
        flex: 1; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        background: white; 
        border-radius: 8px; 
        overflow: hidden; 
        box-shadow: inset 0 0 5px rgba(0,0,0,0.1); 
        width: 100%;
        height: 100%;
        position: relative;
    }
    .content-wrapper img { 
        max-width: 100%; 
        max-height: 100%; 
        object-fit: contain; 
    }
    .content-wrapper iframe {
        width: 100%;
        height: 100%;
        border: 0;
    }

    /* --- Mobile Responsiveness --- */
    @media (max-width: 768px) {
        .custom-modal-box { 
            width: 95%; 
            height: auto; 
            max-height: 90vh; /* Keep within screen height */
        }

        .split-view { 
            /* Force vertical stacking */
            flex-direction: column; 
            height: auto; 
            overflow-y: auto; /* Allow scrolling inside the modal */
        }

        .split-half { 
            border-right: none; 
            border-bottom: 1px solid #ddd; 
            /* Fixed height for map/image on mobile to ensure visibility */
            height: 350px; 
            min-height: 350px;
            flex: none; 
        }
    }

    /* Buttons */
    .btn-images {
        background-color: #6f42c1; color: white; border: none;
        padding: 5px 12px; border-radius: 20px; font-size: 0.85rem;
        transition: all 0.2s; box-shadow: 0 2px 4px rgba(111, 66, 193, 0.3);
    }
    .btn-images:hover { background-color: #59359a; color: white; transform: translateY(-1px); }
</style>

<div class="card p-4 mb-4 shadow-sm border-0">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Management Filter (Client-Side)</h4>
        <button onclick="cleanupOldImages()" class="btn btn-outline-danger btn-sm">
            <i class="bi bi-trash3-fill"></i> Cleanup Images (>30 Days)
        </button>
    </div>
    
    <div class="row g-3">
        <div class="col-md-3">
            <label class="small text-muted">From</label>
            <input type="date" id="start_date" class="form-control" oninput="applyFilters()">
        </div>
        <div class="col-md-3">
            <label class="small text-muted">To</label>
            <input type="date" id="end_date" class="form-control" oninput="applyFilters()">
        </div>
        <div class="col-md-4">
            <label class="small text-muted">Employee Name</label>
            <input type="text" id="employee_name" class="form-control" placeholder="Type to search..." oninput="applyFilters()">
        </div>
        <div class="col-md-2 align-self-end">
            <button onclick="resetFilters()" class="btn btn-dark w-100">Reset</button>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0 overflow-hidden">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0 text-center">
            <thead class="table-dark text-uppercase small">
                <tr>
                    <th class="py-3">Date</th>
                    <th class="py-3">Employee</th>
                    <th class="py-3">Role</th>
                    <th class="py-3">Location</th>
                    <th class="py-3">In</th>
                    <th class="py-3">Out</th>
                    <th class="py-3">Period</th>
                    <th class="py-3">Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="bg-white">
            </tbody>
        </table>
    </div>
    <div class="p-3 d-flex justify-content-between align-items-center bg-light border-top">
        <span class="text-muted small" id="pageInfo">Showing 0-0 of 0</span>
        <nav>
            <ul class="pagination mb-0" id="paginationControls"></ul>
        </nav>
    </div>
</div>

<div id="imagesModal" class="custom-modal-overlay">
    <div class="custom-modal-box">
        <div class="modal-close-btn" onclick="closeModal('imagesModal')">×</div>
        <div class="split-view">
            <div class="split-half">
                <div class="split-header text-success">Check In Image</div>
                <div class="content-wrapper" id="modalImgIn"></div>
            </div>
            <div class="split-half">
                <div class="split-header text-danger">Check Out Image</div>
                <div class="content-wrapper" id="modalImgOut"></div>
            </div>
        </div>
    </div>
</div>

<div id="locationModal" class="custom-modal-overlay">
    <div class="custom-modal-box">
        <div class="modal-close-btn" onclick="closeModal('locationModal')">×</div>
        <div class="split-view">
            <div class="split-half">
                <div class="split-header text-success">Check In Location</div>
                <div class="content-wrapper" id="modalMapIn"></div>
            </div>
            <div class="split-half">
                <div class="split-header text-danger">Check Out Location</div>
                <div class="content-wrapper" id="modalMapOut"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const rawData = {{ attendance_data_json|safe }};
    let filteredData = [...rawData];
    let currentPage = 1;
    const itemsPerPage = 20;

    document.addEventListener('DOMContentLoaded', () => {
        applyFilters();
        setupModalClosers();
    });

    // Time Formatter
    function formatTime(isoString) {
        if (!isoString) return '-';
        const date = new Date(isoString);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
    }

    // Calculate Period
    function getPeriodInfo(inIso, outIso) {
        if (!inIso || !outIso) return { text: '-', minutes: 0 };
        
        const inTime = new Date(inIso);
        const outTime = new Date(outIso);
        const diffMs = outTime - inTime;
        
        if (diffMs < 0) return { text: '-', minutes: 0 }; 

        const totalMinutes = Math.floor(diffMs / (1000 * 60));
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        
        return { 
            text: `${hours}:${minutes.toString().padStart(2, '0')}`,
            minutes: totalMinutes
        };
    }

    function applyFilters() {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        const nameQuery = document.getElementById('employee_name').value.toLowerCase();

        filteredData = rawData.filter(item => {
            if (startDate && item.filter_date < startDate) return false;
            if (endDate && item.filter_date > endDate) return false;
            if (nameQuery && !item.user_name.toLowerCase().includes(nameQuery)) return false;
            return true;
        });

        currentPage = 1;
        renderTable();
    }

    function resetFilters() {
        document.getElementById('start_date').value = '';
        document.getElementById('end_date').value = '';
        document.getElementById('employee_name').value = '';
        applyFilters();
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        if (filteredData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="py-5 text-muted">No records found.</td></tr>';
            updatePaginationInfo(0);
            return;
        }

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageItems = filteredData.slice(start, end);

        pageItems.forEach(row => {
            const tr = document.createElement('tr');
            const inPhoto = row.check_in_photo || '';
            const outPhoto = row.check_out_photo || '';
            
            const inLat = row.check_in_lat || null;
            const inLng = row.check_in_lng || null;
            const outLat = row.check_out_lat || null;
            const outLng = row.check_out_lng || null;

            // Logic: Period Color
            const periodInfo = getPeriodInfo(row.check_in, row.check_out);
            let periodClass = '';
            
            if (periodInfo.text !== '-') {
                // Less than 8 hours (480 mins) = Red, else Green
                if (periodInfo.minutes < 480) {
                    periodClass = 'text-danger'; 
                } else {
                    periodClass = 'text-success'; 
                }
            }

            tr.innerHTML = `
                <td class="text-muted fw-bold">${row.date_str}</td>
                <td class="fw-bold">${row.user_name}</td>
                <td><span class="badge bg-secondary fw-normal">${row.user_role}</span></td>
                <td>
                    <button class="btn btn-sm btn-link text-decoration-none fw-bold" 
                            onclick="showLocation(${inLat}, ${inLng}, ${outLat}, ${outLng})">
                        <i class="bi bi-geo-alt-fill"></i> Location
                    </button>
                </td>
                <td class="text-success fw-bold">${formatTime(row.check_in)}</td>
                <td class="text-success fw-bold">${formatTime(row.check_out)}</td>
                <td class="fw-bold ${periodClass}">${periodInfo.text}</td>
                <td>
                    <div class="d-flex justify-content-center gap-2">
                        <button class="btn-images" 
                                onclick="showImages('${inPhoto}', '${outPhoto}')">
                            <i class="bi bi-images me-1"></i> Images
                        </button>
                        <button class="btn btn-sm btn-outline-danger border-0" 
                                onclick="deleteRecord('${row.check_in_id}', '${row.check_out_id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });

        updatePaginationInfo(filteredData.length);
        renderPaginationControls();
    }

    function updatePaginationInfo(total) {
        const start = total === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
        const end = Math.min(currentPage * itemsPerPage, total);
        document.getElementById('pageInfo').innerText = `Showing ${start}-${end} of ${total}`;
    }

    function renderPaginationControls() {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        const ul = document.getElementById('paginationControls');
        ul.innerHTML = '';

        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Prev</a>`;
        ul.appendChild(prevLi);

        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>`;
        ul.appendChild(nextLi);
    }

    function changePage(newPage) {
        if (newPage < 1 || newPage > Math.ceil(filteredData.length / itemsPerPage)) return;
        currentPage = newPage;
        renderTable();
    }

    function showImages(inUrl, outUrl) {
        const containerIn = document.getElementById('modalImgIn');
        const containerOut = document.getElementById('modalImgOut');

        containerIn.innerHTML = (inUrl && inUrl !== 'null' && inUrl !== '') 
            ? `<img src="${inUrl}">` 
            : `<div class="text-muted text-center"><i class="bi bi-slash-circle display-4"></i><br>No Check-in Photo</div>`;

        containerOut.innerHTML = (outUrl && outUrl !== 'null' && outUrl !== '') 
            ? `<img src="${outUrl}">` 
            : `<div class="text-muted text-center"><i class="bi bi-slash-circle display-4"></i><br>No Check-out Photo</div>`;

        document.getElementById('imagesModal').classList.add('active');
    }

    function showLocation(inLat, inLng, outLat, outLng) {
        const mapIn = document.getElementById('modalMapIn');
        const mapOut = document.getElementById('modalMapOut');

        // Check In Map
        if (inLat && inLng) {
            mapIn.innerHTML = `<iframe src="https://www.openstreetmap.org/export/embed.html?bbox=${parseFloat(inLng)-0.005},${parseFloat(inLat)-0.005},${parseFloat(inLng)+0.005},${parseFloat(inLat)+0.005}&layer=mapnik&marker=${inLat},${inLng}"></iframe>`;
        } else {
            mapIn.innerHTML = `<div class="text-muted text-center"><i class="bi bi-geo-alt display-4"></i><br>No Check-in Location</div>`;
        }

        // Check Out Map
        if (outLat && outLng) {
            mapOut.innerHTML = `<iframe src="https://www.openstreetmap.org/export/embed.html?bbox=${parseFloat(outLng)-0.005},${parseFloat(outLat)-0.005},${parseFloat(outLng)+0.005},${parseFloat(outLat)+0.005}&layer=mapnik&marker=${outLat},${outLng}"></iframe>`;
        } else {
            mapOut.innerHTML = `<div class="text-muted text-center"><i class="bi bi-geo-alt display-4"></i><br>No Check-out Location</div>`;
        }

        document.getElementById('locationModal').classList.add('active');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
        if(id === 'locationModal') {
            document.getElementById('modalMapIn').innerHTML = '';
            document.getElementById('modalMapOut').innerHTML = '';
        }
    }

    function setupModalClosers() {
        document.querySelectorAll('.custom-modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeModal(overlay.id);
                }
            });
        });
    }

    // --- NEW: Cleanup Images Function ---
    function cleanupOldImages() {
        Swal.fire({
            title: 'Cleanup Old Images?',
            text: "This will delete all image files older than 30 days. Logs will remain.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ffc107',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, Clean up!'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.showLoading();
                fetch("{% url 'cleanup_images_view' %}", {
                    method: "POST",
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                })
                .then(r => r.json())
                .then(data => {
                    Swal.hideLoading();
                    if(data.status === 'success') {
                        Swal.fire('Cleaned!', data.message, 'success')
                        .then(() => location.reload()); // Reload to reflect empty images if any
                    } else {
                        Swal.fire('Error', data.message, 'error');
                    }
                })
                .catch(err => Swal.fire('Error', 'Network error', 'error'));
            }
        })
    }

    function deleteRecord(inId, outId) {
        Swal.fire({
            title: 'Delete Record?', text: "This cannot be undone.", icon: 'warning',
            showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Yes, Delete'
        }).then((result) => {
            if (result.isConfirmed) {
                const ids = [inId, outId].filter(id => id && id !== 'null' && id !== 'None');
                
                fetch("{% url 'delete_attendance_log' %}", {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                    body: JSON.stringify({ ids: ids })
                })
                .then(r => r.json())
                .then(data => {
                    if(data.status === 'success') {
                        Swal.fire('Deleted!', 'Record removed.', 'success');
                        filteredData = filteredData.filter(item => 
                            String(item.check_in_id) !== String(inId) && 
                            String(item.check_out_id) !== String(outId)
                        );
                        const index = rawData.findIndex(item => 
                             String(item.check_in_id) === String(inId)
                        );
                        if (index > -1) rawData.splice(index, 1);
                        renderTable();
                    } else {
                        Swal.fire('Error', data.message, 'error');
                    }
                });
            }
        })
    }
</script>
{% endblock %}