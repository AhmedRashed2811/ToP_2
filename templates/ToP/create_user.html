{% extends 'ToP/base.html' %}
{% load static %}

{% block title %}Create User{% endblock %}

{% block content %}

<style>
    body { background: #f6f8fb; }

    .container {
        max-width: 820px;
        margin: 24px auto;
        background: #ffffff;
        padding: 28px;
        border-radius: 14px;
        border: 1px solid rgba(0,0,0,.06);
        box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }

    .page-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(0,0,0,.06);
    }

    .page-title h1 {
        margin: 0;
        font-size: 20px;
        font-weight: 800;
        color: #1f2937;
        letter-spacing: .2px;
    }

    .page-title .subtitle {
        margin: 4px 0 0 0;
        font-size: 13px;
        color: #6b7280;
        font-weight: 600;
    }

    .messages { margin-bottom: 12px; }
    .messages p {
        margin: 0 0 10px 0;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(0,0,0,.10);
        font-weight: 800;
        font-size: 14px;
    }
    /* Success messages */
    .messages p.success {
        background: #ecfdf3;
        border-color: rgba(22, 163, 74, .18);
        color: #166534;
    }
    /* Error messages */
    .messages p.error, .messages p.danger {
        background: #fff5f5;
        border-color: rgba(220, 53, 69, .18);
        color: #b42318;
    }
    /* Warning messages */
    .messages p.warning {
        background: #fffbeb;
        border-color: rgba(245, 158, 11, .22);
        color: #92400e;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
    }

    .form-group { margin-bottom: 0; position: relative; }
    .form-group.full { grid-column: 1 / -1; }

    .form-group label {
        display: block;
        font-weight: 800;
        margin-bottom: 6px;
        color: #374151;
        font-size: 13px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 11px 12px;
        border: 1px solid rgba(0,0,0,.14);
        border-radius: 10px;
        font-size: 15px;
        background: #fff;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .form-group textarea { min-height: 88px; resize: vertical; }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        border-color: #2563eb;
        outline: none;
        box-shadow: 0 0 0 4px rgba(37, 99, 235, .12);
    }

    .form-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        margin-right: 10px;
        accent-color: #2563eb;
    }

    .form-group.checkbox-group {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        border-radius: 10px;
        background: #f9fafb;
        border: 1px solid rgba(0,0,0,.06);
        gap: 10px;
    }

    .section {
        margin-top: 14px;
        padding: 14px;
        border-radius: 12px;
        background: #f9fafb;
        border: 1px solid rgba(0,0,0,.06);
    }

    .section-title {
        font-size: 14px;
        font-weight: 900;
        color: #111827;
        margin: 0 0 10px 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .hint {
        font-size: 12px;
        color: #6b7280;
        margin-top: 6px;
        font-weight: 600;
    }

    .password-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
    }

    .password-wrapper input { flex: 1; }

    .toggle-password {
        padding: 10px 12px;
        font-size: 13px;
        cursor: pointer;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 10px;
        transition: transform .05s ease, background 0.2s ease;
        font-weight: 800;
        white-space: nowrap;
    }

    .toggle-password:hover { background: #1d4ed8; }
    .toggle-password:active { transform: translateY(1px); }

    .btn-primary {
        width: 100%;
        background: #9ca3af;
        color: #fff;
        padding: 12px 14px;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        cursor: not-allowed;
        transition: background 0.2s ease, transform .05s ease;
        font-weight: 900;
        letter-spacing: .2px;
    }

    .btn-primary.active { background: #16a34a; cursor: pointer; }
    .btn-primary:hover.active { background: #15803d; }
    .btn-primary:active.active { transform: translateY(1px); }

    .error-message {
        color: #b42318;
        font-size: 13px;
        display: none;
        margin-top: 8px;
        font-weight: 800;
    }

    #uploadCsvBtn { border-radius: 12px; font-weight: 900; }

    #loading-overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(255, 255, 255, 0.85);
        z-index: 9999;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(3px);
    }

    .spinner {
        border: 8px solid #e5e7eb;
        border-top: 8px solid #2563eb;
        border-radius: 50%;
        width: 64px; height: 64px;
        animation: spin 1s linear infinite;
        margin-bottom: 14px;
    }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .loading-text { font-size: 16px; color: #111827; font-weight: 900; }

    /* sections hidden by role logic */
    #company-fields,
    #sales-fields,
    #saleshead-fields,
    #salesops-fields,
    #viewer-fields,
    #admin-fields,
    #business-team-fields,
    #csv-import-section {
        display: none;
    }

    @media (max-width: 768px) {
        .container { max-width: 100%; padding: 18px; border-radius: 14px; }
        .form-grid { grid-template-columns: 1fr; }
        .page-title { flex-direction: column; align-items: flex-start; }
    }
</style>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">Processing File... Please wait.</div>
</div>

<div class="container">
    <div class="page-title">
        <div>
            <h1>Create User</h1>
            <p class="subtitle">Create a new user and assign role, company, team, and permissions.</p>
        </div>
    </div>

    {# ‚úÖ Render messages, but avoid "always shown required field" noise #}
    {% if messages %}
    <div class="messages" id="messagesBox">
        {% for message in messages %}
            {# keep old style but ensure tags appear correctly #}
            <p class="{% if message.tags %}{{ message.tags }}{% endif %}">{{ message|striptags }}</p>
        {% endfor %}
    </div>
    {% endif %}

    <form method="POST" id="userForm" autocomplete="off">
        {% csrf_token %}

        <div class="form-grid">
            <div class="form-group full">
                <label for="id_email">Email</label>
                {{ form.email }}
            </div>

            <div class="form-group full">
                <label for="id_full_name">Full Name</label>
                {{ form.full_name }}
            </div>

            <div class="form-group full">
                <label for="id_role">Role</label>
                {{ form.role }}
                <div class="hint">
                    Company roles require selecting a company. Sales & SalesHead can be assigned to teams.
                </div>
            </div>
        </div>

        <!-- Company required for: CompanyAdmin, SalesHead, Sales, SalesOperation, Manager, Uploader, Viewer -->
        <div id="company-fields" class="section">
            <p class="section-title">üè¢ Company</p>

            <div class="form-grid">
                <div class="form-group full">
                    {% if is_company_admin %}
                        {# ‚úÖ Completely hide the dropdown from CompanyAdmin #}
                        <label>Company</label>
                        <input type="text" value="{{ request.user.company_admin_profile.company.name }}" readonly>

                        {# ‚úÖ Still submit company id (so validation + CSV import + JS works) #}
                        <input type="hidden" id="id_company" name="company" value="{{ request.user.company_admin_profile.company.id }}">
                    {% else %}
                        <label for="id_company">Company</label>
                        {{ form.company }}
                    {% endif %}
                </div>

                <div class="form-group full hint">
                    Used to attach the profile record (Sales / Ops / Manager / etc.) to the correct company.
                </div>
            </div>
        </div>

        <!-- Sales -->
        <div id="sales-fields" class="section">
            <p class="section-title">üßë‚Äçüíº Sales Settings</p>

            <div class="form-grid">
                <div class="form-group full">
                    <label for="id_team">Team</label>
                    {{ form.team }}
                    <div class="hint">Optional. Choose a sales team for the user.</div>
                </div>

                <div class="form-group checkbox-group full">
                    {{ form.can_edit }}
                    <label for="id_can_edit" style="margin:0;">Can Edit</label>
                </div>

                <div class="form-group checkbox-group full">
                    {{ form.can_change_years }}
                    <label for="id_can_change_years" style="margin:0;">Can Change Years</label>
                </div>
            </div>
        </div>

        <!-- Sales Head -->
        <div id="saleshead-fields" class="section">
            <p class="section-title">üßë‚Äç‚úàÔ∏è Sales Head Settings</p>

            <div class="form-grid">
                <div class="form-group full">
                    <label for="id_team">Team</label>
                    {{ form.team }}
                    <div class="hint">Optional. Heads can be linked to a team.</div>
                </div>

                <div class="form-group checkbox-group full">
                    {{ form.one_dp_only }}
                    <label for="id_one_dp_only" style="margin:0;">One DP Only</label>
                </div>
            </div>
        </div>

        <!-- Sales Operation -->
        <div id="salesops-fields" class="section">
            <p class="section-title">üõ†Ô∏è Sales Operation Permissions</p>

            <div class="form-grid">
                <div class="form-group full">
                    <label for="id_editable_unit_fields">Editable Unit Fields</label>
                    {{ form.editable_unit_fields }}
                    <div class="hint">Provide a list (JSON or comma-separated), e.g. <b>price,status</b> or <b>["price","status"]</b>.</div>
                </div>
            </div>
        </div>

        <!-- Viewer -->
        <div id="viewer-fields" class="section">
            <p class="section-title">üëÅÔ∏è Viewer Access</p>

            <div class="form-grid">
                <div class="form-group full">
                    <label for="id_allowed_pages">Allowed Pages</label>
                    {{ form.allowed_pages }}
                    <div class="hint">Provide a list (JSON or comma-separated), e.g. <b>dashboard,map</b> or <b>["dashboard","map"]</b>.</div>
                </div>
            </div>
        </div>

        <!-- Admin + Business Team (Internal) -->
        {% if not is_company_admin %}
        <div id="admin-fields" class="section">
            <p class="section-title">üßæ Admin Details</p>
            <div class="form-grid">
                <div class="form-group full">
                    <label for="id_joining_date">Joining Date</label>
                    {{ form.joining_date }}
                </div>
            </div>
        </div>

        <div id="business-team-fields" class="section">
            <p class="section-title">üë• Business Team Details</p>
            <div class="form-grid">
                <div class="form-group">
                    <label for="id_joining_date">Joining Date</label>
                    {{ form.joining_date }}
                </div>
                <div class="form-group">
                    <label for="id_job_title">Job Title</label>
                    {{ form.job_title }}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- CSV Import for Sales only -->
        <div id="csv-import-section" class="section">
            <p class="section-title">üìÑ CSV Import (Sales)</p>
            <label for="csvFile" style="font-weight:800; color:#374151;">Import Sales users from CSV</label><br>
            <input type="file" id="csvFile" name="csv_file" accept=".csv" style="margin-top:10px;">
            <button id="uploadCsvBtn" type="button" class="btn-primary active" style="margin-top: 12px; display: none;" onclick="importCSV()">
                üìÅ Upload CSV
            </button>
            <div class="hint">Shown only for Sales role after selecting a company.</div>
        </div>

        <div class="section">
            <p class="section-title">üîí Password</p>
            <div class="form-grid">
                <div class="form-group full">
                    <label for="id_password">Password</label>
                    <input type="password" id="id_password" name="password" autocomplete="off">
                </div>

                <div class="form-group full">
                    <label for="id_confirm_password">Confirm Password</label>
                    <input type="password" id="id_confirm_password" name="confirm_password" autocomplete="off">
                </div>
            </div>

            <p class="error-message" id="passwordError">Passwords do not match.</p>
        </div>

        <button type="submit" id="submitBtn" class="btn-primary" disabled>Create User</button>
    </form>
</div>

<script>
    const roleField = document.getElementById('id_role');
    const companyFields = document.getElementById('company-fields');

    const salesFields = document.getElementById('sales-fields');
    const salesHeadFields = document.getElementById('saleshead-fields');
    const salesOpsFields = document.getElementById('salesops-fields');
    const viewerFields = document.getElementById('viewer-fields');

    const adminFields = document.getElementById('admin-fields');
    const businessTeamFields = document.getElementById('business-team-fields');
    const csvSection = document.getElementById('csv-import-section');

    function roleNeedsCompany(role) {
        return ['CompanyAdmin', 'SalesHead', 'Sales', 'SalesOperation', 'Manager', 'Uploader', 'Viewer'].includes(role);
    }

    function toggleRoleSections() {
        const role = roleField.value;
        const companyIdEl = document.getElementById('id_company');
        const companyId = companyIdEl ? companyIdEl.value : "";
        const uploadButton = document.getElementById("uploadCsvBtn");

        companyFields.style.display = roleNeedsCompany(role) ? 'block' : 'none';

        salesFields.style.display = (role === 'Sales') ? 'block' : 'none';
        salesHeadFields.style.display = (role === 'SalesHead') ? 'block' : 'none';
        salesOpsFields.style.display = (role === 'SalesOperation') ? 'block' : 'none';
        viewerFields.style.display = (role === 'Viewer') ? 'block' : 'none';

        if (adminFields) adminFields.style.display = (role === 'Admin') ? 'block' : 'none';
        if (businessTeamFields) businessTeamFields.style.display = (role === 'BusinessTeam') ? 'block' : 'none';

        csvSection.style.display = (role === 'Sales') ? 'block' : 'none';
        if (role === 'Sales' && companyId) uploadButton.style.display = 'inline-block';
        else uploadButton.style.display = 'none';
    }

    roleField.addEventListener('change', toggleRoleSections);
    document.addEventListener('DOMContentLoaded', toggleRoleSections);

    const companySelect = document.getElementById("id_company");
    if (companySelect) companySelect.addEventListener("change", toggleRoleSections);

    function importCSV() {
        const fileInput = document.getElementById("csvFile");
        const companyId = document.getElementById("id_company").value;
        const loadingOverlay = document.getElementById("loading-overlay");

        if (!fileInput.files.length) { alert("Please select a CSV file."); return; }
        if (!companyId) { alert("Please select a company first."); return; }

        loadingOverlay.style.display = "flex";

        const formData = new FormData();
        formData.append("csv_file", fileInput.files[0]);
        formData.append("company_id", companyId);
        formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");

        fetch("{% url 'import_company_users' %}", { method: "POST", body: formData })
            .then(r => r.json())
            .then(data => alert(data.message))
            .catch(err => { console.error(err); alert("Import failed."); })
            .finally(() => loadingOverlay.style.display = "none");
    }
</script>

<script>
    const IS_COMPANY_ADMIN = {{ is_company_admin|yesno:"true,false" }};
    const ACTOR_COMPANY_ID = "{{ actor_company_id|default_if_none:"" }}";

    document.addEventListener("DOMContentLoaded", function () {

        // ‚úÖ auto-hide messages after a short time to prevent "sticky" old errors
        const messagesBox = document.getElementById("messagesBox");
        if (messagesBox) {
            // Hide fake "required" spam if page is fresh GET (not submitted)
            const wasSubmitted = (new URLSearchParams(window.location.search)).get("submitted") === "1";

            // If not submitted, hide required messages (they're noise)
            if (!wasSubmitted) {
                const ps = messagesBox.querySelectorAll("p");
                ps.forEach(p => {
                    const txt = (p.textContent || "").toLowerCase();
                    if (txt.includes("this field is required")) {
                        p.style.display = "none";
                    }
                });
            }

            // Also auto-hide all messages after 4 seconds
            setTimeout(() => { messagesBox.style.display = "none"; }, 4000);
        }

        const emailField = document.getElementById("id_email");
        const fullNameField = document.getElementById("id_full_name");
        const passwordField = document.getElementById("id_password");
        const confirmPasswordField = document.getElementById("id_confirm_password");
        const submitButton = document.getElementById("submitBtn");
        const passwordError = document.getElementById("passwordError");

        submitButton.disabled = true;

        function validateForm() {
            const emailValue = (emailField?.value || "").trim();
            const fullNameValue = (fullNameField?.value || "").trim();
            const passwordValue = passwordField.value;
            const confirmPasswordValue = confirmPasswordField.value;

            const roleValue = roleField.value;
            const companyValue = (document.getElementById("id_company")?.value || "");

            const passwordsMatch = passwordValue && confirmPasswordValue && (passwordValue === confirmPasswordValue);
            passwordError.style.display = passwordsMatch ? "none" : (confirmPasswordValue ? "block" : "none");

            let ok = emailValue && fullNameValue && passwordValue && confirmPasswordValue && passwordsMatch;

            if (ok && roleNeedsCompany(roleValue) && !companyValue) ok = false;

            submitButton.disabled = !ok;
            if (ok) submitButton.classList.add("active"); else submitButton.classList.remove("active");
            submitButton.style.cursor = ok ? "pointer" : "not-allowed";
        }

        function togglePasswordVisibility(field, button) {
            if (field.type === "password") { field.type = "text"; button.textContent = "Hide"; }
            else { field.type = "password"; button.textContent = "Show"; }
        }

        function addToggleButton(field) {
            const wrapper = document.createElement("div");
            wrapper.classList.add("password-wrapper");

            const button = document.createElement("button");
            button.textContent = "Show";
            button.type = "button";
            button.classList.add("toggle-password");
            button.onclick = () => togglePasswordVisibility(field, button);

            field.parentNode.insertBefore(wrapper, field);
            wrapper.appendChild(field);
            wrapper.appendChild(button);
        }

        emailField?.addEventListener("input", validateForm);
        fullNameField?.addEventListener("input", validateForm);
        passwordField.addEventListener("input", validateForm);
        confirmPasswordField.addEventListener("input", validateForm);
        roleField.addEventListener("change", validateForm);

        const companySelect2 = document.getElementById("id_company");
        if (companySelect2) companySelect2.addEventListener("change", validateForm);

        addToggleButton(passwordField);
        addToggleButton(confirmPasswordField);

        validateForm();
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
