{% extends 'ToP/base.html' %}
{% load static %}

{% block title %}Create User{% endblock %}

{% block content %}

<style>
    /* ===== Page background ===== */
    body {
        background: #f6f8fb;
    }

    /* ===== Card-like container ===== */
    .container {
        max-width: 720px;              /* wider + cleaner */
        margin: 24px auto;
        background: #ffffff;
        padding: 28px;
        border-radius: 14px;
        border: 1px solid rgba(0,0,0,.06);
        box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }

    /* Header */
    .page-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(0,0,0,.06);
    }

    .page-title h1 {
        margin: 0;
        font-size: 20px;
        font-weight: 700;
        color: #1f2937;
        letter-spacing: .2px;
    }

    .page-title .subtitle {
        margin: 4px 0 0 0;
        font-size: 13px;
        color: #6b7280;
        font-weight: 500;
    }

    /* Messages */
    .messages p {
        margin: 0 0 10px 0;
        padding: 10px 12px;
        border-radius: 10px;
        background: #fff5f5;
        border: 1px solid rgba(220, 53, 69, .18);
        color: #b42318;
        font-weight: 700;
        font-size: 14px;
    }

    /* Inputs */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
    }

    .form-group {
        margin-bottom: 0;
        position: relative;
    }

    .form-group.full {
        grid-column: 1 / -1;
    }

    .form-group label {
        display: block;
        font-weight: 700;
        margin-bottom: 6px;
        color: #374151;
        font-size: 13px;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 11px 12px;
        border: 1px solid rgba(0,0,0,.14);
        border-radius: 10px;
        font-size: 15px;
        background: #fff;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
        border-color: #2563eb;
        outline: none;
        box-shadow: 0 0 0 4px rgba(37, 99, 235, .12);
    }

    /* Checkbox */
    .form-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        margin-right: 10px;
        accent-color: #2563eb;
    }

    .form-group.checkbox-group {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        border-radius: 10px;
        background: #f9fafb;
        border: 1px solid rgba(0,0,0,.06);
    }

    /* Section blocks */
    .section {
        margin-top: 14px;
        padding: 14px;
        border-radius: 12px;
        background: #f9fafb;
        border: 1px solid rgba(0,0,0,.06);
    }

    .section-title {
        font-size: 14px;
        font-weight: 800;
        color: #111827;
        margin: 0 0 10px 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .hint {
        font-size: 12px;
        color: #6b7280;
        margin-top: 6px;
    }

    /* Password wrapper */
    .password-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
    }

    .password-wrapper input {
        flex: 1;
    }

    .toggle-password {
        padding: 10px 12px;
        font-size: 13px;
        cursor: pointer;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 10px;
        transition: transform .05s ease, background 0.2s ease;
        font-weight: 700;
        white-space: nowrap;
    }

    .toggle-password:hover {
        background: #1d4ed8;
    }

    .toggle-password:active {
        transform: translateY(1px);
    }

    /* Submit Button */
    .btn-primary {
        width: 100%;
        background: #9ca3af;
        color: #fff;
        padding: 12px 14px;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        cursor: not-allowed;
        transition: background 0.2s ease, transform .05s ease;
        font-weight: 800;
        letter-spacing: .2px;
    }

    .btn-primary.active {
        background: #16a34a;
        cursor: pointer;
    }

    .btn-primary:hover.active {
        background: #15803d;
    }

    .btn-primary:active.active {
        transform: translateY(1px);
    }

    /* Error Message */
    .error-message {
        color: #b42318;
        font-size: 13px;
        display: none;
        margin-top: 8px;
        font-weight: 700;
    }

    /* CSV upload button */
    #uploadCsvBtn {
        border-radius: 12px;
        font-weight: 800;
    }

    /* --- LOADING SPINNER STYLES --- */
    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.85);
        z-index: 9999;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(3px);
    }

    .spinner {
        border: 8px solid #e5e7eb;
        border-top: 8px solid #2563eb;
        border-radius: 50%;
        width: 64px;
        height: 64px;
        animation: spin 1s linear infinite;
        margin-bottom: 14px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-text {
        font-size: 16px;
        color: #111827;
        font-weight: 800;
    }

    /* Hide fields dynamically */
    #company-fields,
    #business-team-fields,
    #can-edit-wrapper {
        display: none;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .container {
            max-width: 100%;
            padding: 18px;
            border-radius: 14px;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .page-title {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">Processing File... Please wait.</div>
</div>

<div class="container">
    <div class="page-title">
        <div>
            <h1>Create User</h1>
            <p class="subtitle">Create a new user and assign the right role & permissions.</p>
        </div>
    </div>

    {% if messages %}
    <div class="messages">
        {% for message in messages %}
            <p class="{% if message.tags %}{{ message.tags }}{% endif %}">
                {{ message|striptags }}
            </p>
        {% endfor %}
    </div>
    {% endif %}

    <form method="POST" id="userForm" autocomplete="off">
        {% csrf_token %}

        <!-- Preserve same HTML (only wrapped in a responsive grid) -->
        <div class="form-grid">
            <div class="form-group full">
                <label for="id_email">Email</label>
                {{ form.email }}
            </div>

            <div class="form-group full">
                <label for="id_full_name">Full Name</label>
                {{ form.full_name }}
            </div>

            <div class="form-group full">
                <label for="id_role">Role</label>
                {{ form.role }}
                <div class="hint">
                    Company-based roles require selecting a Company.
                </div>
            </div>
        </div>

        <div id="company-fields" class="section">
            <p class="section-title">üè¢ Company Details</p>

            <div class="form-grid">
                <div class="form-group full">
                    <label for="id_company">Company</label>
                    {{ form.company }}
                </div>

                <div id="can-edit-wrapper" class="form-group checkbox-group full" style="margin-top: 10px;">
                    {{ form.can_edit }}
                    <label for="id_can_edit" style="display:inline; font-weight:700; margin:0;">Can Edit (Company User only)</label>
                </div>

                <div id="can-change-years-wrapper" class="form-group checkbox-group full" style="margin-top: 10px;">
                    {{ form.can_change_years }}
                    <label for="id_can_change_years" style="display:inline; font-weight:700; margin:0;">Can Change Years (Company User only)</label>
                </div>
            </div>
        </div>

        <div id="csv-import-section" class="section" style="display: none; margin-top: 14px;">
            <p class="section-title">üìÑ CSV Import</p>
            <label for="csvFile" style="font-weight:700; color:#374151;">Import Company Users from CSV</label><br>
            <input type="file" id="csvFile" name="csv_file" accept=".csv" style="margin-top:10px;">
            <button id="uploadCsvBtn" type="button" class="btn-primary active" style="margin-top: 12px; display: none;" onclick="importCSV()">üìÅ Upload CSV</button>
            <div class="hint">Shown only for Company User role after selecting a company.</div>
        </div>

        <script>
            const csvRoleField = document.getElementById('id_role');
            const csvCompanyFields = document.getElementById('company-fields');
            const csvBusinessTeamFields = document.getElementById('business-team-fields');
            const csvSection = document.getElementById('csv-import-section');
            const canEditWrapper = document.getElementById('can-edit-wrapper');
            const canChangeYearWrapper = document.getElementById('can-change-years-wrapper');

            function toggleCsvFields() {
                const role = csvRoleField.value;
                const companyId = document.getElementById("id_company").value;
                const uploadButton = document.getElementById("uploadCsvBtn");

                // ‚úÖ NEW: include CompanyFinanceManager
                if (csvCompanyFields) {
                    csvCompanyFields.style.display = ['CompanyUser', 'CompanyController', 'Manager', 'CompanyFinanceManager'].includes(role) ? 'block' : 'none';
                }

                // Only show Can Edit for CompanyUser
                if (canEditWrapper) {
                    canEditWrapper.style.display = (role === 'CompanyUser') ? 'flex' : 'none';
                }

                // Only show Can Change Years for CompanyUser
                if (canChangeYearWrapper) {
                    canChangeYearWrapper.style.display = (role === 'CompanyUser') ? 'flex' : 'none';
                }

                if (csvBusinessTeamFields) {
                    csvBusinessTeamFields.style.display = (role === 'BusinessTeam' || role === 'Developer') ? 'block' : 'none';
                }

                if (csvSection) {
                    csvSection.style.display = (role === 'CompanyUser') ? 'block' : 'none';
                }

                // Show the upload button only when CompanyUser role is selected and a company is picked
                if (role === 'CompanyUser' && companyId) {
                    uploadButton.style.display = 'inline-block';
                } else {
                    uploadButton.style.display = 'none';
                }
            }

            csvRoleField.addEventListener('change', toggleCsvFields);
            document.getElementById("id_company").addEventListener("change", toggleCsvFields);
            document.addEventListener('DOMContentLoaded', toggleCsvFields);

            function importCSV() {
                const fileInput = document.getElementById("csvFile");
                const companyId = document.getElementById("id_company").value;
                const loadingOverlay = document.getElementById("loading-overlay"); // Get overlay

                if (!fileInput.files.length) {
                    alert("Please select a CSV file.");
                    return;
                }

                if (!companyId) {
                    alert("Please select a company first.");
                    return;
                }

                // Show Spinner
                loadingOverlay.style.display = "flex";

                const formData = new FormData();
                formData.append("csv_file", fileInput.files[0]);
                formData.append("company_id", companyId);
                formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");

                fetch("{% url 'import_company_users' %}", {
                    method: "POST",
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("Import failed.");
                })
                .finally(() => {
                    // Hide Spinner regardless of success or failure
                    loadingOverlay.style.display = "none";
                });
            }
        </script>

        <div id="business-team-fields" class="section">
            <p class="section-title">üë• Business Team Details</p>
            <div class="form-grid">
                <div class="form-group">
                    <label for="id_joining_date">Joining Date</label>
                    {{ form.joining_date }}
                </div>
                <div class="form-group">
                    <label for="id_job_title">Job Title</label>
                    {{ form.job_title }}
                </div>
            </div>
        </div>

        <div class="section">
            <p class="section-title">üîí Password</p>
            <div class="form-grid">
                <div class="form-group full">
                    <label for="id_password">Password</label>
                    <input type="password" id="id_password" name="password" autocomplete="off">
                </div>

                <div class="form-group full">
                    <label for="id_confirm_password">Confirm Password</label>
                    <input type="password" id="id_confirm_password" name="confirm_password" autocomplete="off">
                </div>
            </div>

            <p class="error-message" id="passwordError">Passwords do not match.</p>
        </div>

        <button type="submit" id="submitBtn" class="btn-primary" disabled>Create User</button>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const emailField = document.getElementById("id_email");
        const fullNameField = document.getElementById("id_full_name");
        const passwordField = document.getElementById("id_password");
        const confirmPasswordField = document.getElementById("id_confirm_password");
        const submitButton = document.getElementById("submitBtn");

        // Disable submit button initially
        submitButton.disabled = true;
        submitButton.style.backgroundColor = "#9ca3af";
        submitButton.style.cursor = "not-allowed";

        function validateForm() {
            const emailValue = emailField.value.trim();
            const fullNameValue = fullNameField.value.trim();
            const passwordValue = passwordField.value;
            const confirmPasswordValue = confirmPasswordField.value;

            const roleField = document.getElementById('id_role');
            const companyFields = document.getElementById('company-fields');
            const businessTeamFields = document.getElementById('business-team-fields');

            // Check if required fields are filled & passwords match
            if (
                emailValue !== "" &&
                fullNameValue !== "" &&
                passwordValue !== "" &&
                confirmPasswordValue !== "" &&
                passwordValue === confirmPasswordValue
            ) {
                submitButton.disabled = false;
                submitButton.classList.add("active");
                submitButton.style.cursor = "pointer";
            } else {
                submitButton.disabled = true;
                submitButton.classList.remove("active");
                submitButton.style.cursor = "not-allowed";
            }

            const roleValue = document.getElementById("id_role").value;
            const companyValue = document.getElementById("id_company").value;

            // ‚úÖ NEW: include CompanyFinanceManager
            const companyRequired = ['CompanyUser', 'CompanyController', 'Manager', 'CompanyFinanceManager'].includes(roleValue);

            // Require company if role needs it
            if (companyRequired && !companyValue) {
                submitButton.disabled = true;
                submitButton.classList.remove("active");
                submitButton.style.cursor = "not-allowed";
                return;
            }
        }

        function togglePasswordVisibility(field, button) {
            if (field.type === "password") {
                field.type = "text";
                button.textContent = "Hide";
            } else {
                field.type = "password";
                button.textContent = "Show";
            }
        }

        function addToggleButton(field) {
            const wrapper = document.createElement("div");
            wrapper.classList.add("password-wrapper");

            const button = document.createElement("button");
            button.textContent = "Show";
            button.type = "button";
            button.classList.add("toggle-password");
            button.onclick = function () {
                togglePasswordVisibility(field, button);
            };

            field.parentNode.insertBefore(wrapper, field);
            wrapper.appendChild(field);
            wrapper.appendChild(button);
        }

        // Attach event listeners
        emailField.addEventListener("input", validateForm);
        fullNameField.addEventListener("input", validateForm);
        passwordField.addEventListener("input", validateForm);
        confirmPasswordField.addEventListener("input", validateForm);

        // Add toggle buttons
        addToggleButton(passwordField);
        addToggleButton(confirmPasswordField);
    });


    const roleField = document.getElementById('id_role');
    const companyFields = document.getElementById('company-fields');
    const businessTeamFields = document.getElementById('business-team-fields');

    function toggleFields() {
        const role = roleField.value;

        // ‚úÖ NEW: Show company field for CompanyUser, CompanyController, Manager, CompanyFinanceManager
        if (['CompanyUser', 'CompanyController', 'Manager', 'CompanyFinanceManager'].includes(role)) {
            companyFields.style.display = 'block';
        } else {
            companyFields.style.display = 'none';
        }

        // Show business team fields for BusinessTeam and Developer
        if (['BusinessTeam', 'Developer'].includes(role)) {
            businessTeamFields.style.display = 'block';
        } else {
            businessTeamFields.style.display = 'none';
        }
    }

    roleField.addEventListener('change', toggleFields);
    document.addEventListener('DOMContentLoaded', toggleFields);  // ‚úÖ this line should stay
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}
