{% extends 'ToP/base.html' %}
{% load static %}
{% block title %}Market Units{% endblock %}
{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    /* REQUIRED BY YOU */
    .container { margin-top: 0; padding: 0; }
    @media (min-width: 1400px) {
        .container, .container-lg, .container-md, .container-sm, .container-xl, .container-xxl { max-width: 100%; }
    }
    @media (min-width: 576px) { .container, .container-sm { max-width: 100%; } }
    table{ margin-top: 0; }

    .modal-backdrop{
        --bs-backdrop-opacity: 1.5;
    }
    th { min-width: 150px; }

    :root{
        --bg:#f6f7fb;
        --card:#ffffff;
        --text:#111827;
        --muted:#6b7280;
        --border: rgba(17,24,39,.10);
        --shadow-sm: 0 10px 22px rgba(17,24,39,.06);
        --shadow-lg: 0 30px 90px rgba(0,0,0,.25);

        --primary:#2563eb;
        --primary-2:#1d4ed8;

        --danger:#ef4444;
        --danger-2:#dc2626;

        --input-bg: rgba(37,99,235,.10);
        --calc-bg: rgba(17,24,39,.08);

        --radius: 16px;
    }

    .page{ padding: 18px; margin-top: 80px; }

    .header{
        display:flex; justify-content:space-between; align-items:flex-start;
        gap: 12px; margin-bottom: 12px;
    }
    .header h1{ margin:0; font-size: 20px; color: var(--text); }
    .header p{ margin:6px 0 0; color: var(--muted); font-size: 13px; }

    .panel{
        background: var(--card);
        border:1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
        overflow:hidden;
    }

    .toolbar{
        padding: 12px;
        border-bottom:1px solid var(--border);
        display:flex;
        flex-wrap:wrap;
        align-items:center;
        gap: 10px;
        background: #fbfbfd;
    }

    .btn{
        border:none; border-radius: 12px;
        padding: 10px 12px;
        font-weight: 900;
        cursor:pointer;
        transition: .15s ease;
        font-size: 13px;
        display:inline-flex;
        align-items:center;
        gap: 8px;
        white-space:nowrap;
        user-select:none;
    }
    .btn-primary{ background: var(--primary); color:#fff; }
    .btn-primary:hover{ background: var(--primary-2); }
    .btn-ghost{ background:#fff; border:1px solid var(--border); color: var(--text); }
    .btn-ghost:hover{ box-shadow: var(--shadow-sm); }
    .btn-danger{ background: var(--danger); color:#fff; }
    .btn-danger:hover{ background: var(--danger-2); }

    .input, .select{
        border:1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 13px;
        outline:none;
        background:#fff;
        color: var(--text);
        min-width: 260px;
        max-width: 480px;
    }
    .input:focus, .select:focus{
        border-color: rgba(37,99,235,.55);
        box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    .table-wrap{ overflow:auto; border-top: 1px solid var(--border); }

    table{
        border-collapse: collapse;
        background:#fff;
        table-layout: auto;
        width: max-content;
        min-width: 100%;
    }

    th, td{
        border-bottom: 1px solid rgba(17,24,39,.08);
        padding: 10px 12px;
        text-align:left;
        font-size: 12px;
        vertical-align: top;
        color: var(--text);
        white-space: nowrap;
    }
    th{
        position: sticky; top: 0; z-index: 3;
        background: #fbfbfd;
        color: var(--muted);
        font-size: 11px;
        letter-spacing: .2px;
    }
    tr:hover td{ background:#fafafa; }

    .cell-input{
        width: 100%;
        min-width: 0;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid rgba(37,99,235,.18);
        background: var(--input-bg);
        outline:none;
        font-size: 12px;
        box-sizing: border-box;
    }
    .cell-calc{
        width: 100%;
        min-width: 0;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid rgba(17,24,39,.14);
        background: var(--calc-bg);
        outline:none;
        font-size: 12px;
        color: #111827;
        box-sizing: border-box;
    }
    .cell-readonly{
        background: rgba(17,24,39,.05);
        border: 1px solid rgba(17,24,39,.12);
    }

    .trash{
        border: none; background: transparent;
        color: var(--danger);
        cursor:pointer;
        font-size: 16px;
        padding: 6px 8px;
        border-radius: 10px;
    }
    .trash:hover{ background: rgba(239,68,68,.08); }

    .pagination{
        padding: 12px;
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap: 10px;
        flex-wrap:wrap;
        border-top:1px solid var(--border);
        background: #fbfbfd;
    }
    .pages{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
    .page-btn{
        border:1px solid var(--border);
        background:#fff;
        padding: 7px 10px;
        border-radius: 10px;
        cursor:pointer;
        font-weight:900;
        font-size: 12px;
        color: var(--text);
        user-select:none;
    }
    .page-btn:hover{ box-shadow: var(--shadow-sm); }
    .page-btn.active{ background: var(--primary); color:#fff; border-color: rgba(37,99,235,.25); }
    .hint{ font-size: 12px; color: var(--muted); }

    /* =========================
       EXCEL-LIKE FILTER UI IN TH
       ========================= */
    .th-wrap{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap: 8px;
        width: 100%;
    }
    .filter-btn{
        border: 1px solid rgba(17,24,39,.12);
        background: #ffffff;
        color: #6b7280;
        width: 22px;
        height: 22px;
        border-radius: 6px;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
        flex: 0 0 auto;
        box-shadow: 0 1px 0 rgba(17,24,39,.03);
    }
    .filter-btn:hover{
        color: #111827;
        box-shadow: 0 6px 16px rgba(17,24,39,.08);
    }
    .filter-btn.active{
        color: #1d4ed8;
        border-color: rgba(29,78,216,.28);
        background: rgba(37,99,235,.08);
    }

    .filter-pop{
        position: fixed;
        z-index: 10000;
        min-width: 280px;
        max-width: 340px;
        max-height: 440px;
        background: #fff;
        border: 1px solid rgba(17,24,39,.14);
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0,0,0,.22);
        overflow:hidden;
        display:none;
    }
    .filter-pop.show{ display:block; }

    .filter-head{
        padding: 10px 12px;
        border-bottom: 1px solid rgba(17,24,39,.10);
        background: #fbfbfd;
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap: 8px;
    }
    .filter-head .title{
        font-weight: 900;
        font-size: 12px;
        color: #111827;
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap;
    }
    .filter-head .x{
        border:none;
        background: transparent;
        cursor:pointer;
        color:#6b7280;
        padding: 6px 8px;
        border-radius: 10px;
    }
    .filter-head .x:hover{ background: rgba(17,24,39,.06); color:#111827; }

    .filter-body{
        padding: 10px 12px;
        display:flex;
        flex-direction:column;
        gap: 10px;
    }
    .filter-search{
        width: 100%;
        border: 1px solid rgba(17,24,39,.12);
        border-radius: 10px;
        padding: 8px 10px;
        font-size: 12px;
        outline:none;
    }
    .filter-search:focus{
        border-color: rgba(37,99,235,.55);
        box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    .filter-actions{
        display:flex;
        gap: 8px;
        flex-wrap:wrap;
    }
    .mini-btn{
        border:1px solid rgba(17,24,39,.12);
        background:#fff;
        padding: 7px 9px;
        border-radius: 10px;
        cursor:pointer;
        font-weight: 900;
        font-size: 11px;
        color:#111827;
    }
    .mini-btn:hover{ box-shadow: 0 10px 22px rgba(17,24,39,.06); }

    .filter-list{
        border: 1px solid rgba(17,24,39,.10);
        border-radius: 10px;
        overflow:auto;
        max-height: 250px;
        background:#fff;
    }
    .filter-item{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap: 10px;
        padding: 8px 10px;
        font-size: 12px;
        border-bottom: 1px solid rgba(17,24,39,.06);
    }
    .filter-item:last-child{ border-bottom:none; }
    .filter-item:hover{ background: rgba(17,24,39,.03); }
    .filter-item label{
        display:flex;
        align-items:center;
        gap: 8px;
        margin:0;
        cursor:pointer;
        flex: 1 1 auto;
        overflow:hidden;
    }
    .filter-item .val{
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap;
        color:#111827;
        font-weight: 800;
    }
    .filter-item .count{
        flex: 0 0 auto;
        color:#6b7280;
        font-size: 11px;
        font-weight: 900;
    }

    .filter-foot{
        padding: 10px 12px;
        border-top: 1px solid rgba(17,24,39,.10);
        background: #fbfbfd;
        display:flex;
        justify-content:flex-end;
        gap: 8px;
    }

    /* =========================
       MODAL (Create Unit) â€” using your required styles
       ========================= */
    .modal-backdrop{
        position: fixed;
        inset: 0;
        background: rgba(17,24,39,.58);
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 18px;
        z-index: 9999;
    }
    .modal-backdrop.show{ display:flex; }

    .modal-card{
        width: min(980px, 100%);
        background: var(--card);
        border: 1px solid rgba(255,255,255,.15);
        border-radius: 18px;
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        max-height: 92vh;
        display:flex;
        flex-direction: column;
    }

    .modal-head{
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(180deg, #ffffff 0%, #fbfbfd 100%);
        display:flex;
        justify-content: space-between;
        align-items:center;
        gap: 10px;
    }
    .modal-title{
        display:flex;
        flex-direction: column;
        gap: 2px;
    }
    .modal-head h2{ margin:0; font-size: 16px; color: var(--text); }
    .modal-head .sub{
        font-size: 12px;
        color: var(--muted);
        margin:0;
    }

    .modal-close{
        border:none;
        background: rgba(17,24,39,.04);
        font-size: 18px;
        cursor:pointer;
        color: var(--muted);
        padding: 8px 10px;
        border-radius: 12px;
        transition: .15s ease;
        line-height: 1;
    }
    .modal-close:hover{ background: rgba(17,24,39,.08); color: #111827; }

    .modal-body{
        padding: 16px;
        overflow:auto;
        background: var(--bg);
    }

    /* REQUIRED BY YOU */
    .form-shell{
        padding: 14px;
        background:#fff;
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: 0 10px 24px rgba(17,24,39,.06);
    }
    /* REQUIRED BY YOU */
    .form-grid{
        display:flex;
        grid-template-columns: repeat(12, 1fr);
        gap: 12px;
        flex-wrap: wrap;
        align-items:flex-start;
    }

    .fgroup{
        display:flex;
        flex-direction:column;
        gap: 6px;
        width: 100%;
    }
    .col-12{ flex: 0 0 100%; }
    .col-6{ flex: 0 0 100%; }
    .col-4{ flex: 0 0 100%; }
    .col-3{ flex: 0 0 100%; }

    @media (min-width: 900px){
        .col-6{ flex: 0 0 calc(50% - 12px); }
        .col-4{ flex: 0 0 calc(33.333% - 12px); }
        .col-3{ flex: 0 0 calc(25% - 12px); }
        .col-12{ flex: 0 0 100%; }
    }

    .fgroup label{
        display:flex;
        align-items:center;
        justify-content: space-between;
        font-size: 12px;
        color: var(--muted);
        font-weight: 900;
        letter-spacing: .2px;
    }
    .fgroup input, .fgroup select, .fgroup textarea{
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 13px;
        outline:none;
        background:#fff;
        box-sizing: border-box;
    }
    .fgroup textarea{ resize: vertical; }
    .fgroup input:focus, .fgroup select:focus, .fgroup textarea:focus{
        border-color: rgba(37,99,235,.55);
        box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }
    .fgroup .readonly{
        background: rgba(17,24,39,.05);
    }

    .modal-foot{
        padding: 14px 16px;
        border-top: 1px solid var(--border);
        background: #fbfbfd;
        display:flex;
        justify-content: space-between;
        align-items:center;
        gap: 10px;
        flex-wrap:wrap;
    }
    .modal-foot .left-hint{
        color: var(--muted);
        font-size: 12px;
    }
</style>

<div class="page">
    <div class="header">
        <div>
            <h1>Market Unit Data</h1>
        </div>
    </div>

    <div class="panel">
        <div class="toolbar">
            <button class="btn btn-primary" id="addUnitBtn" type="button">
                <i class="fa-solid fa-plus"></i> Add Unit
            </button>

            <button class="btn btn-danger" id="clearAllBtn" type="button" title="Delete all units">
                <i class="fa-solid fa-triangle-exclamation"></i> Clear All
            </button>

            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <input class="input" id="searchInput" type="text" placeholder="Global search (Developer first, then Project)...">
                <select class="select" id="pageSizeSelect" style="min-width:140px;">
                    {% for s in page_size_options %}
                        <option value="{{ s }}" {% if page_size == s %}selected{% endif %}>{{ s }}/page</option>
                    {% endfor %}
                </select>
            </div>

            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-left:auto;">
                <input class="input" id="csvFile" type="file" accept=".csv" style="min-width:260px;">
                <button class="btn btn-ghost" id="importBtn" type="button">
                    <i class="fa-solid fa-file-import"></i> Import CSV
                </button>
            </div>
        </div>

        <div class="table-wrap">
            <table id="unitsTable">
                <thead>
                    <tr id="unitsHeaderRow">
                        <th data-field="_actions" style="min-width: 5px;">Actions</th>
                        <th data-field="project_name">Project</th>
                        <th data-field="developer_name">Developer</th>
                        <th data-field="location">Location</th>
                        <th data-field="asset_type">Asset Type</th>
                        <th data-field="unit_type">Unit Type</th>
                        <th data-field="offering">Offering</th>
                        <th data-field="finishing_specs">Finishing</th>
                        <th data-field="bua">BUA</th>
                        <th data-field="land_area">Land</th>
                        <th data-field="garden">Garden</th>
                        <th data-field="unit_price">Unit Price</th>
                        <th data-field="psm">PSM</th>
                        <th data-field="payment_yrs_raw">Payment yrs raw</th>
                        <th data-field="payment_yrs">Payment yrs</th>
                        <th data-field="down_payment">Down Payment</th>
                        <th data-field="delivery_percentage">Delivery %</th>
                        <th data-field="cash_discount">Cash Discount</th>
                        <th data-field="delivery_date">Delivery Date</th>
                        <th data-field="maintenance">Maintenance</th>
                        <th data-field="phase">Phase</th>
                        <th data-field="date_of_update">Date of Update</th>
                        <th data-field="months_from_update">Months From Update</th>
                        <th data-field="updated_by">Updated By</th>
                        <th data-field="source_of_info">Source</th>
                        <th data-field="dp_percentage">DP %</th>
                        <th data-field="notes">Notes</th>
                    </tr>
                </thead>

                <tbody id="rowsTbody">
                    {% include "ToP/partials/market_unit_data_rows.html" %}
                </tbody>
            </table>
        </div>

        <div id="paginationBox">
            {% include "ToP/partials/market_unit_data_pagination.html" %}
        </div>
    </div>
</div>

<form id="csrfProvider" style="display:none;">{% csrf_token %}</form>

<!-- Filter popup (single global instance) -->
<div class="filter-pop" id="filterPop" aria-hidden="true">
    <div class="filter-head">
        <div class="title" id="filterTitle">Filter</div>
        <button class="x" type="button" id="filterCloseBtn" title="Close">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>
    <div class="filter-body">
        <input class="filter-search" id="filterSearch" type="text" placeholder="Search values...">

        <div class="filter-actions">
            <button class="mini-btn" type="button" id="filterSelectAll">Select All</button>
            <button class="mini-btn" type="button" id="filterClear">Clear</button>
        </div>

        <div class="filter-list" id="filterList"></div>
    </div>
    <div class="filter-foot">
        <button class="mini-btn" type="button" id="filterCancel">Cancel</button>
        <button class="mini-btn" type="button" id="filterApply" style="border-color: rgba(29,78,216,.28); background: rgba(37,99,235,.08); color:#1d4ed8;">
            Apply
        </button>
    </div>
</div>

<!-- =========================
     CREATE UNIT MODAL
     ========================= -->
<div class="modal-backdrop" id="createModalBackdrop" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="createUnitTitle">
        <div class="modal-head">
            <div class="modal-title">
                <h2 id="createUnitTitle">Add Market Unit</h2>
                <p class="sub">Date of Update defaults to today. Press ESC or click outside to close.</p>
            </div>
            <button class="modal-close" id="closeModalBtn" type="button" title="Close (Esc)">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <div class="modal-body">
            <div class="form-shell">
                <form id="createUnitForm">
                    <div class="form-grid">

                        <div class="fgroup col-6">
                            <label>Project <span style="color:#ef4444;">*</span></label>
                            <select name="project_name" id="modalProjectSelect" required>
                                <option value="">Select</option>
                                {% for p in projects %}
                                    <option value="{{ p.id }}"
                                            data-dev="{{ p.developer.name|default_if_none:'' }}"
                                            data-loc="{{ p.location.name|default_if_none:'' }}">
                                        {{ p.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="fgroup col-3">
                            <label>Developer</label>
                            <input name="developer_name" id="modalDeveloper" class="readonly" readonly>
                        </div>

                        <div class="fgroup col-3">
                            <label>Location</label>
                            <input name="location" id="modalLocation" class="readonly" readonly>
                        </div>

                        <div class="fgroup col-4">
                            <label>Asset Type</label>
                            <select name="asset_type">
                                <option value="">Select</option>
                                {% for a in asset_types %}
                                    <option value="{{ a.name }}">{{ a.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="fgroup col-4">
                            <label>Unit Type <span style="color:#ef4444;">*</span></label>
                            <select name="unit_type" required>
                                <option value="">Select</option>
                                {% for t in unit_types %}
                                    <option value="{{ t.name }}">{{ t.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="fgroup col-4"><label>Offering</label><input name="offering"></div>


                        <div class="fgroup col-4">
                            <label>Finishing Specs</label>
                            <select name="finishing_specs">
                                <option value="">Select</option>
                                {% for f in finishing_specs %}
                                    <option value="{{ f.name }}">{{ f.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="fgroup col-3"><label>BUA</label><input name="bua" type="number" step="any"></div>
                        <div class="fgroup col-3"><label>Land Area</label><input name="land_area" type="number" step="any"></div>
                        <div class="fgroup col-3"><label>Garden</label><input name="garden" type="number" step="any"></div>
                        <div class="fgroup col-3"><label>Unit Price</label><input name="unit_price" type="number" step="any"></div>

                        <div class="fgroup col-4"><label>Payment yrs raw</label><input name="payment_yrs_raw"></div>
                        <div class="fgroup col-4"><label>Down Payment</label><input name="down_payment" type="number" step="any"></div>
                        <div class="fgroup col-4"><label>Delivery %</label><input name="delivery_percentage" type="number" step="any"></div>

                        <div class="fgroup col-4"><label>Cash Discount</label><input name="cash_discount" type="number" step="any"></div>
                        <div class="fgroup col-4"><label>Delivery Date</label><input name="delivery_date"></div>
                        <div class="fgroup col-4"><label>Maintenance</label><input name="maintenance" type="number" step="any"></div>

                        <div class="fgroup col-3"><label>Phase</label><input name="phase" type="number" step="any"></div>

                        <div class="fgroup col-3">
                            <label>Date of Update</label>
                            <input name="date_of_update" id="modalDateOfUpdate" type="date">
                        </div>

                        <div class="fgroup col-6"><label>Source of Info</label><input name="source_of_info"></div>

                        <div class="fgroup col-3"><label>DP %</label><input name="dp_percentage"></div>
                        <div class="fgroup col-9"><label>Notes</label><textarea name="notes" rows="2"></textarea></div>

                    </div>
                </form>
            </div>
        </div>

        <div class="modal-foot">
            <div class="left-hint">Fields marked with <span style="color:#ef4444; font-weight:900;">*</span> are required.</div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
                <button class="btn btn-ghost" type="button" id="cancelModalBtn">Cancel</button>
                <button class="btn btn-primary" type="button" id="submitCreateBtn">
                    <i class="fa-solid fa-circle-plus"></i> Add
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const LIST_URL   = "{% url 'market_unit_data_list' %}";
    const UPDATE_URL = "{% url 'update_market_unit_field' %}";
    const CREATE_URL = "{% url 'create_market_unit' %}";
    const DELETE_URL = "{% url 'delete_market_unit' %}";
    const IMPORT_URL = "{% url 'import_market_units' %}";
    const CLEAR_ALL_URL = "{% url 'clear_all_market_units' %}";

    const tableEl = document.getElementById("unitsTable");
    const tbodyEl = document.getElementById("rowsTbody");

    // Column field map (must match the row inputs/selects data-field used in partial)
    const HEADER_FIELDS = Array.from(document.querySelectorAll("#unitsHeaderRow th")).map(th => th.dataset.field || "");

    // Filters state: { field: Set(values) }
    const activeFilters = {};
    let currentGlobalQuery = "";

    // Filter popup state
    const filterPop = document.getElementById("filterPop");
    const filterTitle = document.getElementById("filterTitle");
    const filterList = document.getElementById("filterList");
    const filterSearch = document.getElementById("filterSearch");
    let filterTargetField = null;
    let filterAnchorBtn = null;

    function getCSRFToken(){
        const el = document.querySelector('#csrfProvider [name=csrfmiddlewaretoken]');
        if(el && el.value) return el.value;
        return document.cookie.split('; ').find(r => r.startsWith('csrftoken='))?.split('=')[1];
    }

    // =========================
    // Date helpers + Months calc (always on load)
    // =========================
    function todayISO(){
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,"0");
        const day = String(d.getDate()).padStart(2,"0");
        return `${y}-${m}-${day}`;
    }

    // months_from_update = TEXT(MIN(12,ROUND((TODAY()-date)/365.25*12,0)),"00")
    function calcMonthsFromUpdate(dateStr){
        if(!dateStr) return "";
        const d = new Date(dateStr + "T00:00:00");
        if(isNaN(d.getTime())) return "";
        const now = new Date();
        const diffMs = now.getTime() - d.getTime();
        const diffDays = diffMs / (1000*60*60*24);
        let months = Math.round((diffDays / 365.25) * 12);
        months = Math.min(12, Math.max(0, months));
        return String(months).padStart(2, "0");
    }

    function refreshMonthsFromUpdateOnPage(){
        document.querySelectorAll("#rowsTbody tr").forEach(tr => {
            const dateInp = tr.querySelector("[data-field='date_of_update']");
            const monthsInp = tr.querySelector("[data-field='months_from_update']");
            if(!monthsInp) return;

            const dateVal = (dateInp && dateInp.value) ? dateInp.value.trim() : "";
            monthsInp.value = calcMonthsFromUpdate(dateVal);
        });
    }

    // =========================
    // Sorting (current page) by date_of_update desc
    // =========================
    function sortRowsByDateDesc(){
        const rows = Array.from(tbodyEl.querySelectorAll("tr"));
        rows.sort((a, b) => {
            const ad = a.querySelector("[data-field='date_of_update']")?.value || "";
            const bd = b.querySelector("[data-field='date_of_update']")?.value || "";
            // empty dates go last
            if(!ad && !bd) return 0;
            if(!ad) return 1;
            if(!bd) return -1;
            return bd.localeCompare(ad);
        });
        rows.forEach(r => tbodyEl.appendChild(r));
    }

    // =========================
    // AJAX pagination
    // =========================
    async function fetchPage(page){
        const pageSize = document.getElementById("pageSizeSelect").value;
        const url = `${LIST_URL}?ajax=1&page=${page}&page_size=${pageSize}`;
        const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
        const data = await res.json();
        if(!data.success){
            Swal.fire("Error", data.error || "Failed to load page", "error");
            return;
        }
        tbodyEl.innerHTML = data.rows_html;
        document.getElementById("paginationBox").innerHTML = data.pagination_html;

        // Always enforce:
        // - months computed on load (not static)
        // - sort by date desc (page view)
        refreshMonthsFromUpdateOnPage();
        sortRowsByDateDesc();

        bindRowEvents();
        bindPaginationEvents();
        installHeaderFilters();   // rebuild filter buttons each load
        applyAllFiltering();      // reapply global + column filters
    }

    function bindPaginationEvents(){
        document.querySelectorAll("[data-page-btn]").forEach(btn => {
            btn.addEventListener("click", () => fetchPage(btn.getAttribute("data-page")));
        });
    }
    document.getElementById("pageSizeSelect").addEventListener("change", () => fetchPage(1));

    // =========================
    // Global search (Developer first, then Project)
    // =========================
    const searchInputEl = document.getElementById("searchInput");
    searchInputEl.addEventListener("input", () => {
        currentGlobalQuery = (searchInputEl.value || "").trim().toLowerCase();
        applyAllFiltering();
    });

    function rowValue(tr, field){
        // project_name is a select: use selected option text
        if(field === "project_name"){
            const sel = tr.querySelector("select[data-field='project_name']");
            return (sel?.selectedOptions?.[0]?.textContent || "").trim();
        }

        // selects use selected option text
        const sel = tr.querySelector(`select[data-field='${field}']`);
        if(sel){
            return (sel.selectedOptions?.[0]?.textContent || "").trim();
        }

        // inputs/textarea use value
        const inp = tr.querySelector(`[data-field='${field}']`);
        if(inp){
            return (inp.value || "").trim();
        }

        return "";
    }

    function globalMatch(tr){
        const q = currentGlobalQuery;
        if(!q) return true;

        const dev = (rowValue(tr, "developer_name") || "").toLowerCase();
        if(dev.includes(q)) return true;

        const proj = (rowValue(tr, "project_name") || "").toLowerCase();
        return proj.includes(q);
    }

    function filtersMatch(tr){
        for(const field in activeFilters){
            const set = activeFilters[field];
            if(!set || set.size === 0) continue;
            const v = rowValue(tr, field);
            if(!set.has(v)) return false;
        }
        return true;
    }

    function applyAllFiltering(){
        // Always compute months before filtering (so visible values are correct)
        refreshMonthsFromUpdateOnPage();

        // Keep sorted view
        sortRowsByDateDesc();

        document.querySelectorAll("#rowsTbody tr").forEach(tr => {
            const ok = globalMatch(tr) && filtersMatch(tr);
            tr.style.display = ok ? "" : "none";
        });

        // Update filter buttons "active" state
        document.querySelectorAll(".filter-btn").forEach(btn => {
            const f = btn.getAttribute("data-filter-field");
            const set = activeFilters[f];
            btn.classList.toggle("active", !!(set && set.size));
        });
    }

    // =========================
    // Excel-like Filters (dependent)
    // =========================
    function installHeaderFilters(){
        // Wrap header labels + add filter button (except actions)
        document.querySelectorAll("#unitsHeaderRow th").forEach((th, idx) => {
            const field = th.dataset.field;
            if(!field || field === "_actions") return;

            // Already installed?
            if(th.querySelector(".filter-btn")) return;

            const originalText = th.textContent.trim();
            th.textContent = "";

            const wrap = document.createElement("div");
            wrap.className = "th-wrap";

            const label = document.createElement("span");
            label.textContent = originalText;

            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "filter-btn";
            btn.setAttribute("data-filter-field", field);
            btn.title = "Filter";
            btn.innerHTML = `<i class="fa-solid fa-filter" style="font-size:11px;"></i>`;

            wrap.appendChild(label);
            wrap.appendChild(btn);
            th.appendChild(wrap);

            btn.addEventListener("click", (e) => {
                e.stopPropagation();
                openFilterPopup(btn, field, originalText);
            });
        });
    }

    function collectVisibleDataset(){
        // dataset from current page rows (regardless of display state)
        const rows = Array.from(document.querySelectorAll("#rowsTbody tr"));
        return rows.map(tr => {
            const obj = {};
            HEADER_FIELDS.forEach(f => {
                if(!f || f === "_actions") return;
                obj[f] = rowValue(tr, f);
            });
            obj.__tr = tr;
            return obj;
        });
    }

    function datasetAfterApplyingFilters(excludingField=null){
        const data = collectVisibleDataset();
        return data.filter(r => {
            // global search
            if(currentGlobalQuery){
                const dev = (r.developer_name || "").toLowerCase();
                const proj = (r.project_name || "").toLowerCase();
                const q = currentGlobalQuery;
                if(!(dev.includes(q) || proj.includes(q))) return false;
            }

            // active filters (except the currently opened column)
            for(const f in activeFilters){
                if(f === excludingField) continue;
                const set = activeFilters[f];
                if(!set || set.size === 0) continue;
                if(!set.has(r[f] || "")) return false;
            }
            return true;
        });
    }

    function openFilterPopup(btn, field, titleText){
        filterTargetField = field;
        filterAnchorBtn = btn;

        // build allowed values list based on other filters (dependent)
        const filteredData = datasetAfterApplyingFilters(field);

        // count values
        const counts = new Map();
        filteredData.forEach(r => {
            const v = (r[field] || "");
            counts.set(v, (counts.get(v) || 0) + 1);
        });

        // sort values: blanks last, then alpha
        const values = Array.from(counts.keys()).sort((a,b) => {
            if(a === "" && b !== "") return 1;
            if(b === "" && a !== "") return -1;
            return a.localeCompare(b);
        });

        // title
        filterTitle.textContent = `Filter: ${titleText}`;

        // render list
        const currentSet = activeFilters[field] || new Set();
        filterList.innerHTML = "";
        values.forEach(v => {
            const row = document.createElement("div");
            row.className = "filter-item";

            const lab = document.createElement("label");
            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.value = v;
            cb.checked = currentSet.has(v);

            const txt = document.createElement("span");
            txt.className = "val";
            txt.textContent = v === "" ? "(Blanks)" : v;

            lab.appendChild(cb);
            lab.appendChild(txt);

            const cnt = document.createElement("span");
            cnt.className = "count";
            cnt.textContent = counts.get(v);

            row.appendChild(lab);
            row.appendChild(cnt);

            filterList.appendChild(row);
        });

        // reset search
        filterSearch.value = "";
        filterSearch.oninput = () => {
            const q = (filterSearch.value || "").trim().toLowerCase();
            filterList.querySelectorAll(".filter-item").forEach(it => {
                const v = it.querySelector(".val")?.textContent?.toLowerCase() || "";
                it.style.display = v.includes(q) ? "" : "none";
            });
        };

        // position popup near button
        const r = btn.getBoundingClientRect();
        const popW = 320;
        const left = Math.min(window.innerWidth - popW - 10, Math.max(10, r.left));
        const top = Math.min(window.innerHeight - 460, r.bottom + 6);
        filterPop.style.left = left + "px";
        filterPop.style.top = top + "px";

        filterPop.classList.add("show");
        filterPop.setAttribute("aria-hidden", "false");

        // focus search
        setTimeout(() => filterSearch.focus(), 30);
    }

    function closeFilterPopup(){
        filterPop.classList.remove("show");
        filterPop.setAttribute("aria-hidden", "true");
        filterTargetField = null;
        filterAnchorBtn = null;
        filterSearch.value = "";
        filterList.innerHTML = "";
    }

    // filter popup controls
    document.getElementById("filterCloseBtn").addEventListener("click", closeFilterPopup);
    document.getElementById("filterCancel").addEventListener("click", closeFilterPopup);

    document.getElementById("filterSelectAll").addEventListener("click", () => {
        filterList.querySelectorAll("input[type='checkbox']").forEach(cb => cb.checked = true);
    });

    document.getElementById("filterClear").addEventListener("click", () => {
        filterList.querySelectorAll("input[type='checkbox']").forEach(cb => cb.checked = false);
    });

    document.getElementById("filterApply").addEventListener("click", () => {
        if(!filterTargetField) return;

        const selected = new Set();
        filterList.querySelectorAll("input[type='checkbox']").forEach(cb => {
            if(cb.checked) selected.add(cb.value);
        });

        if(selected.size === 0){
            delete activeFilters[filterTargetField];
        }else{
            activeFilters[filterTargetField] = selected;
        }

        closeFilterPopup();
        applyAllFiltering();
    });

    // close filter popup on outside click / ESC
    document.addEventListener("click", (e) => {
        if(!filterPop.classList.contains("show")) return;
        if(e.target.closest("#filterPop")) return;
        if(e.target.closest(".filter-btn")) return;
        closeFilterPopup();
    });
    document.addEventListener("keydown", (e) => {
        if(e.key === "Escape" && filterPop.classList.contains("show")){
            closeFilterPopup();
        }
    });

    // =========================
    // Modal helpers (Create)
    // =========================
    const backdrop = document.getElementById("createModalBackdrop");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const cancelModalBtn = document.getElementById("cancelModalBtn");
    const addUnitBtn = document.getElementById("addUnitBtn");
    const submitCreateBtn = document.getElementById("submitCreateBtn");

    function openModal(){
        backdrop.classList.add("show");
        backdrop.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";

        // Default date_of_update = today (your requirement)
        const dateEl = document.getElementById("modalDateOfUpdate");
        if(dateEl) dateEl.value = todayISO();

        setTimeout(() => document.getElementById("modalProjectSelect").focus(), 50);
    }
    function closeModal(){
        backdrop.classList.remove("show");
        backdrop.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
        document.getElementById("createUnitForm").reset();
        document.getElementById("modalDeveloper").value = "";
        document.getElementById("modalLocation").value = "";
    }

    addUnitBtn.addEventListener("click", openModal);
    closeModalBtn.addEventListener("click", closeModal);
    cancelModalBtn.addEventListener("click", closeModal);

    // close on ESC
    document.addEventListener("keydown", (e) => {
        if(e.key === "Escape" && backdrop.classList.contains("show")){
            closeModal();
        }
    });

    // close on outside click
    backdrop.addEventListener("click", (e) => {
        if(e.target === backdrop) closeModal();
    });

    // project -> auto developer/location in modal
    document.getElementById("modalProjectSelect").addEventListener("change", (e) => {
        const opt = e.target.selectedOptions[0];
        document.getElementById("modalDeveloper").value = opt?.getAttribute("data-dev") || "";
        document.getElementById("modalLocation").value = opt?.getAttribute("data-loc") || "";
    });

    // submit create
    submitCreateBtn.addEventListener("click", async () => {
        const form = document.getElementById("createUnitForm");
        const fd = new FormData(form);

        // Ensure date_of_update is always today if empty
        if(!fd.get("date_of_update")){
            fd.set("date_of_update", todayISO());
        }

        const payload = Object.fromEntries(fd.entries());

        if(!payload.project_name || !payload.unit_type){
            Swal.fire("Missing fields", "Project and Unit Type are required.", "warning");
            return;
        }

        try{
            const res = await fetch(CREATE_URL, {
                method:"POST",
                headers:{
                    "Content-Type":"application/json",
                    "X-CSRFToken": getCSRFToken()
                },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            if(!data.success){
                Swal.fire("Error", data.error || "Create failed", "error");
                return;
            }

            closeModal();
            await fetchPage(1);

            // after reload ensure months are computed + sorted
            refreshMonthsFromUpdateOnPage();
            sortRowsByDateDesc();
            applyAllFiltering();

            Swal.fire({ toast:true, position:"bottom", timer:1600, showConfirmButton:false, icon:"success", title:"Unit added" });

        }catch(e){
            Swal.fire("Error", e.message, "error");
        }
    });

    // =========================
    // Import CSV with spinner
    // =========================
    document.getElementById("importBtn").addEventListener("click", async () => {
        const f = document.getElementById("csvFile").files[0];
        if(!f){
            Swal.fire("Missing file", "Please choose a CSV file.", "warning");
            return;
        }

        const fd = new FormData();
        fd.append("csv_file", f);

        Swal.fire({
            title: "Importing...",
            text: "Please wait",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        try{
            const res = await fetch(IMPORT_URL, {
                method:"POST",
                body: fd,
                headers: { "X-CSRFToken": getCSRFToken() }
            });
            const data = await res.json();

            if(!data.success){
                Swal.fire("Import failed", data.error || "Unknown error", "error");
                return;
            }

            Swal.fire("Import done", `Created: ${data.created} | Updated: ${data.updated} | Skipped: ${data.skipped}`, "success");
            await fetchPage(1);

        }catch(e){
            Swal.fire("Import failed", e.message, "error");
        }
    });

    // =========================
    // Clear All (advanced confirm)
    // =========================
    document.getElementById("clearAllBtn").addEventListener("click", async () => {
        const { value: text } = await Swal.fire({
            title: "Danger: Delete ALL units",
            html: `
                <div style="text-align:left; font-size:13px; color:#6b7280;">
                    This will permanently delete <b>all MarketUnitData rows</b>.<br>
                    To confirm, type exactly:<br>
                    <code style="display:inline-block; margin-top:8px; padding:6px 10px; border-radius:10px; background:#f3f4f6;">Accept Delete All</code>
                </div>
            `,
            input: "text",
            inputPlaceholder: "Type confirmation text here...",
            showCancelButton: true,
            confirmButtonText: "Delete All",
            confirmButtonColor: "#ef4444",
            preConfirm: (v) => {
                if((v || "").trim() !== "Accept Delete All"){
                    Swal.showValidationMessage('You must type exactly: "Accept Delete All"');
                    return false;
                }
                return v.trim();
            }
        });

        if(!text) return;

        Swal.fire({ title:"Deleting...", allowOutsideClick:false, didOpen: () => Swal.showLoading() });

        try{
            const res = await fetch(CLEAR_ALL_URL, {
                method:"POST",
                headers:{
                    "Content-Type":"application/json",
                    "X-CSRFToken": getCSRFToken()
                },
                body: JSON.stringify({ confirm_text: text })
            });
            const data = await res.json();

            if(!data.success){
                Swal.fire("Failed", data.error || "Clear all failed", "error");
                return;
            }

            // reset filters + search after delete all
            for(const k in activeFilters) delete activeFilters[k];
            currentGlobalQuery = "";
            searchInputEl.value = "";

            Swal.fire("Deleted", `All units deleted. Count: ${data.deleted}`, "success");
            await fetchPage(1);
        }catch(e){
            Swal.fire("Error", e.message, "error");
        }
    });

    // =========================
    // Inline updates (AJAX)
    // =========================
    function bindRowEvents(){
        document.querySelectorAll("[data-field='project_name']").forEach(sel => {
            sel.addEventListener("change", async () => await updateField(sel));
        });

        document.querySelectorAll("select[data-field]").forEach(sel => {
            if(sel.getAttribute("data-field") === "project_name") return;
            sel.addEventListener("change", async () => await updateField(sel));
        });

        document.querySelectorAll("input[data-field], textarea[data-field]").forEach(inp => {
            inp.addEventListener("blur", async () => await updateField(inp));
        });

        document.querySelectorAll("[data-delete]").forEach(btn => {
            btn.addEventListener("click", () => confirmDelete(btn));
        });
    }

    async function updateField(el){
        const tr = el.closest("tr");
        const id = tr.getAttribute("data-id");
        const field = el.getAttribute("data-field");
        const value = el.value;

        try{
            const res = await fetch(UPDATE_URL, {
                method:"POST",
                headers:{
                    "Content-Type":"application/json",
                    "X-CSRFToken": getCSRFToken()
                },
                body: JSON.stringify({ id, field, value })
            });

            const data = await res.json();
            if(!data.success){
                Swal.fire("Error", data.error || "Update failed", "error");
                return;
            }

            // After any update, frontend enforces:
            // - date_of_update should reflect today (if backend does that)
            // - months computed from date_of_update (not static)
            // (We set these immediately, so no refresh needed)
            const dateInp = tr.querySelector("[data-field='date_of_update']");
            if(dateInp && field !== "date_of_update"){
                // if backend updates date_of_update automatically, reflect it now
                dateInp.value = todayISO();
            }

            // If backend returned computed updates, apply them (developer/location/psm/payment/updated_by)
            if(data.computed){
                const c = data.computed;
                const dev = tr.querySelector("[data-field='developer_name']");
                const loc = tr.querySelector("[data-field='location']");
                const psm = tr.querySelector("[data-field='psm']");
                const pay = tr.querySelector("[data-field='payment_yrs']");
                const updatedBy = tr.querySelector("[data-field='updated_by']");

                if(dev) dev.value = c.developer_name || dev.value || "";
                if(loc) loc.value = c.location || loc.value || "";
                if(psm) psm.value = (c.psm === "" ? "" : Number(c.psm).toFixed(2));
                if(pay) pay.value = c.payment_yrs || pay.value || "";
                if(updatedBy) updatedBy.value = c.updated_by || updatedBy.value || "";
            }

            // Group payment updates
            if(data.group_updates && data.group_updates.length){
                data.group_updates.forEach(u => {
                    const row = document.querySelector(`tr[data-id='${u.id}']`);
                    if(row){
                        const payment = row.querySelector("[data-field='payment_yrs']");
                        if(payment) payment.value = u.payment_yrs || "";
                    }
                });
            }

            // Always recompute months from update on this page (not static)
            refreshMonthsFromUpdateOnPage();

            // Resort the page view
            sortRowsByDateDesc();

            // Reapply filters (dependent) and global search
            applyAllFiltering();

        }catch(e){
            Swal.fire("Error", e.message, "error");
        }
    }

    // =========================
    // Delete with SweetAlert
    // =========================
    async function confirmDelete(btn){
        const tr = btn.closest("tr");
        const id = tr.getAttribute("data-id");

        const ok = await Swal.fire({
            title: "Delete this unit?",
            text: "This action cannot be undone.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, delete",
            cancelButtonText: "Cancel",
        });

        if(!ok.isConfirmed) return;

        try{
            const res = await fetch(DELETE_URL, {
                method:"POST",
                headers:{
                    "Content-Type":"application/json",
                    "X-CSRFToken": getCSRFToken()
                },
                body: JSON.stringify({ id })
            });
            const data = await res.json();
            if(!data.success){
                Swal.fire("Error", data.error || "Delete failed", "error");
                return;
            }
            tr.remove();

            refreshMonthsFromUpdateOnPage();
            sortRowsByDateDesc();
            applyAllFiltering();

            Swal.fire({ toast:true, position:"bottom", timer:1500, showConfirmButton:false, icon:"success", title:"Deleted" });
        }catch(e){
            Swal.fire("Error", e.message, "error");
        }
    }

    // =========================
    // Initial boot
    // =========================
    function boot(){
        // months always recalculated on load
        refreshMonthsFromUpdateOnPage();

        // sort current page view by date desc
        sortRowsByDateDesc();

        // install filters + bind
        installHeaderFilters();

        bindRowEvents();
        bindPaginationEvents();

        // apply any existing filters/search
        applyAllFiltering();
    }

    boot();
</script>

{% endblock %}
