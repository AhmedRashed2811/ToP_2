{% extends 'ToP/base.html' %}
{% load static %}
{% load static custom_filters %}

{% block title %}Market Research Master Data{% endblock %}

{% block content %}

<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>

<style>

    .container {
        margin-top: 0;
        padding: 0;
    }
    @media (min-width: 1400px) {
        .container, .container-lg, .container-md, .container-sm, .container-xl, .container-xxl {
            max-width: 100%;
        }
    }

    @media (min-width: 576px) {
        .container, .container-sm {
            max-width: 100%;
        }
    }
    
    table{
        margin-top: 0;
    }

    table.mr-table {
        min-width: 0;
    }


  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --border: rgba(17,24,39,.10);
    --shadow: 0 14px 40px rgba(17,24,39,.08);
    --shadow-sm: 0 8px 22px rgba(17,24,39,.06);

    --primary:#2563eb;
    --primary-2:#1d4ed8;
    --danger:#ef4444;
    --success:#16a34a;

    --radius: 16px;
  }

  .mr-page{
    padding: 24px;
    margin-top: 80px;
  }

  .mr-header{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap: 16px;
    margin-bottom: 18px;
  }

  .mr-title h1{
    margin:0;
    font-size: 22px;
    color: var(--text);
    letter-spacing: .2px;
  }
  .mr-title p{
    margin: 6px 0 0;
    color: var(--muted);
    font-size: 13px;
  }

  .mr-shell{
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px;
  }

  /* Tabs */
  .mr-tabs{
    display:flex;
    flex-wrap:wrap;
    gap: 8px;
    margin-bottom: 12px;
  }
  .mr-tab{
    border:1px solid var(--border);
    background: #fff;
    color: var(--text);
    padding: 10px 12px;
    border-radius: 999px;
    cursor:pointer;
    font-weight: 600;
    font-size: 13px;
    transition: .15s ease;
    user-select:none;
  }
  .mr-tab:hover{ box-shadow: var(--shadow-sm); }
  .mr-tab.active{
    background: var(--primary);
    border-color: rgba(37,99,235,.25);
    color:#fff;
  }

  /* Layout */
  .mr-grid{
    display:grid;
    grid-template-columns: 1fr;
    gap: 14px;
  }

  .mr-card{
    background: var(--card);
    border:1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
    overflow:hidden;
  }

  .mr-card-h{
    padding: 14px 14px 10px;
    border-bottom: 1px solid var(--border);
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap: 10px;
  }

  .mr-card-h .left h2{
    margin:0;
    font-size: 15px;
    color: var(--text);
  }
  .mr-card-h .left p{
    margin: 4px 0 0;
    font-size: 12px;
    color: var(--muted);
  }

  .mr-card-b{
    padding: 14px;
  }

  .mr-row{
    display:grid;
    grid-template-columns: 1fr;
    gap: 10px;
  }

  .mr-form{
    display:flex;
    flex-wrap:wrap;
    gap: 10px;
    align-items:flex-end;
    margin-bottom: 12px;
  }

  .mr-field{
    display:flex;
    flex-direction:column;
    gap: 6px;
    min-width: 220px;
    flex: 1;
  }
  .mr-field label{
    font-size: 12px;
    color: var(--muted);
    font-weight: 700;
  }

  .mr-input, .mr-select, .mr-file{
    border:1px solid var(--border);
    border-radius: 12px;
    padding: 10px 12px;
    font-size: 14px;
    outline:none;
    transition: .15s ease;
    background:#fff;
    color: var(--text);
  }
  .mr-input:focus, .mr-select:focus{
    border-color: rgba(37,99,235,.55);
    box-shadow: 0 0 0 4px rgba(37,99,235,.12);
  }

  /* Arabic-friendly input direction */
  .mr-input[dir="auto"]{ unicode-bidi: plaintext; }

  .mr-actions{
    display:flex;
    gap: 10px;
    align-items:center;
    flex-wrap:wrap;
  }

  .btn{
    border:none;
    border-radius: 12px;
    padding: 10px 12px;
    font-weight: 800;
    cursor:pointer;
    transition: .15s ease;
    font-size: 13px;
    display:inline-flex;
    gap: 8px;
    align-items:center;
  }
  .btn-primary{ background: var(--primary); color:#fff; }
  .btn-primary:hover{ background: var(--primary-2); }
  .btn-ghost{
    background:#fff;
    color: var(--text);
    border:1px solid var(--border);
  }
  .btn-ghost:hover{ box-shadow: var(--shadow-sm); }
  .btn-danger{
    background: var(--danger);
    color:#fff;
  }
  .btn-danger:hover{ filter: brightness(.95); }

  .mr-tools{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
    margin-bottom: 10px;
  }

  .mr-search{
    flex: 1;
    min-width: 220px;
  }

  .mr-table-wrap{
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow:auto;
  }
  table.mr-table{
    width:100%;
    border-collapse: collapse;
    min-width: 100%;
    background:#fff;
  }
  .mr-table th, .mr-table td{
    padding: 10px 12px;
    border-bottom: 1px solid rgba(17,24,39,.08);
    text-align:left;
    vertical-align: top;
    font-size: 13px;
    color: var(--text);
    word-break: break-word;
  }
  .mr-table th{
    font-size: 12px;
    color: var(--muted);
    background: #fbfbfd;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  .mr-table tr:hover td{ background: #fafafa; }

  .pill{
    display:inline-flex;
    align-items:center;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 12px;
    border: 1px solid var(--border);
    color: var(--muted);
    background:#fff;
  }

  /* Map Modal */
  .map-modal{
    display:none;
    position:fixed;
    inset:0;
    background: rgba(0,0,0,.55);
    z-index: 9999;
    padding: 18px;
  }
  .map-modal .box{
    max-width: 1100px;
    margin: 0 auto;
    height: calc(100vh - 36px);
    background:#fff;
    border-radius: 18px;
    border:1px solid var(--border);
    box-shadow: 0 30px 80px rgba(0,0,0,.25);
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }
  .map-modal .head{
    padding: 12px 14px;
    border-bottom: 1px solid var(--border);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap: 10px;
  }
  .map-modal .head h3{ margin:0; font-size: 15px; }
  .map-modal .close{
    background: transparent;
    border: none;
    font-size: 28px;
    line-height: 1;
    cursor:pointer;
    color: var(--muted);
  }
  .map-modal .close:hover{ color: var(--danger); }
  #map{
    flex:1;
  }
  .map-modal .foot{
    padding: 12px 14px;
    border-top: 1px solid var(--border);
    display:flex;
    justify-content:flex-end;
    gap: 10px;
  }

  /* Toast */
  #toast{
    visibility:hidden;
    min-width: 260px;
    max-width: 90vw;
    text-align:center;
    border-radius: 14px;
    padding: 10px 14px;
    position: fixed;
    z-index: 10000;
    left: 50%;
    bottom: 26px;
    transform: translateX(-50%);
    color:#fff;
    background: var(--success);
    box-shadow: 0 14px 40px rgba(0,0,0,.20);
    font-weight: 700;
    font-size: 13px;
  }
  #toast.show{
    visibility: visible;
    animation: fadein .25s, fadeout .25s 2.6s;
  }
  @keyframes fadein { from { opacity:0; transform: translateX(-50%) translateY(10px);} to { opacity:1; transform: translateX(-50%) translateY(0);} }
  @keyframes fadeout{ from { opacity:1; } to { opacity:0; } }

  /* Responsive */
  @media (min-width: 992px){
    .mr-grid{ grid-template-columns: 1fr; }
    .mr-form .mr-field{ min-width: 260px; }
  }
</style>

<div class="mr-page">
  <div class="mr-header">
    <div class="mr-title">
      <h1>Market Research â€“ Master Data</h1>
    </div>
  </div>

  <div class="mr-shell">
    <!-- Tabs -->
    <div class="mr-tabs" role="tablist" aria-label="Master data tabs">
      <button class="mr-tab active" data-tab="tab-location" type="button">Locations</button>
      <button class="mr-tab" data-tab="tab-developer" type="button">Developers</button>
      <button class="mr-tab" data-tab="tab-project" type="button">Projects</button>
      <button class="mr-tab" data-tab="tab-unit-type" type="button">Unit Types</button>
      <button class="mr-tab" data-tab="tab-finish" type="button">Finishing Specs</button>
      <button class="mr-tab" data-tab="tab-asset" type="button">Asset Types</button>
    </div>

    <div class="mr-grid">
      <!-- Hidden CSRF provider (so JS can read token even if cookie isn't available) -->
      <form id="csrfProvider" style="display:none">{% csrf_token %}</form>

      <!-- ===================== Locations ===================== -->
      <section id="tab-location" class="mr-card mr-tab-panel">
        <div class="mr-card-h">
          <div class="left">
            <h2>Locations</h2>
          </div>
        </div>

        <div class="mr-card-b">
          <div class="mr-form">
            <div class="mr-field">
              <label>Location name</label>
              <input class="mr-input" dir="auto" type="text" placeholder="Enter Location Name..." data-model="location" data-role="add-input">
            </div>
            <div class="mr-actions">
              <button class="btn btn-primary" type="button" onclick="saveSimpleRow(this)">+ Add</button>
            </div>
          </div>

          <div class="mr-tools">
            <input class="mr-input mr-search" type="text" placeholder="Search..." oninput="filterTable('location-table', this.value)">
          </div>

          <div class="mr-table-wrap">
            <table class="mr-table" id="location-table">
              <thead>
                <tr><th style="width:88%">Location</th><th style="width:12%">Action</th></tr>
              </thead>
              <tbody>
                {% for location in locations %}
                <tr data-id="{{ location.id }}" data-model="location">
                  <td>{{ location.name }}</td>
                  <td>
                    <button class="btn btn-danger" type="button" onclick="deleteRow(this)">Delete</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div style="margin-top:12px;">
            <details>
              <summary class="pill" style="cursor:pointer;">Import CSV</summary>
              <div style="padding-top:10px;">
                <form class="csv-import-form mr-form" data-model="location" enctype="multipart/form-data">
                  {% csrf_token %}
                  <div class="mr-field" style="min-width:280px">
                    <label>CSV file (UTF-8 / cp1256)</label>
                    <input class="mr-file" type="file" name="csv_file" accept=".csv" required>
                  </div>
                  <div class="mr-actions">
                    <button class="btn btn-ghost" type="submit">Import</button>
                  </div>
                </form>
              </div>
            </details>
          </div>
        </div>
      </section>

      <!-- ===================== Developers ===================== -->
      <section id="tab-developer" class="mr-card mr-tab-panel" style="display:none;">
        <div class="mr-card-h">
          <div class="left">
            <h2>Developers</h2>
          </div>
        </div>

        <div class="mr-card-b">
          <div class="mr-form">
            <div class="mr-field">
              <label>Developer name</label>
              <input class="mr-input" dir="auto" type="text" placeholder="Enter Developer Name..." data-model="developer" data-role="add-input">
            </div>
            <div class="mr-actions">
              <button class="btn btn-primary" type="button" onclick="saveSimpleRow(this)">+ Add</button>
            </div>
          </div>

          <div class="mr-tools">
            <input class="mr-input mr-search" type="text" placeholder="Search..." oninput="filterTable('developer-table', this.value)">
          </div>

          <div class="mr-table-wrap">
            <table class="mr-table" id="developer-table">
              <thead>
                <tr><th style="width:88%">Developer</th><th style="width:12%">Action</th></tr>
              </thead>
              <tbody>
                {% for developer in developers %}
                <tr data-id="{{ developer.id }}" data-model="developer">
                  <td>{{ developer.name }}</td>
                  <td>
                    <button class="btn btn-danger" type="button" onclick="deleteRow(this)">Delete</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div style="margin-top:12px;">
            <details>
              <summary class="pill" style="cursor:pointer;">Import CSV</summary>
              <div style="padding-top:10px;">
                <form class="csv-import-form mr-form" data-model="developer" enctype="multipart/form-data">
                  {% csrf_token %}
                  <div class="mr-field" style="min-width:280px">
                    <label>CSV file</label>
                    <input class="mr-file" type="file" name="csv_file" accept=".csv" required>
                  </div>
                  <div class="mr-actions">
                    <button class="btn btn-ghost" type="submit">Import</button>
                  </div>
                </form>
              </div>
            </details>
          </div>
        </div>
      </section>

      <!-- ===================== Projects ===================== -->
      <section id="tab-project" class="mr-card mr-tab-panel" style="display:none;">
        <div class="mr-card-h">
          <div class="left">
            <h2>Projects</h2>
          </div>
        </div>

        <div class="mr-card-b">
          <div class="mr-form">
            <div class="mr-field">
              <label>Project name</label>
              <input class="mr-input" dir="auto" type="text" id="project-name" placeholder="Enter Project Name">
            </div>

            <div class="mr-field">
              <label>Developer</label>
              <select class="mr-select" id="developer-select">
                <option value="">Select Developer</option>
                {% for developer in developers %}
                  <option value="{{ developer.id }}">{{ developer.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mr-field">
              <label>Location</label>
              <select class="mr-select" id="location-select">
                <option value="">Select Location</option>
                {% for location in locations %}
                  <option value="{{ location.id }}">{{ location.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mr-actions">
              <button class="btn btn-primary" type="button" onclick="saveProject()">+ Add Project</button>
            </div>
          </div>

          <div style="margin-bottom:12px;">
            <details open>
              <summary class="pill" style="cursor:pointer;">Import Projects CSV</summary>
              <div style="padding-top:10px;">
                <form class="csv-import-form mr-form" data-model="project" enctype="multipart/form-data">
                  {% csrf_token %}
                  <div class="mr-field" style="min-width:280px">
                    <label>CSV file</label>
                    <input class="mr-file" type="file" name="csv_file" accept=".csv" required>
                  </div>
                  <div class="mr-actions">
                    <button class="btn btn-ghost" type="submit">Import</button>
                  </div>
                </form>
              </div>
            </details>
          </div>

          <div class="mr-tools">
            <input class="mr-input mr-search" type="text" placeholder="Search..." oninput="filterTable('project-table', this.value)">
          </div>

          <div class="mr-table-wrap">
            <table class="mr-table" id="project-table">
              <thead>
                <tr>
                  <th>Project</th>
                  <th>Developer</th>
                  <th>Location</th>
                  <th style="width:220px;">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for project in projects %}
                <tr data-id="{{ project.id }}" data-model="project"
                    data-lat="{% if project.latitude %}{{ project.latitude }}{% else %}{% endif %}"
                    data-lng="{% if project.longitude %}{{ project.longitude }}{% else %}{% endif %}">
                  <td>{{ project.name }}</td>
                  <td>{{ project.developer.name }}</td>
                  <td>{{ project.location.name }}</td>
                  <td style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn btn-ghost" type="button"
                            onclick="openMapFromRow(this)">Map</button>
                    <button class="btn btn-danger" type="button"
                            onclick="deleteRow(this)">Delete</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ===================== Unit Types ===================== -->
      <section id="tab-unit-type" class="mr-card mr-tab-panel" style="display:none;">
        <div class="mr-card-h">
          <div class="left">
            <h2>Unit Types</h2>
          </div>
        </div>

        <div class="mr-card-b">
          <div class="mr-form">
            <div class="mr-field">
              <label>Unit type</label>
              <input class="mr-input" dir="auto" type="text" placeholder="Enter Unit Type..." data-model="unit_type" data-role="add-input">
            </div>
            <div class="mr-actions">
              <button class="btn btn-primary" type="button" onclick="saveSimpleRow(this)">+ Add</button>
            </div>
          </div>

          <div class="mr-tools">
            <input class="mr-input mr-search" type="text" placeholder="Search..." oninput="filterTable('unit-type-table', this.value)">
          </div>

          <div class="mr-table-wrap">
            <table class="mr-table" id="unit-type-table">
              <thead>
                <tr><th style="width:88%">Type</th><th style="width:12%">Action</th></tr>
              </thead>
              <tbody>
                {% for type in unit_types %}
                <tr data-id="{{ type.id }}" data-model="unit_type">
                  <td>{{ type.name }}</td>
                  <td>
                    <button class="btn btn-danger" type="button" onclick="deleteRow(this)">Delete</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div style="margin-top:12px;">
            <details>
              <summary class="pill" style="cursor:pointer;">Import CSV</summary>
              <div style="padding-top:10px;">
                <form class="csv-import-form mr-form" data-model="unit_type" enctype="multipart/form-data">
                  {% csrf_token %}
                  <div class="mr-field" style="min-width:280px">
                    <label>CSV file</label>
                    <input class="mr-file" type="file" name="csv_file" accept=".csv" required>
                  </div>
                  <div class="mr-actions">
                    <button class="btn btn-ghost" type="submit">Import</button>
                  </div>
                </form>
              </div>
            </details>
          </div>
        </div>
      </section>

      <!-- ===================== Finishing Specs ===================== -->
      <section id="tab-finish" class="mr-card mr-tab-panel" style="display:none;">
        <div class="mr-card-h">
          <div class="left">
            <h2>Finishing Specs</h2>
          </div>
        </div>

        <div class="mr-card-b">
          <div class="mr-form">
            <div class="mr-field">
              <label>Finishing spec</label>
              <input class="mr-input" dir="auto" type="text" placeholder="Enter Finishing Specs..." data-model="finishing_spec" data-role="add-input">
            </div>
            <div class="mr-actions">
              <button class="btn btn-primary" type="button" onclick="saveSimpleRow(this)">+ Add</button>
            </div>
          </div>

          <div class="mr-tools">
            <input class="mr-input mr-search" type="text" placeholder="Search..." oninput="filterTable('finish-table', this.value)">
          </div>

          <div class="mr-table-wrap">
            <table class="mr-table" id="finish-table">
              <thead>
                <tr><th style="width:88%">Spec</th><th style="width:12%">Action</th></tr>
              </thead>
              <tbody>
                {% for finishing_spec in finishing_specs %}
                <tr data-id="{{ finishing_spec.id }}" data-model="finishing_spec">
                  <td>{{ finishing_spec.name }}</td>
                  <td>
                    <button class="btn btn-danger" type="button" onclick="deleteRow(this)">Delete</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div style="margin-top:12px;">
            <details>
              <summary class="pill" style="cursor:pointer;">Import CSV</summary>
              <div style="padding-top:10px;">
                <form class="csv-import-form mr-form" data-model="finishing_spec" enctype="multipart/form-data">
                  {% csrf_token %}
                  <div class="mr-field" style="min-width:280px">
                    <label>CSV file</label>
                    <input class="mr-file" type="file" name="csv_file" accept=".csv" required>
                  </div>
                  <div class="mr-actions">
                    <button class="btn btn-ghost" type="submit">Import</button>
                  </div>
                </form>
              </div>
            </details>
          </div>
        </div>
      </section>

      <!-- ===================== Asset Types ===================== -->
      <section id="tab-asset" class="mr-card mr-tab-panel" style="display:none;">
        <div class="mr-card-h">
          <div class="left">
            <h2>Asset Types</h2>
          </div>
        </div>

        <div class="mr-card-b">
          <div class="mr-form">
            <div class="mr-field">
              <label>Asset type</label>
              <input class="mr-input" dir="auto" type="text" placeholder="Enter Asset Type..." data-model="asset_type" data-role="add-input">
            </div>
            <div class="mr-actions">
              <button class="btn btn-primary" type="button" onclick="saveSimpleRow(this)">+ Add</button>
            </div>
          </div>

          <div class="mr-tools">
            <input class="mr-input mr-search" type="text" placeholder="Search..." oninput="filterTable('asset-table', this.value)">
          </div>

          <div class="mr-table-wrap">
            <table class="mr-table" id="asset-table">
              <thead>
                <tr><th style="width:88%">Asset</th><th style="width:12%">Action</th></tr>
              </thead>
              <tbody>
                {% for asset_type in asset_types %}
                <tr data-id="{{ asset_type.id }}" data-model="asset_type">
                  <td>{{ asset_type.name }}</td>
                  <td>
                    <button class="btn btn-danger" type="button" onclick="deleteRow(this)">Delete</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div style="margin-top:12px;">
            <details>
              <summary class="pill" style="cursor:pointer;">Import CSV</summary>
              <div style="padding-top:10px;">
                <form class="csv-import-form mr-form" data-model="asset_type" enctype="multipart/form-data">
                  {% csrf_token %}
                  <div class="mr-field" style="min-width:280px">
                    <label>CSV file</label>
                    <input class="mr-file" type="file" name="csv_file" accept=".csv" required>
                  </div>
                  <div class="mr-actions">
                    <button class="btn btn-ghost" type="submit">Import</button>
                  </div>
                </form>
              </div>
            </details>
          </div>
        </div>
      </section>

    </div>
  </div>
</div>

<!-- Map Modal -->
<div id="mapModal" class="map-modal" aria-hidden="true">
  <div class="box">
    <div class="head">
      <h3>Select Project Location</h3>
      <button class="close" type="button" aria-label="Close">&times;</button>
    </div>
    <div id="map"></div>
    <div class="foot">
      <button class="btn btn-ghost" type="button" id="cancelLocationBtn">Cancel</button>
      <button class="btn btn-primary" type="button" id="saveLocationBtn">Save Location</button>
    </div>
  </div>
</div>

<div id="toast">OK</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
  // ===========================
  // Tabs
  // ===========================
  document.querySelectorAll('.mr-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.mr-tab').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const target = btn.getAttribute('data-tab');
      document.querySelectorAll('.mr-tab-panel').forEach(p => p.style.display = 'none');
      document.getElementById(target).style.display = 'block';
    });
  });

  // ===========================
  // Helpers
  // ===========================
  function getCSRFToken() {
    // Prefer hidden token from csrfProvider
    const el = document.querySelector('#csrfProvider [name=csrfmiddlewaretoken]');
    if (el && el.value) return el.value;

    // fallback cookie
    return document.cookie.split('; ')
      .find(row => row.startsWith('csrftoken='))?.split('=')[1];
  }

  function showToast(message, isError=false) {
    const toast = document.getElementById("toast");
    toast.innerText = message;
    toast.style.backgroundColor = isError ? "var(--danger)" : "var(--success)";
    toast.className = "show";
    setTimeout(() => { toast.className = toast.className.replace("show",""); }, 3000);
  }

  function filterTable(tableId, q) {
    const query = (q || "").toLowerCase();
    const tbody = document.querySelector(`#${tableId} tbody`);
    if (!tbody) return;
    [...tbody.querySelectorAll("tr")].forEach(tr => {
      const text = tr.innerText.toLowerCase();
      tr.style.display = text.includes(query) ? "" : "none";
    });
  }

  function safeTrim(s){ return (s || "").toString().trim(); }

  // ===========================
  // CSV Import
  // ===========================
  document.querySelectorAll('.csv-import-form').forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();

      const model = this.getAttribute('data-model');
      const formData = new FormData(this);
      formData.append("model", model);

      fetch("{% url 'import_csv_for_model' %}", {
        method: 'POST',
        body: formData,
        headers: { 'X-CSRFToken': getCSRFToken() }
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          showToast(`Imported ${data.count} ${model}(s)`);
          setTimeout(() => location.reload(), 650);
        } else {
          showToast(`Import failed: ${data.error || "Unknown error"}`, true);
        }
      })
      .catch(err => showToast(`Import failed: ${err.message}`, true));
    });
  });

  // ===========================
  // Create (Simple Models) - No reload (append row)
  // ===========================
  async function saveSimpleRow(button) {
    const card = button.closest('.mr-card');
    const input = card.querySelector('[data-role="add-input"]');
    const model = input.getAttribute('data-model');
    const value = safeTrim(input.value);

    if (!value) {
      showToast("Please enter a value", true);
      return;
    }

    try {
      const res = await fetch("{% url 'save_market_research_entry' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ model, value })
      });

      const data = await res.json();
      if (!res.ok || data.error) {
        showToast(data.error || "Save failed", true);
        return;
      }

      input.value = "";
      showToast("Saved");

      // append to correct table + update selects if needed
      appendRowForModel(model, data);

    } catch (err) {
      showToast("Save failed: " + err.message, true);
    }
  }

  function appendRowForModel(model, data) {
    const map = {
      "location": "location-table",
      "developer": "developer-table",
      "unit_type": "unit-type-table",
      "finishing_spec": "finish-table",
      "asset_type": "asset-table"
    };
    const tableId = map[model];
    if (!tableId) return;

    const tbody = document.querySelector(`#${tableId} tbody`);
    if (!tbody) return;

    // Prevent duplicate append if already exists
    if (tbody.querySelector(`tr[data-id="${data.id}"]`)) return;

    const tr = document.createElement("tr");
    tr.setAttribute("data-id", data.id);
    tr.setAttribute("data-model", model);
    tr.innerHTML = `
      <td>${escapeHtml(data.name || "")}</td>
      <td><button class="btn btn-danger" type="button" onclick="deleteRow(this)">Delete</button></td>
    `;
    tbody.prepend(tr);

    // If location/dev added, update project selects too
    if (model === "developer") {
      addOptionToSelect("developer-select", data.id, data.name);
    }
    if (model === "location") {
      addOptionToSelect("location-select", data.id, data.name);
    }
  }

  function addOptionToSelect(selectId, value, label) {
    const sel = document.getElementById(selectId);
    if (!sel) return;
    if ([...sel.options].some(o => o.value == String(value))) return;
    const opt = document.createElement("option");
    opt.value = value;
    opt.textContent = label;
    sel.appendChild(opt);
  }

  // ===========================
  // Create Project - append row + keep map/delete
  // ===========================
  async function saveProject() {
    const name = safeTrim(document.getElementById("project-name").value);
    const developer_id = document.getElementById("developer-select").value;
    const location_id = document.getElementById("location-select").value;

    if (!name) return showToast("Please enter a project name", true);
    if (!developer_id) return showToast("Please select a developer", true);
    if (!location_id) return showToast("Please select a location", true);

    try {
      const res = await fetch("{% url 'save_market_research_entry' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({
          model: "project",
          value: { name, developer_id, location_id }
        })
      });

      const data = await res.json();
      if (!res.ok || data.error) {
        showToast(data.error || "Save failed", true);
        return;
      }

      document.getElementById("project-name").value = "";
      showToast("Project saved");
      appendProjectRow(data);

    } catch (err) {
      showToast("Error saving project: " + err.message, true);
    }
  }

  function appendProjectRow(data) {
    const tbody = document.querySelector("#project-table tbody");
    if (!tbody) return;

    const tr = document.createElement("tr");
    tr.setAttribute("data-id", data.id);
    tr.setAttribute("data-model", "project");
    tr.setAttribute("data-lat", "");
    tr.setAttribute("data-lng", "");
    tr.innerHTML = `
      <td>${escapeHtml(data.name || "")}</td>
      <td>${escapeHtml(data.developer || "")}</td>
      <td>${escapeHtml(data.location || "")}</td>
      <td style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn btn-ghost" type="button" onclick="openMapFromRow(this)">Map</button>
        <button class="btn btn-danger" type="button" onclick="deleteRow(this)">Delete</button>
      </td>
    `;
    tbody.prepend(tr);
  }

  // ===========================
  // Delete (all models)
  // ===========================
  function deleteRow(button) {
    const row = button.closest('tr');
    const model = row.getAttribute('data-model');
    const id = row.getAttribute('data-id');

    if (!confirm("Are you sure you want to delete this item?")) return;

    fetch("{% url 'delete_market_research_entry' %}", {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRFToken()
      },
      body: JSON.stringify({ model, id })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        row.remove();
        showToast("Deleted");
      } else {
        showToast(data.error || "Delete failed", true);
      }
    })
    .catch(() => showToast("Delete failed", true));
  }

  // ===========================
  // Map Modal (Projects)
  // ===========================
  let currentProjectId = null;
  let map = null;
  let marker = null;

  const mapModal = document.getElementById("mapModal");
  const closeBtn = document.querySelector(".map-modal .close");
  const cancelBtn = document.getElementById("cancelLocationBtn");
  const saveBtn = document.getElementById("saveLocationBtn");

  closeBtn.onclick = closeMapModal;
  cancelBtn.onclick = closeMapModal;

  mapModal.addEventListener("click", (e) => {
    if (e.target === mapModal) closeMapModal();
  });

  function openMapFromRow(btn){
    const row = btn.closest('tr');
    const projectId = row.getAttribute("data-id");
    const lat = parseFloat(row.getAttribute("data-lat")) || null;
    const lng = parseFloat(row.getAttribute("data-lng")) || null;
    openMapModal(projectId, lat, lng);
  }

  function openMapModal(projectId, lat, lng) {
    currentProjectId = projectId;
    mapModal.style.display = "block";
    mapModal.setAttribute("aria-hidden", "false");

    setTimeout(() => initMap(lat, lng), 60);
  }

  function closeMapModal(){
    mapModal.style.display = "none";
    mapModal.setAttribute("aria-hidden", "true");
    if (map) {
      map.remove();
      map = null;
      marker = null;
    }
  }

  function initMap(lat, lng) {
    const defaultLat = 30.0444; // Cairo
    const defaultLng = 31.2357;

    const initialLat = (lat !== null && !Number.isNaN(lat)) ? lat : defaultLat;
    const initialLng = (lng !== null && !Number.isNaN(lng)) ? lng : defaultLng;

    map = L.map('map').setView([initialLat, initialLng], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    if (lat !== null && lng !== null) {
      marker = L.marker([lat, lng], { draggable: true }).addTo(map);
    }

    map.on('click', function(e) {
      if (!marker) {
        marker = L.marker(e.latlng, { draggable: true }).addTo(map);
      } else {
        marker.setLatLng(e.latlng);
      }
    });

    saveBtn.onclick = function() {
      if (!marker) return showToast("Please select a location on the map first", true);
      const pos = marker.getLatLng();
      saveProjectLocation(currentProjectId, pos.lat, pos.lng);
    };
  }

  function saveProjectLocation(projectId, lat, lng) {
    fetch("{% url 'save_project_location' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRFToken()
      },
      body: JSON.stringify({ project_id: projectId, latitude: lat, longitude: lng })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        // Update row dataset values (no reload)
        const row = document.querySelector(`tr[data-model="project"][data-id="${projectId}"]`);
        if (row) {
          row.setAttribute("data-lat", lat);
          row.setAttribute("data-lng", lng);
        }
        showToast("Location saved");
        closeMapModal();
      } else {
        showToast("Error saving location: " + (data.error || "Unknown error"), true);
      }
    })
    .catch(err => showToast("Error saving location: " + err.message, true));
  }

  function escapeHtml(str){
    return (str || "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
</script>

{% endblock %}
