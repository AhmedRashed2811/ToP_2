{% extends 'ToP/base.html' %}
{% load static %}
{% load static custom_filters %}

{% block title %}Market Research Model{% endblock %}

{% block content %}
{% comment %} <h2 class="page-title">Master Data</h2> {% endcomment %}

<!-- Add Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>

<style>
    :root {
        --primary-color: #4285F4;
        --primary-hover: #3367d6;
        --secondary-color: #f8f9fa;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --border-color: #dee2e6;
        --text-color: #212529;
        --light-gray: #f1f3f5;
        --medium-gray: #adb5bd;
        --dark-gray: #6c757d;
        --white: #ffffff;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --border-radius: 8px;
        --spacing-xs: 0.25rem;
        --spacing-sm: 0.5rem;
        --spacing-md: 1rem;
        --spacing-lg: 1.5rem;
        --spacing-xl: 2rem;
    }

    .container {
        margin-top: 80px;
        padding: 20px;
        margin-left: 0;
    }

    .page-title {
        margin-bottom: var(--spacing-xl);
        font-size: 1.75rem;
        font-weight: 600;
        color: var(--text-color);
        text-align: center;
        padding-bottom: var(--spacing-md);
        border-bottom: 2px solid var(--primary-color);
    }

    .form-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 var(--spacing-md);
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .input-group {
        display: flex;
        flex-direction: column;
        background: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: var(--spacing-lg);
        transition: box-shadow 0.3s ease;
    }

    .input-group:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .input-group > label {
        font-weight: 600;
        margin-bottom: var(--spacing-sm);
        color: var(--text-color);
        font-size: 1.1rem;
    }

    .input-group input,
    .input-group select {
        padding: var(--spacing-sm) var(--spacing-md);
        font-size: 1rem;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        margin-bottom: var(--spacing-sm);
        transition: border-color 0.3s ease;
    }

    .input-group input:focus,
    .input-group select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.25);
    }

    .input-group button {
        padding: var(--spacing-sm) var(--spacing-md);
        background-color: var(--primary-color);
        color: var(--white);
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-weight: 500;
        font-size: 0.95rem;
        transition: background-color 0.3s ease;
        align-self: flex-start;
        width: fit-content;
    }

    .input-group button:hover {
        background-color: var(--primary-hover);
    }

    .project-inputs {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-sm);
    }

    .project-inputs input,
    .project-inputs select {
        margin-bottom: 0;
    }

    .data-table-wrapper {
        margin-top: var(--spacing-md);
        overflow-x: auto;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: var(--spacing-sm);
    }

    .data-table th,
    .data-table td {
        padding: var(--spacing-sm) var(--spacing-md);
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        white-space: normal; /* Allow text to wrap */
        word-break: break-word; /* Break long words if necessary */
        vertical-align: top; /* Align content to top for multi-line text */
    }

    .data-table th {
        background-color: var(--secondary-color);
        font-weight: 600;
        color: var(--dark-gray);
        white-space: nowrap; /* Keep headers on one line */
    }

    .data-table tr:hover {
        background-color: var(--light-gray);
    }

    .delete-cell {
        width: 1%;
        text-align: center;
        white-space: nowrap;
    }

    .delete-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        background-color: var(--danger-color);
        color: var(--white);
        border-radius: 50%;
        border: none;
        cursor: pointer;
        font-weight: bold;
        font-size: 1.2rem;
        transition: background-color 0.3s ease;
    }

    .delete-btn:hover {
        background-color: #c82333;
    }

    .map-btn {
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: var(--border-radius);
        padding: var(--spacing-xs) var(--spacing-sm);
        cursor: pointer;
        font-size: 0.85rem;
        transition: background-color 0.3s ease;
    }

    .map-btn:hover {
        background-color: var(--primary-hover);
    }

    .import-section {
        margin-top: var(--spacing-md);
        padding-top: var(--spacing-md);
        border-top: 1px solid var(--border-color);
    }

    .csv-import-form {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
    }

    .csv-import-form input[type="file"] {
        padding: var(--spacing-xs);
    }

    .csv-import-form button {
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: 0.9rem;
        align-self: flex-start;
    }

    /* Map Modal Styles */
    .map-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
    }

    .map-modal-content {
        background-color: var(--white);
        margin: 5% auto;
        padding: var(--spacing-lg);
        border-radius: var(--border-radius);
        width: 90%;
        max-width: 1000px;
        height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .map-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
    }

    .close-btn {
        font-size: 2rem;
        font-weight: bold;
        color: var(--dark-gray);
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
    }

    .close-btn:hover {
        color: var(--danger-color);
    }

    .map-container {
        flex: 1;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        overflow: hidden;
    }

    .map-actions {
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-md);
    }

    .map-actions button {
        padding: var(--spacing-sm) var(--spacing-md);
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-weight: 500;
    }

    #saveLocationBtn {
        background-color: var(--success-color);
        color: var(--white);
    }

    #saveLocationBtn:hover {
        background-color: #218838;
    }

    #cancelLocationBtn {
        background-color: var(--medium-gray);
        color: var(--white);
    }

    #cancelLocationBtn:hover {
        background-color: #5a6268;
    }

    /* Toast Notification */
    #toast {
        visibility: hidden;
        min-width: 250px;
        background-color: var(--success-color);
        color: var(--white);
        text-align: center;
        border-radius: var(--border-radius);
        padding: var(--spacing-sm) var(--spacing-md);
        position: fixed;
        z-index: 9999;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 1rem;
    }

    #toast.show {
        visibility: visible;
        animation: fadein 0.5s, fadeout 0.5s 2.5s;
    }

    @keyframes fadein {
        from {bottom: 0; opacity: 0;}
        to {bottom: 30px; opacity: 1;}
    }

    @keyframes fadeout {
        from {bottom: 30px; opacity: 1;}
        to {bottom: 0; opacity: 0;}
    }

    /* Responsive Adjustments */
    @media (min-width: 768px) {
        .project-inputs {
            flex-direction: row;
        }
    }

    @media (min-width: 1200px) {
        .form-row {
            grid-template-columns: repeat(6, 1fr);
        }
    }

    @media (max-width: 1199px) {
        .form-row {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 767px) {
        .form-row {
            grid-template-columns: 1fr;
        }

        .page-title {
            font-size: 1.5rem;
        }

        .map-modal-content {
            width: 95%;
            height: 90vh;
            margin: 2.5% auto;
        }
    }
</style>

<div class="form-container">
    <div class="form-row">
        <!-- Location -->
        <div class="input-group">
            <label>Location</label>
            <input type="text" placeholder="Enter location..." data-model="location">
            <button onclick="saveRow(this)">+ Add</button>
            <div class="data-table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Location</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for location in locations %}
                            <tr data-id="{{ location.id }}" data-model="location">
                                <td>{{ location.name }}</td>
                                <td class="delete-cell">
                                    <button class="delete-btn" onclick="deleteRow(this)">×</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Developer -->
        <div class="input-group">
            <label>Developer</label>
            <input type="text" placeholder="Enter developer..." data-model="developer">
            <button onclick="saveRow(this)">+ Add</button>
            <div class="data-table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Developer</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for developer in developers %}
                            <tr data-id="{{ developer.id }}" data-model="developer">
                                <td>{{ developer.name }}</td>
                                <td class="delete-cell">
                                    <button class="delete-btn" onclick="deleteRow(this)">×</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Project -->
        <div class="input-group">
            <label>Project</label>
            <div class="project-inputs">
                <input type="text" id="project-name" placeholder="Project Name">
                <select id="developer-select">
                    <option value="">Select Developer</option>
                    {% for developer in developers %}
                        <option value="{{ developer.id }}">{{ developer.name }}</option>
                    {% endfor %}
                </select>
                <select id="location-select">
                    <option value="">Select Location</option>
                    {% for location in locations %}
                        <option value="{{ location.id }}">{{ location.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button onclick="saveProject()">+ Add Project</button>

            <div class="import-section">
                <form class="csv-import-form" data-model="project" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="file" name="csv_file" accept=".csv" required>
                    <button type="submit">Import CSV</button>
                </form>
            </div>

            <div class="data-table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Project</th>
                            <th>Developer</th>
                            <th>Location</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for project in projects %}
                            <tr data-id="{{ project.id }}" data-model="project">
                                <td>{{ project.name }}</td>
                                <td>{{ project.developer.name }}</td>
                                <td>{{ project.location.name }}</td>
                                <td>
                                    <button class="map-btn" 
                                            onclick="openMapModal('{{ project.id }}', 
                                            {% if project.latitude %}{{ project.latitude }}{% else %}null{% endif %}, 
                                            {% if project.longitude %}{{ project.longitude }}{% else %}null{% endif %})">
                                        Map
                                    </button>
                                    <button class="delete-btn" onclick="deleteRow(this)">×</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Unit Type -->
        <div class="input-group">
            <label>Unit Type</label>
            <input type="text" placeholder="Enter unit type..." data-model="unit_type">
            <button onclick="saveRow(this)">+ Add</button>
            <div class="data-table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for type in unit_types %}
                            <tr data-id="{{ type.id }}" data-model="type">
                                <td>{{ type.name }}</td>
                                <td class="delete-cell">
                                    <button class="delete-btn" onclick="deleteRow(this)">×</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Finishing Specs -->
        <div class="input-group">
            <label>Finishing Specs</label>
            <input type="text" placeholder="Enter specs..." data-model="finishing_spec">
            <button onclick="saveRow(this)">+ Add</button>
            <div class="data-table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Specs</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for finishing_spec in finishing_specs %}
                            <tr data-id="{{ finishing_spec.id }}" data-model="finishing_spec">
                                <td>{{ finishing_spec.name }}</td>
                                <td class="delete-cell">
                                    <button class="delete-btn" onclick="deleteRow(this)">×</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Asset Type -->
        <div class="input-group">
            <label>Asset Type</label>
            <input type="text" placeholder="Enter asset type..." data-model="asset_type">
            <button onclick="saveRow(this)">+ Add</button>
            <div class="data-table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Asset</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for asset_type in asset_types %}
                            <tr data-id="{{ asset_type.id }}" data-model="asset_type">
                                <td>{{ asset_type.name }}</td>
                                <td class="delete-cell">
                                    <button class="delete-btn" onclick="deleteRow(this)">×</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Map Modal -->
<div id="mapModal" class="map-modal">
    <div class="map-modal-content">
        <div class="map-header">
            <h3>Select Project Location</h3>
            <button class="close-btn">&times;</button>
        </div>
        <div id="map" class="map-container"></div>
        <div class="map-actions">
            <button id="cancelLocationBtn">Cancel</button>
            <button id="saveLocationBtn">Save Location</button>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast">Operation successful!</div>

<!-- Add Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
    // Map functionality
    let currentProjectId = null;
    let map;
    let marker;

    // Initialize the map modal
    const mapModal = document.getElementById("mapModal");
    const closeBtn = document.querySelector(".close-btn");
    const cancelBtn = document.getElementById("cancelLocationBtn");

    closeBtn.onclick = function() {
        mapModal.style.display = "none";
        if (map) {
            map.remove();
            map = null;
        }
    };

    cancelBtn.onclick = function() {
        mapModal.style.display = "none";
        if (map) {
            map.remove();
            map = null;
        }
    };

    window.onclick = function(event) {
        if (event.target === mapModal) {
            mapModal.style.display = "none";
            if (map) {
                map.remove();
                map = null;
            }
        }
    };

    function openMapModal(projectId, lat, lng) {
        currentProjectId = projectId;
        mapModal.style.display = "block";

        // Initialize the map after the modal is displayed
        setTimeout(() => {
            initMap(lat, lng);
        }, 50);
    }

    function initMap(lat, lng) {
        // Default to a central location if no coordinates provided
        const defaultLat = 30.0444;
        const defaultLng = 31.2357;

        const initialLat = lat || defaultLat;
        const initialLng = lng || defaultLng;

        // Initialize the map
        map = L.map('map').setView([initialLat, initialLng], 12);

        // Base tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Create or update the marker if coordinates exist
        if (lat && lng) {
            marker = L.marker([lat, lng], {draggable: true}).addTo(map);
        }

        // Add click listener to the map
        map.on('click', function(e) {
            const clickedLatLng = e.latlng;

            if (!marker) {
                marker = L.marker(clickedLatLng, {draggable: true}).addTo(map);
            } else {
                marker.setLatLng(clickedLatLng);
            }
        });

        // Save button handler
        document.getElementById("saveLocationBtn").onclick = function() {
            if (marker) {
                const position = marker.getLatLng();
                saveProjectLocation(currentProjectId, position.lat, position.lng);
            } else {
                showToast("Please select a location on the map first", true);
            }
        };
    }

    function saveProjectLocation(projectId, lat, lng) {
        fetch("{% url 'save_project_location' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken()
            },
            body: JSON.stringify({
                project_id: projectId,
                latitude: lat,
                longitude: lng
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast("Location saved successfully");
                mapModal.style.display = "none";
                if (map) {
                    map.remove();
                    map = null;
                }
            } else {
                showToast("Error saving location: " + (data.error || "Unknown error"), true);
            }
        })
        .catch(error => {
            showToast("Error saving location: " + error.message, true);
        });
    }

    // Existing functionality
    document.querySelectorAll('.csv-import-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const model = this.getAttribute('data-model');
            let formData = new FormData(this);

            formData.append("model", model);
            if (!model) {
                showToast("❌ Import failed: Model not recognized", true);
                return;
            }

            fetch("{% url 'import_csv_for_model' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`✅ Successfully imported ${data.count} ${model}(s)`);
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(`❌ Import failed: ${data.error || "Unknown error"}`, true);
                }
            })
            .catch(error => {
                showToast(`❌ Import failed: ${error.message}`, true);
            });
        });
    });

    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
               document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    }

    function showToast(message, isError = false) {
        const toast = document.getElementById("toast");
        toast.innerText = message;
        toast.style.backgroundColor = isError ? "var(--danger-color)" : "var(--success-color)";
        toast.className = "show";
        setTimeout(() => {
            toast.className = toast.className.replace("show", "");
        }, 3000);
    }

    async function saveRow(button) {
        const input = button.previousElementSibling;
        const model = input.getAttribute('data-model');
        const value = input.value.trim();
        if (!value) return;

        try {
            const response = await fetch("{% url 'save_market_research_entry' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()
                },
                body: JSON.stringify({ model, value })
            });

            if (response.ok) {
                input.value = "";
                window.location.reload();
            }
        } catch (error) {
            console.error("Error:", error);
            showToast("Error saving data", true);
        }
    }

    async function saveProject() {
        const name = document.getElementById("project-name").value.trim();
        const developer_id = document.getElementById("developer-select").value;
        const location_id = document.getElementById("location-select").value;

        if (!name) {
            showToast("Please enter a project name", true);
            return;
        }

        if (!developer_id) {
            showToast("Please select a developer", true);
            return;
        }

        if (!location_id) {
            showToast("Please select a location", true);
            return;
        }

        try {
            const response = await fetch("{% url 'save_market_research_entry' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()
                },
                body: JSON.stringify({
                    model: "project",
                    value: { name, developer_id, location_id }
                })
            });

            if (response.ok) {
                document.getElementById("project-name").value = "";
                window.location.reload();
            }
        } catch (error) {
            console.error("Error:", error);
            showToast("Error saving project", true);
        }
    }

    function deleteRow(button) {
        const row = button.closest('tr');
        const model = row.getAttribute('data-model');
        const id = row.getAttribute('data-id');

        if (!confirm("Are you sure you want to delete this item?")) {
            return;
        }

        fetch("{% url 'delete_market_research_entry' %}", {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken()
            },
            body: JSON.stringify({ model, id })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                row.remove();
                showToast("Deleted successfully");
            } else {
                showToast(data.error || "Delete failed", true);
            }
        })
        .catch(() => {
            showToast("Delete failed", true);
        });
    }
</script>
{% endblock %}
