{% extends 'ToP/base.html' %}
{% load static %}

{% block title %}Units Catalog{% endblock %}

{% block content %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    /* --- USER REQUESTED PRESERVED STYLES --- */
    .container { top:0px; }
    .table { margin-top: 0px; }

    .select2-container--bootstrap-5 .select2-dropdown .select2-results__options .select2-results__option {
        padding: .375rem 1.75rem;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
    }

    @media (max-width: 1200px) {
        .container-new-new { margin-top: 0%; }
    }

    .container-new-new { padding: 3px; margin-top: 0%; }

    @media (min-width: 768px) {
        .container, .container-md, .container-sm { max-width: 100%; }
    }

    @media (min-width: 576px) {
        .container, .container-sm { max-width: 100%; }
    }

    /* UPDATED: Increased width to 200px as requested */
    table td:first-child { font-weight: bold; background: #f2f2f2; min-width: 200px; }

    /* --- LAYOUT & SCROLL FIXES --- */
    body { 
        background-color: #f3f4f6; 
        font-family: 'Times New Roman', serif; 
        color: #111827; 
         /* Hide body scrollbar to use internal container scroll */
    }

    /* Flex Container to force Pagination to bottom */
    .container-new-new {
        /* Adjust height to fit your screen minus navbar (approx 100px) */
        height: calc(100vh - 100px); 
        display: flex;
        flex-direction: column;
        padding: 10px 20px;
    }

    /* Filter Bar */
    .filter-section {
        background: #ffffff; 
        border-bottom: 1px solid #e5e7eb; 
        padding: 15px 20px; 
        flex-shrink: 0; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        z-index: 20; 
    }
    .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .btn-reset { color: #6b7280; font-size: 1.1rem; border: none; background: none; cursor: pointer; }
    .btn-reset:hover { color: #dc2626; }

    /* Table Wrapper - Grows to fill space, handles scrolling */
    .table-container-new-new {
        background: white; 
        border: 1px solid #e5e7eb; 
        border-radius: 8px 8px 0 0; /* Rounded top only */
        margin-top: 15px; 
        width: 100%; 
        position: relative;
        flex: 1; /* Takes all remaining vertical space */
        overflow: auto; /* Enables Scroll */
    }

    .modern-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 0; }

    /* Sticky Headers */
    .modern-table thead th {
        background-color: #f8f9fa; color: #374151; font-weight: 600; font-size: 0.75rem;
        text-transform: uppercase; letter-spacing: 0.05em; padding: 12px;
        border-bottom: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb;
        white-space: nowrap; text-align: center;
        position: sticky; top: 0; z-index: 100;
        box-shadow: 0 1px 0 #e5e7eb;
    }

    /* Sticky First Column */
    .modern-table tbody td:first-child {
        position: sticky; left: 0; background-color: #f9fafb; z-index: 90;
        border-right: 2px solid #e5e7eb; text-align: left;
    }
    /* Sticky Corner */
    .modern-table thead th:first-child {
        position: sticky; left: 0; top: 0; z-index: 110; background-color: #f8f9fa;
        border-right: 2px solid #e5e7eb;
    }

    .modern-table td { 
        padding: 10px 12px; vertical-align: middle; font-size: 0.9rem; 
        color: #374151; white-space: nowrap; text-align: center; border-bottom: 1px solid #f3f4f6;
    }

    /* Custom Dropdown (Fixed Position) */
    .header-filter-btn {
        background: transparent; border: none; color: #9ca3af; margin-left: 6px; cursor: pointer;
    }
    .header-filter-btn:hover, .header-filter-btn.active { color: #2563eb; }

    .custom-dropdown-menu {
        display: none; 
        position: fixed; /* Pops out of scroll container */
        background: white; border: 1px solid #e5e7eb;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        border-radius: 8px; padding: 15px; width: 280px; z-index: 9999;
        text-align: center;
    }

    /* Pagination - Fixed at bottom of flex container */
    .pagination-wrapper { 
        padding: 10px 15px; 
        background: #fff; 
        border: 1px solid #e5e7eb;
        border-top: none;
        border-radius: 0 0 8px 8px; /* Rounded bottom only */
        flex-shrink: 0; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
    }
    .page-item.active .page-link { background-color: #2563eb; border-color: #2563eb; }
    .page-link { color: #2563eb; cursor: pointer; }
    
    /* Components */
    .unit-code { font-weight: 700; color: #2563eb; background: #eff6ff; padding: 4px 8px; border-radius: 4px; }
    .price-text { font-weight: 700; color: #059669; }
    .btn-action { background-color: #2563eb; color: white; border-radius: 4px; padding: 4px 12px; font-size: 0.85rem; border: none; }
    .btn-action:hover { background-color: #1d4ed8; }
    /* --- MODAL STYLES --- */
    .layout-modal {
        display: none; 
        position: fixed; 
        z-index: 9999; 
        left: 0; top: 0; 
        width: 100%; height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.8); 
        animation: fadeIn 0.3s;
    }
    .layout-modal-content {
        position: relative;
        background-color: #fefefe;
        margin: 5% auto;
        padding: 0;
        border: 1px solid #888;
        width: 90%;
        max-width: 800px;
        border-radius: 8px;
        box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
    }
    .close-modal {
        color: white;
        position: absolute;
        top: -30px;
        right: 0;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        z-index: 10001;
    }
    .close-modal:hover { color: #ccc; }

    /* --- REQUESTED CAROUSEL STYLES --- */
    @keyframes tonext {
      75% { left: 0; }
      95% { left: 100%; }
      98% { left: 100%; }
      99% { left: 0; }
    }
    @keyframes tostart {
      75% { left: 0; }
      95% { left: -300%; }
      98% { left: -300%; }
      99% { left: 0; }
    }
    @keyframes snap {
      96% { scroll-snap-align: center; }
      97% { scroll-snap-align: none; }
      99% { scroll-snap-align: none; }
      100% { scroll-snap-align: center; }
    }
    
    .carousel {
      position: relative;
      padding-top: 75%; /* Aspect Ratio */
      filter: drop-shadow(0 0 10px #0003);
      perspective: 100px;
    }
    .carousel__viewport {
      position: absolute;
      top: 0; right: 0; bottom: 0; left: 0;
      display: flex;
      overflow-x: scroll;
      counter-reset: item;
      scroll-behavior: smooth;
      scroll-snap-type: x mandatory;
      margin: 0; padding: 0; list-style: none;
    }
    .carousel__slide {
      position: relative;
      flex: 0 0 100%;
      width: 100%;
      background-color: #333;
      counter-increment: item;
    }
    .carousel__slide img {
        width: 100%; height: 100%; object-fit: contain;
    }
    .carousel__snapper {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      scroll-snap-align: center;
    }
    /* Navigation Arrows */
    .carousel::before, .carousel::after, .carousel__prev, .carousel__next {
      position: absolute;
      top: 0; margin-top: 37.5%;
      width: 4rem; height: 4rem;
      transform: translateY(-50%);
      border-radius: 50%; font-size: 0; outline: 0; cursor: pointer;
    }
    .carousel::before, .carousel__prev { left: 1rem; }
    .carousel::after, .carousel__next { right: 1rem; }
    .carousel::before, .carousel::after {
      content: ''; z-index: 1;
      background-color: #333;
      background-size: 1.5rem 1.5rem;
      background-repeat: no-repeat;
      background-position: center center;
      color: #fff; font-size: 2.5rem; line-height: 4rem; text-align: center; pointer-events: none;
    }
    .carousel::before { background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpolygon points='0,50 80,100 80,0' fill='%23fff'/%3E%3C/svg%3E"); }
    .carousel::after { background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpolygon points='100,50 20,100 20,0' fill='%23fff'/%3E%3C/svg%3E"); }

</style>

<div class="filter-section">
    <div class="header-row">
        <h4 class="m-0 fw-bold text-dark"><i class="fa-solid fa-building-user me-2 text-primary"></i>Units Inventory</h4>
        <div class="d-flex align-items-center gap-3">
            
            <button id="btn-show-map-filter" class="btn btn-sm btn-outline-primary d-none" onclick="redirectToMasterplanWithFilter()">
                <i class="fa-solid fa-map-location-dot"></i> Show on Map
            </button>

            <span class="result-count">Found <strong id="count-display">0</strong> units</span>
            <button class="btn-reset" onclick="resetAllFilters()">
                <i class="fa-solid fa-filter-circle-xmark"></i> Clear Filters
            </button>
        </div>
    </div>
    
    <div class="row g-2" id="company-filter-row">
        <div class="col-lg-3 col-md-6 col-12">
            <select id="filter-company" class="form-select select2">
                {% if is_unbound_user %}
                    <option value="">Select Company...</option>
                    {% for comp in all_companies %}
                        <option value="{{ comp.id }}" {% if selected_company_id|stringformat:"i" == comp.id|stringformat:"i" %}selected{% endif %}>
                            {{ comp.name }}
                        </option>
                    {% endfor %}
                {% endif %}
            </select>
        </div>
    </div>
</div>

<div class="container-new-new">
    <div class="table-container-new-new">
        <table class="table modern-table" id="units-table">
            <thead>
                <tr>
                    <th id="th-code">
                        Unit Code
                        <button class="header-filter-btn" id="btn-unit_code" onclick="toggleFilter(event, 'unit_code')"><i class="fa-solid fa-filter"></i></button>
                        <div class="custom-dropdown-menu" id="dropdown-unit_code">
                            <label class="form-label small fw-bold">Select Unit(s)</label>
                            <select id="input-unit_code" class="form-select col-select2" multiple="multiple" style="width: 100%"></select>
                        </div>
                    </th>
                    
                    <th id="th-project">
                        Project
                        <button class="header-filter-btn" id="btn-project" onclick="toggleFilter(event, 'project')"><i class="fa-solid fa-filter"></i></button>
                        <div class="custom-dropdown-menu" id="dropdown-project">
                            <label class="form-label small fw-bold">Select Project(s)</label>
                            <select id="input-project" class="form-select col-select2" multiple="multiple" style="width: 100%"></select>
                        </div>
                    </th>

                    {% for group in request.user.groups.all %}
                        {% if group.name in 'Admin' or group.name in 'Manager' or group.name in 'Developer' or group.name in 'TeamMember'  or group.name in 'Viewer'  %}
                            <th id="th-status"> Status
                                <button class="header-filter-btn" id="btn-status" onclick="toggleFilter(event, 'status')"><i class="fa-solid fa-filter"></i></button>
                                <div class="custom-dropdown-menu" id="dropdown-status">
                                    <label class="form-label small fw-bold">Select Status</label>
                                    <select id="input-status" class="form-select col-select2" multiple="multiple" style="width: 100%"></select>
                                </div>
                            </th>

                            <th id="th-phasing"> Phasing
                                <button class="header-filter-btn" id="btn-phasing" onclick="toggleFilter(event, 'phasing')"><i class="fa-solid fa-filter"></i></button>
                                <div class="custom-dropdown-menu" id="dropdown-phasing">
                                    <label class="form-label small fw-bold">Select Phasing</label>
                                    <select id="input-phasing" class="form-select col-select2" multiple="multiple" style="width: 100%"></select>
                                </div>
                            </th>
                        {% endif %}
                    {% endfor %}


                    <th id="th-bedrooms">
                        Bedrooms
                        <button class="header-filter-btn" id="btn-bedrooms" onclick="toggleFilter(event, 'bedrooms')"><i class="fa-solid fa-filter"></i></button>
                        <div class="custom-dropdown-menu" id="dropdown-bedrooms">
                            <label class="form-label small fw-bold">Select Bedrooms(s)</label>
                            <select id="input-bedrooms" class="form-select col-select2" multiple="multiple" style="width: 100%"></select>
                        </div>
                    </th>

                    

                    
                    <th id="th-building">
                        Building
                        <button class="header-filter-btn" id="btn-building_type" onclick="toggleFilter(event, 'building_type')"><i class="fa-solid fa-filter"></i></button>
                        <div class="custom-dropdown-menu" id="dropdown-building_type">
                            <label class="form-label small fw-bold">Select Building Type(s)</label>
                            <select id="input-building_type" class="form-select col-select2" multiple="multiple" style="width: 100%"></select>
                        </div>
                    </th>


                    <th id="th-type">
                        Type
                        <button class="header-filter-btn" id="btn-unit_type" onclick="toggleFilter(event, 'unit_type')"><i class="fa-solid fa-filter"></i></button>
                        <div class="custom-dropdown-menu" id="dropdown-unit_type">
                            <label class="form-label small fw-bold">Select Type(s)</label>
                            <select id="input-unit_type" class="form-select col-select2" multiple="multiple" style="width: 100%"></select>
                        </div>
                    </th>

                    <th id="th-model">
                        Model
                        <button class="header-filter-btn" id="btn-unit_model" onclick="toggleFilter(event, 'unit_model')"><i class="fa-solid fa-filter"></i></button>
                        <div class="custom-dropdown-menu" id="dropdown-unit_model">
                            <label class="form-label small fw-bold">Select Model(s)</label>
                            <select id="input-unit_model" class="form-select col-select2" multiple="multiple" style="width: 100%"></select>
                        </div>
                    </th>

                    <th id="th-delivery">
                        Delivery
                        <button class="header-filter-btn" id="btn-development_delivery_date" onclick="toggleFilter(event, 'development_delivery_date')"><i class="fa-solid fa-filter"></i></button>
                        <div class="custom-dropdown-menu" id="dropdown-development_delivery_date">
                            <label class="form-label small fw-bold">Select Date(s)</label>
                            <select id="input-development_delivery_date" class="form-select col-select2" multiple="multiple" style="width: 100%"></select>
                        </div>
                    </th>

                    <th id="th-finishing">
                        Finishing
                        <button class="header-filter-btn" id="btn-finishing_specs" onclick="toggleFilter(event, 'finishing_specs')"><i class="fa-solid fa-filter"></i></button>
                        <div class="custom-dropdown-menu" id="dropdown-finishing_specs">
                            <label class="form-label small fw-bold">Select Specs</label>
                            <select id="input-finishing_specs" class="form-select col-select2" multiple="multiple" style="width: 100%"></select>
                        </div>
                    </th>

                    <th id="th-area">
                        Gross Area
                        <button class="header-filter-btn" id="btn-area" onclick="toggleFilter(event, 'area')"><i class="fa-solid fa-filter"></i></button>
                        <div class="custom-dropdown-menu" id="dropdown-area">
                            <label class="form-label small fw-bold mb-2">Area Range (mÂ²)</label>
                            <div class="d-flex gap-2 align-items-center mb-2">
                                <input type="number" id="area-min" class="form-control form-control-sm" placeholder="Min">
                                <span>-</span>
                                <input type="number" id="area-max" class="form-control form-control-sm" placeholder="Max">
                            </div>
                            <button class="btn btn-sm btn-primary w-100" onclick="applyAreaFilter()">Apply</button>
                        </div>
                    </th>

                    <th id="th-garden">
                        Garden
                        <button class="header-filter-btn" id="btn-garden_area" onclick="toggleFilter(event, 'garden_area')"><i class="fa-solid fa-filter"></i></button>
                        <div class="custom-dropdown-menu" id="dropdown-garden_area">
                            <label class="form-label small fw-bold">Select Area</label>
                            <select id="input-garden_area" class="form-select col-select2" multiple="multiple" style="width: 100%"></select>
                        </div>
                    </th>

                    <th id="th-land">
                        Land
                        <button class="header-filter-btn" id="btn-land_area" onclick="toggleFilter(event, 'land_area')"><i class="fa-solid fa-filter"></i></button>
                        <div class="custom-dropdown-menu" id="dropdown-land_area">
                            <label class="form-label small fw-bold">Select Area</label>
                            <select id="input-land_area" class="form-select col-select2" multiple="multiple" style="width: 100%"></select>
                        </div>
                    </th>

                    <th id="th-penthouse">
                        Penthouse
                        <button class="header-filter-btn" id="btn-penthouse_area" onclick="toggleFilter(event, 'penthouse_area')"><i class="fa-solid fa-filter"></i></button>
                        <div class="custom-dropdown-menu" id="dropdown-penthouse_area">
                            <label class="form-label small fw-bold">Select Area</label>
                            <select id="input-penthouse_area" class="form-select col-select2" multiple="multiple" style="width: 100%"></select>
                        </div>
                    </th>

                    <th id="th-roof">
                        Roof
                        <button class="header-filter-btn" id="btn-roof_terraces_area" onclick="toggleFilter(event, 'roof_terraces_area')"><i class="fa-solid fa-filter"></i></button>
                        <div class="custom-dropdown-menu" id="dropdown-roof_terraces_area">
                            <label class="form-label small fw-bold">Select Area</label>
                            <select id="input-roof_terraces_area" class="form-select col-select2" multiple="multiple" style="width: 100%"></select>
                        </div>
                    </th>

                    <th id="th-price">
                        Price (EGP)
                        <button class="header-filter-btn" id="btn-interest_free_unit_price" onclick="toggleFilter(event, 'interest_free_unit_price')"><i class="fa-solid fa-filter"></i></button>
                        <div class="custom-dropdown-menu" id="dropdown-interest_free_unit_price">
                            <label class="form-label small fw-bold">Select Price</label>
                            <select id="input-interest_free_unit_price" class="form-select col-select2" multiple="multiple" style="width: 100%"></select>
                        </div>
                    </th>

                    <th class="text-end" id="th-action">Action</th>
                </tr>
            </thead>
            <tbody id="units-table-body">
                </tbody>
        </table>

        <div id="no-data-msg" class="text-center py-5 d-none">
            <h6 class="text-muted fw-normal">No units match these filters.</h6>
        </div>
    </div>
    <div id="pagination-container" class="pagination-wrapper d-none">
        <div class="text-muted small">
            Showing <span id="page-start-index">0</span> to <span id="page-end-index">0</span> of <span id="page-total-count">0</span>
        </div>
        <nav aria-label="Page navigation">
            <ul class="pagination pagination-sm mb-0" id="pagination-list"></ul>
        </nav>
    </div>

</div>

<div id="layoutModal" class="layout-modal">
    <div class="layout-modal-content">
        <span class="close-modal" onclick="closeLayoutModal()">&times;</span>
        <div id="modalCarouselContainer">
            </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // --- 1. CONFIGURATION ---
    const rawData = {{ units_json|safe }};
    const csrftoken = '{{ csrf_token }}';  
    const urls = { 
        home: "{% url 'home' %}",
        unitMapping: "{% url 'unit_mapping_read_only' %}"
    };
    const isUnboundUser = {{ is_unbound_user|yesno:"true,false" }};
    const hasData = rawData.length > 0;
    const userGroups = [{% for group in request.user.groups.all %}"{{ group.name }}",{% endfor %}];

    let availableUnits = rawData; 
    let currentPage = 1;
    const rowsPerPage = 50;

    // Filter Config: Maps key in JSON to input ID in HTML
    const filterConfig = [
        { key: 'unit_code', id: 'input-unit_code' },
        { key: 'project', id: 'input-project' },
        { key: 'status', id: 'input-status' },
        { key: 'sales_phasing', id: 'input-phasing' },
        { key: 'num_bedrooms', id: 'input-bedrooms' },
        { key: 'building_type', id: 'input-building_type' },
        { key: 'unit_type', id: 'input-unit_type' },
        { key: 'unit_model', id: 'input-unit_model' },
        { key: 'development_delivery_date', id: 'input-development_delivery_date' },
        { key: 'finishing_specs', id: 'input-finishing_specs' },
        { key: 'garden_area', id: 'input-garden_area' },
        { key: 'land_area', id: 'input-land_area' },
        { key: 'penthouse_area', id: 'input-penthouse_area' },
        { key: 'roof_terraces_area', id: 'input-roof_terraces_area' },
        { key: 'interest_free_unit_price', id: 'input-interest_free_unit_price', isPrice: true }
    ];

    let activeFilters = { areaMin: null, areaMax: null };
    filterConfig.forEach(cfg => activeFilters[cfg.key] = []);

    // --- 2. INITIALIZATION ---
    $(document).ready(function() {
        console.log("System Initialized");

        // Role-based visibility
        if (userGroups.includes("Sales") || userGroups.includes("Manager") || userGroups.includes("SalesHead") || userGroups.includes("Viewer")) {
            $('#company-filter-row').remove(); 
        }

        if (userGroups.includes("Sales") || userGroups.includes("SalesHead")) {
            $('#unit-status-header').remove(); 
            const idx = filterConfig.findIndex(c => c.key === 'status');
            if(idx > -1) filterConfig.splice(idx, 1);
        }

        if (isUnboundUser && !hasData) {
            $('#no-data-msg').removeClass('d-none').html("Please select a company to view units.");
        }

        // Init Main Company Filter
        $('#filter-company').select2({ theme: "bootstrap-5", width: '100%', placeholder: "Select Company..." });

        // Init Column Filters (Inside dropdowns)
        $('.col-select2').select2({
            theme: "bootstrap-5",
            placeholder: "Search...",
            allowClear: true,
            width: '100%',
            closeOnSelect: true
        });
        
        $('.col-select2').on('select2:select select2:unselect', function(e) {
            $(this).closest('.custom-dropdown-menu').hide();
        });

        // Area Placeholders
        if(hasData) {
            const areas = rawData.map(u => parseFloat(u.gross_area) || 0);
            if(areas.length > 0) {
                $('#area-min').attr('placeholder', Math.min(...areas).toFixed(0));
                $('#area-max').attr('placeholder', Math.max(...areas).toFixed(0));
            }
        }

        // Setup Options and Events
        updateDropdowns(); 
        
        bindEvents();
        
        // --- NEW: Check for incoming filter from Masterplan ---
        const urlParams = new URLSearchParams(window.location.search);
        const searchCode = urlParams.get('search_code');
        
        if (searchCode) {
            // Apply a direct filter for this unit code
            availableUnits = rawData.filter(u => u.unit_code === searchCode);
            
            // Show toast notification
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'info',
                title: `Filtering for unit: ${searchCode}`,
                showConfirmButton: false,
                timer: 3000
            });
            renderTable(availableUnits);

            // 3. CLEAN URL: Remove the 'search_code' parameter immediately
            // This prevents the filter from re-applying if the user refreshes
            const newUrl = new URL(window.location.href);
            newUrl.searchParams.delete('search_code');
            window.history.replaceState({}, '', newUrl);

        } else {
            renderTable(availableUnits);
        }

        // --- GLOBAL CLOSE HANDLER ---
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.custom-dropdown-menu').length && !$(e.target).closest('.header-filter-btn').length) {
                $('.custom-dropdown-menu').hide();
            }
        });
    });

    // --- 3. CUSTOM TOGGLE FUNCTION ---
    window.toggleFilter = function(e, colName) {
        e.stopPropagation(); 
        const btn = $(e.currentTarget);
        const dropdown = $('#dropdown-' + colName);
        
        $('.custom-dropdown-menu').not(dropdown).hide();

        if (dropdown.is(':visible')) {
            dropdown.hide();
        } else {
            const rect = btn[0].getBoundingClientRect();
            dropdown.css({
                top: rect.bottom + 20,
                left: Math.max(10, rect.left - 200),
                display: 'block'
            });
        }
    };

    // --- 4. LOGIC & BINDING ---
    function populateOptions() {
        filterConfig.forEach(cfg => {
            const $el = $('#' + cfg.id);
            if(!$el.length) return;
            let vals = [...new Set(rawData.map(item => item[cfg.key]))]
                .filter(x => x !== null && x !== undefined && x !== '');
            if(vals.length > 0 && !isNaN(vals[0])) {
                vals.sort((a, b) => parseFloat(a) - parseFloat(b));
            } else {
                vals.sort();
            }
            vals.forEach(v => {
                let txt = v;
                if(cfg.isPrice) txt = parseFloat(v).toLocaleString('en-US');
                $el.append(new Option(txt, v, false, false));
            });
        });
    }

    function bindEvents() {
        $('#filter-company').on('change', function() {
            if (isUnboundUser) {
                const val = $(this).val();
                if (val) {
                    const form = $('<form method="POST" action=""><input type="hidden" name="csrfmiddlewaretoken" value="'+csrftoken+'"><input type="hidden" name="company_id" value="'+val+'"></form>');
                    $('body').append(form);
                    form.submit();
                } else window.location.href = window.location.pathname;
            }
        });

        filterConfig.forEach(cfg => {
            $('#' + cfg.id).on('change', function() {
                activeFilters[cfg.key] = $(this).val() || [];
                const btnId = cfg.id.replace('input-', 'btn-');
                if(activeFilters[cfg.key].length > 0) $('#'+btnId).addClass('active');
                else $('#'+btnId).removeClass('active');
                applyAllFilters();
                updateDropdowns();
            });
        });

        $('#area-min, #area-max').on('keypress', function(e) { if(e.which===13) applyAreaFilter(); });
    }

    window.applyAreaFilter = function() {
        const min = parseFloat($('#area-min').val());
        const max = parseFloat($('#area-max').val());
        activeFilters.areaMin = isNaN(min) ? null : min;
        activeFilters.areaMax = isNaN(max) ? null : max;
        
        if(activeFilters.areaMin !== null || activeFilters.areaMax !== null) $('#btn-area').addClass('active');
        else $('#btn-area').removeClass('active');

        $('.custom-dropdown-menu').hide();
        applyAllFilters();
        updateDropdowns();
    };

    function applyAllFilters() {
        availableUnits = rawData.filter(unit => {
            for (let cfg of filterConfig) {
                const selected = activeFilters[cfg.key];
                if (selected && selected.length > 0) {
                    const unitVal = String(unit[cfg.key]);
                    if (!selected.some(s => String(s) === unitVal)) return false;
                }
            }
            const area = parseFloat(unit.gross_area) || 0;
            if (activeFilters.areaMin !== null && area < activeFilters.areaMin) return false;
            if (activeFilters.areaMax !== null && area > activeFilters.areaMax) return false;
            return true;
        });

        // --- UPDATED BUTTON LOGIC (Checks implicit OR explicit selection) ---
        const mapBtn = document.getElementById('btn-show-map-filter');
        
        // Get Unique Projects from the *filtered result set* (availableUnits)
        const uniqueProjects = [...new Set(availableUnits.map(u => u.project))];

        // If exactly 1 unique project exists in current view (and we have any units), show button
        if (uniqueProjects.length === 1 && availableUnits.length > 0) {
            mapBtn.classList.remove('d-none');
        } else {
            mapBtn.classList.add('d-none');
        }
        // ------------------------

        currentPage = 1;
        renderTable(availableUnits);
    }

    // --- NEW: Redirect Function ---
    window.redirectToMasterplanWithFilter = function() {
        // 1. Get the project name from the *filtered data*
        // (We know there is only 1 unique project because logic in applyAllFilters passed)
        const uniqueProjects = [...new Set(availableUnits.map(u => u.project))];
        const projectName = uniqueProjects[0];
        
        // 2. Find the ID from the rawData
        // We look for a unit that has this project name and get its project_id
        const unitWithProject = rawData.find(u => u.project === projectName);
        
        if (!unitWithProject || !unitWithProject.project_id) {
            alert("Project ID not found for selection.");
            return;
        }
        
        const projectId = unitWithProject.project_id; 

        // 3. Collect all currently filtered unit codes
        const filteredCodes = availableUnits.map(u => u.unit_code).join(',');

        // 4. Construct URL
        const targetUrl = `${urls.unitMapping}?project_id=${projectId}&filtered_codes=${encodeURIComponent(filteredCodes)}`;
        
        window.location.href = targetUrl;
    };

    window.resetAllFilters = function() {
        filterConfig.forEach(cfg => activeFilters[cfg.key] = []);
        activeFilters.areaMin = null;
        activeFilters.areaMax = null;
        $('.col-select2').val(null).trigger('change.select2');
        $('#area-min').val('');
        $('#area-max').val('');
        $('.header-filter-btn').removeClass('active');
        $('.custom-dropdown-menu').hide();
        // Clear URL params if any
        if (window.history.pushState) {
            const newurl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            window.history.pushState({path:newurl},'',newurl);
        }
        applyAllFilters();
    };

    // --- 5. RENDER ---
    function renderTable(data) {
        const tbody = document.getElementById('units-table-body');
        const countSpan = document.getElementById('count-display');
        const noDataMsg = document.getElementById('no-data-msg');
        const pagContainer = document.getElementById('pagination-container');

        const total = data.length;
        countSpan.innerText = total;
        tbody.innerHTML = '';

        if (total === 0) {
            noDataMsg.classList.remove('d-none');
            pagContainer.classList.add('d-none');
            return;
        }
        noDataMsg.classList.add('d-none');
        pagContainer.classList.remove('d-none');

        const totalPages = Math.ceil(total / rowsPerPage);
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;

        const start = (currentPage - 1) * rowsPerPage;
        const end = Math.min(start + rowsPerPage, total);

        document.getElementById('page-start-index').innerText = start + 1;
        document.getElementById('page-end-index').innerText = end;
        document.getElementById('page-total-count').innerText = total;

        const slice = data.slice(start, end);

        // --- DYNAMIC COLUMN VISIBILITY LOGIC ---
        const hasVal = (v) => {
            if (v === null || v === undefined || v === '') return false;
            if (!isNaN(v) && parseFloat(v) === 0) return false; 
            return true;
        };

        const columnMap = {
            'unit_code': 'th-code',
            'project': 'th-project',
            'status': 'th-status',
            'sales_phasing': 'th-phasing',
            'num_bedrooms': 'th-bedrooms',
            'building_type': 'th-building',
            'unit_type': 'th-type',
            'unit_model': 'th-model',
            'development_delivery_date': 'th-delivery',
            'finishing_specs': 'th-finishing',
            'gross_area': 'th-area',
            'garden_area': 'th-garden',
            'land_area': 'th-land',
            'penthouse_area': 'th-penthouse',
            'roof_terraces_area': 'th-roof',
            'interest_free_unit_price': 'th-price'
        };

        const visibleCols = {};
        for (let key in columnMap) visibleCols[key] = false;

        slice.forEach(row => {
            for (let key in columnMap) {
                if (hasVal(row[key])) visibleCols[key] = true;
            }
        });
        visibleCols['unit_code'] = true; 
        visibleCols['project'] = true;

        for (let key in columnMap) {
            const headerId = columnMap[key];
            const $header = $('#' + headerId);
            if ($header.length) {
                if (visibleCols[key]) $header.show(); else $header.hide();
            }
        }

        const fmtMoney = n => n ? parseFloat(n).toLocaleString('en-US') : '0';
        const fmtArea = n => {
            const v = parseFloat(n);
            return (!v || v === 0) ? '<span class="text-muted opacity-25">-</span>' : v.toFixed(2);
        };

        let html = '';
        slice.forEach(u => {
            let tr = '<tr>';

            tr += `<td><span class="unit-code">${u.unit_code}</span></td>
                   <td><span class="unit-code">${u.project}</span></td>`;
            
            if (!(userGroups.includes("Sales") || userGroups.includes("SalesHead"))) {
                tr += `<td><span class="unit-code">${u.status}</span></td>`;
                if (visibleCols['sales_phasing']) tr += `<td>${u.sales_phasing||'-'}</td>`;

            }
            
            if (visibleCols['num_bedrooms']) tr += `<td>${u.num_bedrooms||'-'}</td>`;
            if (visibleCols['building_type']) tr += `<td>${u.building_type||'-'}</td>`;
            if (visibleCols['unit_type']) tr += `<td>${u.unit_type||'-'}</td>`;
            if (visibleCols['unit_model']) tr += `<td>${u.unit_model||'-'}</td>`;
            if (visibleCols['development_delivery_date']) tr += `<td>${u.development_delivery_date||'-'}</td>`;
            if (visibleCols['finishing_specs']) tr += `<td><span class="badge bg-light text-dark border fw-normal">${u.finishing_specs||'-'}</span></td>`;
            
            if (visibleCols['gross_area']) tr += `<td class="fw-bold text-dark">${fmtArea(u.gross_area)}</td>`;
            if (visibleCols['garden_area']) tr += `<td>${fmtArea(u.garden_area)}</td>`;
            if (visibleCols['land_area']) tr += `<td>${fmtArea(u.land_area)}</td>`;
            if (visibleCols['penthouse_area']) tr += `<td>${fmtArea(u.penthouse_area)}</td>`;
            if (visibleCols['roof_terraces_area']) tr += `<td>${fmtArea(u.roof_terraces_area)}</td>`;
            if (visibleCols['interest_free_unit_price']) tr += `<td><span class="price-text">${fmtMoney(u.interest_free_unit_price)}</span></td>`;

            // --- 1. Map Button Logic ---
            let mapAction = '';
            let mapBtnStyle = 'background-color: #6c757d; border-color: #6c757d; color: white;';
            
            if (u.project_id && u.map_focus_code) {
                const targetUrl = `${urls.unitMapping}?project_id=${u.project_id}&focus_unit=${u.map_focus_code}`;
                mapAction = `onclick="window.location.href='${targetUrl}'"`;
                mapBtnStyle = 'background-color: #0d6efd; color: white;'; // Blue
            } else {
                mapAction = `onclick="showMissingMapModal('${u.unit_code}')"`;
                mapBtnStyle = 'background-color: #e9ecef; color: #adb5bd; border: 1px solid #ced4da;'; // Grey
            }

            // --- 2. Layouts Button Logic ---
            let layoutAction = '';
            let layoutBtnStyle = 'background-color: #17a2b8; border-color: #17a2b8; color: white;';
            let layoutIcon = '<i class="fa-regular fa-images"></i>';

            if (u.layout_images && u.layout_images.length > 0) {
                // If images exist, enable click
                layoutAction = `onclick="openLayoutModal('${u.unit_code}')"`;
            } else {
                // If no images, disable button
                layoutBtnStyle = 'background-color: #e9ecef; color: #adb5bd; border: 1px solid #ced4da; cursor: not-allowed;';
                layoutAction = ''; 
            }

            // --- 3. Assemble Actions Column ---
            tr += `<td class="text-end" style="min-width: 180px;">
                     <button class="btn-action me-1" ${layoutAction} style="${layoutBtnStyle} padding: 4px 10px;" title="View Brochure">
                        ${layoutIcon}
                     </button>

                     <button class="btn-action me-1" ${mapAction} style="${mapBtnStyle} padding: 4px 10px;" title="View on Masterplan">
                        <i class="fa-solid fa-map-location-dot"></i>
                     </button>
                     
                     <button class="btn-action" onclick="buyUnit('${u.unit_code}')" title="Purchase Unit">Buy</button>
                   </td>`;
            
            tr += '</tr>';
            html += tr;
        });

        tbody.innerHTML = html;
        renderPagination(totalPages);
    }

    // --- NEW: Missing Map Modal ---
    window.showMissingMapModal = function(unitCode) {
        Swal.fire({
            icon: 'warning',
            title: 'Location Not Found',
            text: `The unit "${unitCode}" has not been pinned to the masterplan yet.`,
            confirmButtonColor: '#3085d6',
            confirmButtonText: 'Understood',
            footer: '<span class="text-muted small">Please contact the admin to map this unit.</span>'
        });
    };

    function renderPagination(totalPages) {
        const ul = document.getElementById('pagination-list');
        ul.innerHTML = '';
        if(totalPages <= 1) return;

        const createLi = (txt, page, active, disabled) => {
            const li = document.createElement('li');
            li.className = `page-item ${active?'active':''} ${disabled?'disabled':''}`;
            const a = document.createElement('a');
            a.className = 'page-link';
            a.innerHTML = txt;
            a.onclick = (e) => { e.preventDefault(); if(!active && !disabled) changePage(page); };
            li.appendChild(a);
            return li;
        };

        ul.appendChild(createLi('Prev', currentPage-1, false, currentPage===1));
        
        let s = Math.max(1, currentPage-2), e = Math.min(totalPages, currentPage+2);
        if(s===1) e = Math.min(5, totalPages);
        if(e===totalPages) s = Math.max(1, totalPages-4);

        if(s > 1) { ul.appendChild(createLi('1', 1, false, false)); if(s > 2) ul.appendChild(createLi('...', null, false, true)); }
        for(let i=s; i<=e; i++) ul.appendChild(createLi(i, i, i===currentPage, false));
        if(e < totalPages) { if(e < totalPages-1) ul.appendChild(createLi('...', null, false, true)); ul.appendChild(createLi(totalPages, totalPages, false, false)); }
        
        ul.appendChild(createLi('Next', currentPage+1, false, currentPage===totalPages));
    }

    function changePage(p) {
        currentPage = p;
        renderTable(availableUnits);
        document.querySelector('.table-container-new-new').scrollTop = 0;
    }

    window.buyUnit = function(code) {
        const f = $('<form method="POST" action="'+urls.home+'"><input type="hidden" name="csrfmiddlewaretoken" value="'+csrftoken+'"><input type="hidden" name="unit_code" value="'+code+'"></form>');
        const u = rawData.find(x => x.unit_code === code);
        if(u) f.append('<input type="hidden" name="project_name" value="'+u.project+'">');
        $('body').append(f);
        f.submit();
    };

    // --- LAYOUT MODAL LOGIC ---
    
    window.openLayoutModal = function(unitCode) {
        const unit = rawData.find(u => u.unit_code === unitCode);
        if (!unit || !unit.layout_images || unit.layout_images.length === 0) return;

        const images = unit.layout_images;
        const container = document.getElementById('modalCarouselContainer');
        const total = images.length;
        
        // 1. Build Slides HTML
        let slidesHtml = '';
        images.forEach((imgUrl, index) => {
            const i = index + 1;
            const prevId = i === 1 ? total : i - 1;
            const nextId = i === total ? 1 : i + 1;

            slidesHtml += `
                <li id="carousel__slide${i}" tabindex="0" class="carousel__slide">
                    <div class="carousel__snapper">
                        <img src="${imgUrl}" alt="Layout ${i}">
                        <a href="#carousel__slide${prevId}" class="carousel__prev">Go to last slide</a>
                        <a href="#carousel__slide${nextId}" class="carousel__next">Go to next slide</a>
                    </div>
                </li>`;
        });

        // 2. Inject into Container (Using the requested CSS structure)
        container.innerHTML = `
            <section class="carousel" aria-label="Gallery">
                <ol class="carousel__viewport">
                    ${slidesHtml}
                </ol>
            </section>
        `;

        // 3. Show Modal
        document.getElementById('layoutModal').style.display = "block";
    };

    window.closeLayoutModal = function() {
        document.getElementById('layoutModal').style.display = "none";
        // Clear content to reset carousel state
        document.getElementById('modalCarouselContainer').innerHTML = '';
    };

    // Close when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('layoutModal');
        if (event.target == modal) {
            closeLayoutModal();
        }
    };


    // --- DYNAMIC DROPDOWN LOGIC (FACETED SEARCH) ---
    function updateDropdowns() {
        // --- NEW: Update Area Range Placeholders based on Filtered Data (availableUnits) ---
        if (availableUnits.length > 0) {
            const areas = availableUnits.map(u => parseFloat(u.gross_area) || 0).filter(a => a > 0);
            if (areas.length > 0) {
                const currentMin = Math.min(...areas).toFixed(0);
                const currentMax = Math.max(...areas).toFixed(0);
                
                // Only update placeholder if user hasn't typed a value
                if (!$('#area-min').val()) $('#area-min').attr('placeholder', currentMin);
                if (!$('#area-max').val()) $('#area-max').attr('placeholder', currentMax);
            }
        }
        // -----------------------------------------------------------------------------------

        filterConfig.forEach(targetCfg => {
            const $el = $('#' + targetCfg.id);
            if(!$el.length) return;

            // 1. Get current selection to preserve it
            const currentSelection = $el.val() || [];

            // 2. Filter rawData based on *ALL OTHER* active filters
            // We do NOT filter a dropdown by itself, otherwise you can't change your mind.
            const validData = rawData.filter(row => {
                // Check Global Area
                const area = parseFloat(row.gross_area) || 0;
                if (activeFilters.areaMin !== null && area < activeFilters.areaMin) return false;
                if (activeFilters.areaMax !== null && area > activeFilters.areaMax) return false;

                // Check other dropdowns
                for (let otherCfg of filterConfig) {
                    if (otherCfg.key === targetCfg.key) continue; // Skip self

                    const selected = activeFilters[otherCfg.key];
                    if (selected && selected.length > 0) {
                        const rowVal = String(row[otherCfg.key]);
                        // Exact match logic for multi-select
                        if (!selected.some(s => String(s) === rowVal)) return false;
                    }
                }
                return true;
            });

            // 3. Extract unique values from valid data
            let vals = [...new Set(validData.map(item => item[targetCfg.key]))]
                .filter(x => x !== null && x !== undefined && x !== '');

            // 4. Sort
            if(vals.length > 0 && !isNaN(vals[0])) {
                vals.sort((a, b) => parseFloat(a) - parseFloat(b));
            } else {
                vals.sort();
            }

            // 5. Re-populate Select2
            $el.empty(); // Remove old options
            
            vals.forEach(v => {
                let txt = v;
                if(targetCfg.isPrice) txt = parseFloat(v).toLocaleString('en-US');
                
                // Mark as selected if it was in the previous selection
                const isSelected = currentSelection.includes(String(v));
                $el.append(new Option(txt, v, false, isSelected));
            });

            // Trigger Select2 update (without firing the main change event)
            $el.trigger('change.select2');
        });
    }
</script>
{% endblock %}