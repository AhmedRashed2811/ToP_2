{% extends 'ToP/base.html' %}
{% load static %}
{% block title %}Dual Payments Input{% endblock %}
{% block content %}
<style>
    .container {
        max-width: 1400px;
        margin: 20px auto;
        padding: 20px;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    /* Sticky Header Styles */
    .sticky-header {
        position: -webkit-sticky; /* Safari */
        position: sticky;
        top: 17%; /* Adjusted as per your previous code */
        z-index: 100;
        background-color: #ffffff;
        padding: 15px 0;
        border-bottom: 2px solid #f0f0f0;
        margin-bottom: 20px;
        
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
    }

    select {
        width: 200px;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .payments-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }

    .payment-box {
        flex: 1;
        min-width: 300px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        overflow-x: auto;
    }

    h2, h3 {
        text-align: center;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        min-width: 400px;
    }

    th, td {
        padding: 5px;
        font-size: 13px;
        text-align: center;
        border: 1px solid #ccc;
        position: relative; 
    }

    input[type="number"] {
        width: 100%;
        padding: 6px;
        margin-bottom: 6px;
        border: 1px solid transparent; 
        box-sizing: border-box;
    }
    
    input[type="number"]:focus {
        border: 1px solid #007bff;
        outline: none;
        background-color: #f0f8ff;
    }

    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: red;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        display: none;
        z-index: 9999;
    }

    /* Updated Toggle Row for Delete Button + Responsiveness */
    .toggle-row {
        display: flex;
        flex-wrap: wrap; /* Allows wrapping on mobile */
        align-items: center;
        gap: 20px;
        justify-content: center;
        margin: 20px 0;
        padding: 10px;
        background-color: #f9f9f9;
        border-radius: 8px;
    }

    /* Delete Button Styles */
    .btn-delete {
        background-color: #dc3545; /* Danger Red */
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        transition: background-color 0.2s, transform 0.1s;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .btn-delete:hover {
        background-color: #c82333;
    }

    .btn-delete:active {
        transform: scale(0.98);
    }

    /* ========================================= */
    /* CSS FOR EXCEL-LIKE DRAG FUNCTIONALITY */
    /* ========================================= */
    
    #drag-handle {
        width: 7px;
        height: 7px;
        background-color: #217346; /* Excel Green */
        border: 1px solid #fff;
        position: absolute;
        bottom: 0;
        right: 0;
        cursor: crosshair;
        z-index: 10;
        display: none;
        pointer-events: auto;
    }

    .drag-highlight input {
        background-color: rgba(33, 115, 70, 0.1) !important;
        border: 1px dashed #217346 !important;
    }

    .noselect {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    /* ========================================= */
    /* CSS FOR SCROLL TO TOP BUTTON (MOBILE)     */
    /* ========================================= */
    #scrollTopBtn {
        display: none; /* Hidden on desktop */
        position: fixed;
        bottom: 25px;
        right: 25px;
        z-index: 98; /* Below toast (9999) but above content */
        font-size: 20px;
        border: none;
        outline: none;
        background-color: #007bff; /* Primary Blue */
        color: white;
        cursor: pointer;
        padding: 10px 15px;
        border-radius: 50%;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        transition: opacity 0.3s, transform 0.3s;
        opacity: 0.9;
    }

    #scrollTopBtn:hover {
        background-color: #0056b3;
        transform: scale(1.1);
    }

    @media (max-width: 768px) {
        .sticky-header { flex-direction: column; align-items: center; position: static; }
        .payments-wrapper { flex-direction: column; }
        .payment-box { min-width: 100%; padding: 10px; }
        table { min-width: 100%; display: block; overflow-x: auto; }
        th, td { font-size: 12px; padding: 4px; }
        select { width: 90%; }
        
        #scrollTopBtn.show {
            display: block;
        }

        .toggle-row {
            flex-direction: column;
            gap: 15px;
        }
    }
</style>

<div class="container">
    <h2>Dual Payments Input</h2>

    <div class="selectors sticky-header">
        <div>
            <label for="project">Select Project:</label><br>
            <select id="project">
                <option value="">-- Select Project --</option>
                {% for project in projects %}
                    <option value="{{ project.id }}">{{ project.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label for="year">Select Year:</label><br>
            <select id="year">
                {% for y in year_range %}
                    <option value="{{ y }}">{{ y }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label for="scheme">Select Scheme:</label><br>
            <select id="scheme">
                <option value="flat">Flat</option>
                <option value="flat_back_loaded">Flat Back Loaded</option>
                <option value="bullet">Bullet</option>
                <option value="bullet_back_loaded">Bullet Back loaded</option>
            </select>
        </div>
    </div>


    <div class="toggle-row" style="display: none;">
        <div style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="disable_additional_discount" />
            <label for="disable_additional_discount" style="margin:0; cursor: pointer;"><strong>Disable Additional Discount (Extended)</strong></label>
        </div>

        <button id="delete-plan-btn" class="btn-delete">
            <span>&#128465;</span> Delete Current Plan
        </button>
    </div>

    <div id="payments-section" style="display: none;">
        <div class="payments-wrapper">
            
            <div class="payment-box" id="standard-section" style="display: none;">
                <h3>Standard Payments</h3>
                <input type="number" id="std-rate" step="0.00001" value="28.25" style="display: none;">
                <div id="std-npv"><strong>NPV: 0.00%</strong></div>
                <table>
                    <thead>
                        <tr><th>Label</th><th>Value (%)</th><th>Cumulative (%)</th></tr>
                    </thead>
                    <tbody id="std-table-body">
                        </tbody>
                </table>
            </div>

            <div class="payment-box" id="extended-section">
                <h3>Extended Payments</h3>
                <input type="number" id="ext-rate" step="0.00001" value="28.25" style="display: none;">
                <div id="ext-npv"><strong>NPV: 0.00%</strong></div>
                
                <table id="ext-table">
                    <thead>
                        <tr><th>Label</th><th>Value (%)</th><th>Cumulative (%)</th></tr>
                    </thead>
                    <tbody id="ext-table-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="drag-handle"></div>

<button id="scrollTopBtn" title="Go to top">
    &#8679; </button>

<div class="toast" id="toast">Cumulative percentage cannot exceed 100%</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        let toast = document.getElementById('toast');
        let projectSelect = document.getElementById('project');
        let yearSelect = document.getElementById('year');
        let schemeSelect = document.getElementById('scheme');
        let disableDiscountCheckbox = document.getElementById('disable_additional_discount');
        let deleteBtn = document.getElementById('delete-plan-btn'); 
        let MAX_ROWS = 42; 

        // --- Drag to Fill Variables ---
        const dragHandle = document.getElementById('drag-handle');
        let isDragging = false;
        let startInput = null;
        let startValue = 0;
        let highlightedInputs = [];

        // --- Auto Scroll Variables ---
        let scrollInterval = null;
        const SCROLL_ZONE_SIZE = 60; 
        const SCROLL_SPEED = 15;     
        let lastMouseX = 0;
        let lastMouseY = 0;

        function showToast(msg, isError = false) {
            toast.textContent = msg;
            toast.style.backgroundColor = isError ? '#dc3545' : 'red'; 
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
                toast.style.backgroundColor = 'red'; // reset
            }, 3000);
        }

        function formatNumberDisplay(num) {
            return parseFloat(num.toFixed(4));
        }
        
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
            return '';
        }
        const csrfToken = getCookie('csrftoken');


        function createPaymentRows(tableBody, prefix, count) {
            tableBody.innerHTML = `
                <tr id="${prefix}_row_0">
                    <td>DP1</td>
                    <td class="input-cell"><input type="number" step="0.00001" min="0" class="${prefix}-value" data-index="0"></td>
                    <td><span id="${prefix}_cum_0"></span></td>
                </tr>
                <tr id="${prefix}_row_1">
                    <td>DP2</td>
                    <td class="input-cell"><input type="number" step="0.00001" min="0" class="${prefix}-value" data-index="1"></td>
                    <td><span id="${prefix}_cum_1"></span></td>
                </tr>
            `;

            for (let i = 2; i < count && i < MAX_ROWS; i++) {
                let row = document.createElement('tr');
                row.id = `${prefix}_row_${i}`;
                row.innerHTML = `
                    <td>PMT ${i - 1}</td>
                    <td class="input-cell"><input type="number" step="0.00001" min="0" class="${prefix}-value" data-index="${i}"></td>
                    <td><span id="${prefix}_cum_${i}"></span></td>
                `;
                tableBody.appendChild(row);
            }
        }

        // =========================================================
        //  EXCEL-LIKE DRAG & DOUBLE-CLICK AUTO-FILL LOGIC
        // =========================================================
        function initDragFunctionality() {
            const extTable = document.getElementById('ext-table');
            
            // 1. Position handle on focus
            extTable.addEventListener('focusin', (e) => {
                if (e.target.classList.contains('ext-value')) {
                    const td = e.target.closest('td');
                    td.appendChild(dragHandle);
                    dragHandle.style.display = 'block';
                    startInput = e.target;
                }
            });

            // 2. DOUBLE CLICK to Auto-Fill
            dragHandle.addEventListener('dblclick', (e) => {
                e.preventDefault();
                e.stopPropagation();

                if (!startInput) return;

                const startVal = parseFloat(startInput.value) || 0;
                const startIndex = parseInt(startInput.dataset.index);
                const allInputs = document.querySelectorAll('.ext-value');
                let bulkUpdates = [];
                let changesMade = false;

                // Loop from the next input downwards
                for (let i = startIndex + 1; i < allInputs.length; i++) {
                    // Selector using index is safer than array index in case of DOM manipulation
                    let currentInput = document.querySelector(`.ext-value[data-index="${i}"]`);
                    
                    if (!currentInput) break;

                    // STOP if we collide with a cell that already has a value (is not empty)
                    if (currentInput.value.trim() !== '') {
                        break;
                    }

                    // Fill the empty cell
                    currentInput.value = startVal; // Update DOM directly
                    bulkUpdates.push({
                        index: i,
                        value: startVal
                    });
                    changesMade = true;
                }

                if (changesMade) {
                    // Trigger math calculations
                    if (window.extUpdateMath) window.extUpdateMath();
                    
                    // Send data to server
                    sendBulkSave(bulkUpdates);
                }
            });

            // 3. Dragging Logic
            dragHandle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if(!startInput) return;
                
                isDragging = true;
                startValue = parseFloat(startInput.value) || 0;
                document.body.classList.add('noselect');
                highlightedInputs = [startInput];
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging || !startInput) return;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
                handleDragHover(e.clientX, e.clientY);
                checkAutoScroll(e.clientY);
            });

            document.addEventListener('mouseup', () => {
                if (!isDragging) return;
                stopAutoScroll(); 
                isDragging = false;
                document.body.classList.remove('noselect');
                document.querySelectorAll('.drag-highlight').forEach(el => el.classList.remove('drag-highlight'));

                if (highlightedInputs.length > 0) {
                    let bulkUpdates = [];
                    highlightedInputs.forEach(input => {
                        input.value = startValue; 
                        bulkUpdates.push({
                            index: parseInt(input.dataset.index),
                            value: startValue
                        });
                    });
                    if (window.extUpdateMath) {
                        window.extUpdateMath();
                    }
                    sendBulkSave(bulkUpdates);
                }
                highlightedInputs = [];
            });
        }

        function handleDragHover(x, y) {
            dragHandle.style.display = 'none'; 
            let elemBelow = document.elementFromPoint(x, y);
            dragHandle.style.display = 'block';
            if (!elemBelow) return;
            let targetInput = elemBelow.closest('input.ext-value');
            
            if (targetInput) {
                let startIndex = parseInt(startInput.dataset.index);
                let currentIndex = parseInt(targetInput.dataset.index);
                document.querySelectorAll('.drag-highlight').forEach(el => el.classList.remove('drag-highlight'));
                highlightedInputs = [];
                let min = Math.min(startIndex, currentIndex);
                let max = Math.max(startIndex, currentIndex);
                for (let i = min; i <= max; i++) {
                    let input = document.querySelector(`.ext-value[data-index="${i}"]`);
                    if(input) {
                        highlightedInputs.push(input);
                        input.closest('td').classList.add('drag-highlight');
                    }
                }
            }
        }

        function checkAutoScroll(y) {
            const viewportHeight = window.innerHeight;
            if (y < SCROLL_ZONE_SIZE) {
                startAutoScroll(-1); 
            } else if (y > viewportHeight - SCROLL_ZONE_SIZE) {
                startAutoScroll(1); 
            } else {
                stopAutoScroll();
            }
        }

        function startAutoScroll(direction) {
            if (scrollInterval) return; 
            scrollInterval = setInterval(() => {
                window.scrollBy(0, direction * SCROLL_SPEED);
                handleDragHover(lastMouseX, lastMouseY);
            }, 30); 
        }

        function stopAutoScroll() {
            if (scrollInterval) {
                clearInterval(scrollInterval);
                scrollInterval = null;
            }
        }

        function sendBulkSave(updatesArray) {
            let projectId = projectSelect.value;
            if (!projectId || updatesArray.length === 0) return;

            const payload = {
                project_id: projectId,
                year: yearSelect.value,
                scheme: schemeSelect.value,
                disable_additional_discount: disableDiscountCheckbox.checked,
                bulk_updates: updatesArray 
            };

            fetch('{% url "save_extended_payment_ajax" %}', {
                method: "POST",
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(d => {
                if(!d.success) showToast("Error saving bulk data", true);
            })
            .catch(err => console.error('Bulk Save failed', err));
        }
        
        initDragFunctionality();

        // =========================================================
        //  DELETE BUTTON LOGIC
        // =========================================================
        deleteBtn.addEventListener('click', () => {
            let pid = projectSelect.value;
            if (!pid) {
                showToast("Please select a project first", true);
                return;
            }


            const payload = {
                project_id: pid,
                year: yearSelect.value,
                scheme: schemeSelect.value
            };

            fetch('{% url "delete_extended_payment_ajax" %}', {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, false); 
                    reloadPayments();
                } else {
                    showToast(data.message || "Failed to delete.", true);
                }
            })
            .catch(err => {
                console.error(err);
                showToast("An error occurred.", true);
            });
        });

        // =========================================================
        //  PAYMENT SYSTEM LOGIC
        // =========================================================

        function setupPaymentSystem(prefix, valueClass, saveUrl, fetchUrl, npvId) {
            let npvDisplay = document.getElementById(npvId);
            let inputs = document.querySelectorAll('.' + valueClass);

            function runLocalMath() {
                inputs = document.querySelectorAll('.' + valueClass);
                let cumSum = 0;
                let cutoff = false;
                
                inputs.forEach((input, i) => {
                    let row = document.getElementById(`${prefix}_row_${i}`);
                    let val = parseFloat(input.value) || 0;
                    cumSum += val;

                    let cumEl = document.getElementById(`${prefix}_cum_${i}`);
                    
                    if (cumEl) {
                        if (cumSum < 0.000001) {
                            cumEl.textContent = '';
                        } else {
                            cumEl.textContent = formatNumberDisplay(cumSum);
                        }
                    }

                    if(row) row.style.display = cutoff ? 'none' : '';
                    if (cumSum >= 99.99999 && !cutoff) cutoff = true;
                });

                calculateNPV();
            }

            if (prefix === 'ext') {
                window.extUpdateMath = runLocalMath;
            }

            function updateInputs() {
                inputs = document.querySelectorAll('.' + valueClass);
                inputs.forEach((input) => {
                    if(input._eventListener) {
                        input.removeEventListener('input', input._eventListener);
                    }
                    
                    let listener = () => {
                        runLocalMath();
                        let total = 0;
                        inputs.forEach(inp => total += parseFloat(inp.value) || 0);
                        if (total > 100.00001) { 
                            let currentVal = parseFloat(input.value) || 0;
                            let allowed = currentVal - (total - 100);
                            input.value = allowed > 0 ? allowed : 0;
                            runLocalMath(); 
                        }
                        let index = parseInt(input.dataset.index);
                        let value = parseFloat(input.value) || 0;
                        saveSingle(index, value);
                    };
                    input._eventListener = listener;
                    input.addEventListener('input', listener);
                });
            }

            function saveSingle(index, value) {
                let projectId = projectSelect.value;
                if (!projectId) return;

                const payload = {
                    project_id: projectId,
                    year: yearSelect.value,
                    index: index,
                    value: value,
                    scheme: schemeSelect.value
                };
                
                if (prefix === 'ext') {
                    payload.disable_additional_discount = disableDiscountCheckbox.checked;
                }

                fetch(saveUrl, {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                    body: JSON.stringify(payload)
                }).catch(err => console.error('Save failed', err));
            }

            function calculateNPV() {
                let rateInput = document.getElementById(`${prefix}-rate`);
                let rate = parseFloat(rateInput?.value) || 0.2825;
                let currentInputs = document.querySelectorAll('.' + valueClass);
                let dp1 = parseFloat(currentInputs[0]?.value) || 0;
                let dp2 = parseFloat(currentInputs[1]?.value) || 0;
                let installments = [];

                for (let t = 2; t < currentInputs.length; t++) {
                    let val = parseFloat(currentInputs[t]?.value);
                    if (!isNaN(val) && val > 0) installments.push(val);
                }

                let qRate = Math.pow(1 + rate, 1 / 4) - 1;
                let npv = 0;

                for (let t = 0; t < installments.length; t++) {
                    npv += installments[t] / Math.pow(1 + qRate, t + 1);
                }

                npv += dp1 + dp2;
                npvDisplay.textContent = `NPV: ${formatNumberDisplay(npv)}%`;
            }

            function loadFromServer(projectId) {
                let selectedYear = yearSelect.value;
                fetch(`${fetchUrl}?project_id=${projectId}&year=${selectedYear}&scheme=${schemeSelect.value}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            if (prefix === 'ext' && 'disable_additional_discount' in data.data) {
                                disableDiscountCheckbox.checked = !!data.data.disable_additional_discount;
                            }
                            if (prefix === 'ext' && data.data.interest_rate) {
                                document.getElementById('ext-rate').value = data.data.interest_rate;
                            }
                            if (prefix === 'std' && data.data.interest_rate) {
                                document.getElementById('std-rate').value = data.data.interest_rate;
                            }

                            inputs.forEach((input, i) => {
                                let val = 0;
                                if (i === 0) val = data.data.dp1 || 0;
                                else if (i === 1) val = data.data.dp2 || 0;
                                else val = data.data[`installment_${i - 2}`] || 0;
                                input.value = val === 0 ? '' : formatNumberDisplay(val);
                            });

                            runLocalMath(); 
                        } else {
                            showToast("Error loading data", true);
                        }
                    });
            }

            updateInputs();
            return { loadFromServer, updateInputs };
        }

        let { loadFromServer: loadExtended, updateInputs: updateExtInputs } =
            setupPaymentSystem('ext', 'ext-value', '{% url "save_extended_payment_ajax" %}', '{% url "fetch_extended_payment_ajax" %}', 'ext-npv');

        let { loadFromServer: loadStandard, updateInputs: updateStdInputs } =
            setupPaymentSystem('std', 'std-value', '{% url "save_standard_payment_ajax" %}', '{% url "fetch_standard_payment_ajax" %}', 'std-npv');

        // UPDATED reloadPayments function
        function reloadPayments() {
            let pid = projectSelect.value;
            let paymentsSection = document.getElementById('payments-section');
            let toggleRow = document.querySelector('.toggle-row'); 

            if (!pid) {
                paymentsSection.style.display = 'none';
                if(toggleRow) toggleRow.style.display = 'none'; // Hide it
                return;
            } else {
                paymentsSection.style.display = 'block';
                if(toggleRow) toggleRow.style.display = 'flex'; // Show it
            }

            let years = parseInt(yearSelect.value) || 0;
            let rowCount = Math.max(2, Math.min(years * 4 + 2, MAX_ROWS)); 

            createPaymentRows(document.getElementById('std-table-body'), 'std', rowCount);
            createPaymentRows(document.getElementById('ext-table-body'), 'ext', rowCount);

            let { loadFromServer: newLoadExtended, updateInputs: newUpdateExtInputs } =
                setupPaymentSystem('ext', 'ext-value', '{% url "save_extended_payment_ajax" %}', '{% url "fetch_extended_payment_ajax" %}', 'ext-npv');

            let { loadFromServer: newLoadStandard, updateInputs: newUpdateStdInputs } =
                setupPaymentSystem('std', 'std-value', '{% url "save_standard_payment_ajax" %}', '{% url "fetch_standard_payment_ajax" %}', 'std-npv');

            updateExtInputs = newUpdateExtInputs;
            updateStdInputs = newUpdateStdInputs;

            if (pid) {
                newLoadExtended(pid);
                newLoadStandard(pid);
            }
        }

        disableDiscountCheckbox.addEventListener('change', () => {
            const pid = projectSelect.value;
            if (!pid) return;
            fetch('{% url "save_extended_payment_ajax" %}', {
                method: "POST",
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                body: JSON.stringify({
                    project_id: pid,
                    year: yearSelect.value,
                    scheme: schemeSelect.value,
                    disable_additional_discount: disableDiscountCheckbox.checked
                })
            });
        });

        reloadPayments();

        projectSelect.addEventListener('change', reloadPayments);
        yearSelect.addEventListener('change', reloadPayments);
        schemeSelect.addEventListener('change', reloadPayments);

        const scrollTopBtn = document.getElementById("scrollTopBtn");

        window.addEventListener('scroll', () => {
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                scrollTopBtn.classList.add("show");
            } else {
                scrollTopBtn.classList.remove("show");
            }
        });

        scrollTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });

    });
</script>
{% endblock %}