{% extends 'ToP/base.html' %}
{% load static %}
{% block title %}ToP Model{% endblock %}
{% block content %}

<style>
    .search-button {
        margin-left: -8%;
        margin-right: 30px;
    }

    .PoweredBy{
        margin-left: 61%;
        display: flow-root;
        align-items: center;
        justify-content: center;
        padding: 15px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #555;
        font-size: 14px;
        margin-top: 1%;
        z-index: 1;
        position: absolute;
        text-align: -webkit-center;
    }
    

    @media (max-width: 900px) {
        .search-button {
            margin-left: -18%;
        }

        .PoweredBy{
            margin-left: 81%;
        }
    }

    #unitCodeSearch{
        padding: 8px;
        border: 2px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
        width:150px;
        box-sizing: border-box;
        transition: border-color 0.3s ease;
    }

    #customerSupportBtn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #007bff;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 30px;
        cursor: pointer;
        z-index: 9999;
        transition: all 0.3s ease;

      }
    
      #customerSupportBtn:hover {
        background-color: #0056b3;
        transform: scale(1.05);
      }
    
      #supportModal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
      }
    
      .support-modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 30px;
        border-radius: 10px;
        max-width: 400px;
        text-align: center;
        position: relative;
      }
    
      .support-button {
        margin: 10px auto;
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        display: block;
        width: 100%;
        transition: all 0.2s ease;
      }
    
      .support-button:hover {
        transform: scale(1.05);
      }
    
      .whatsapp-btn {
        background-color: #25D366;
        color: white;
      }
    
      .email-btn {
        background-color: #007bff;
        color: white;
      }
    
      .close-modal {
        position: absolute;
        top: 10px;
        right: 15px;
        cursor: pointer;
        font-size: 20px;
        font-weight: bold;
      }
    
      #emailFormContainer {
        display: none;
        margin-top: 15px;
      }
    
      #emailMessage {
        width: 100%;
        padding: 8px;
        margin-top: 8px;
        margin-bottom: 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
        height: 100px;
        }

      .responsive-container {
        margin-left: 287px;
        width: 50%;
        }

        .hold-modal{
            background:#fff; 
            padding:20px; 
            border-radius:8px; 
            max-width:400px; 
            margin:100px auto;
            position:relative;
        }

        #holdModal{
            display:none; 
            position:fixed; 
            top:0; left:0; 
            width:100%; 
            height:100%; 
            background:rgba(0,0,0,0.6); 
            z-index:9999;
        }
    
    /* For smaller screens (like tablets and phones) */
    @media (max-width: 768px) {
        .responsive-container {
            margin-left: 0;
            width: 100%;
        }
    }

    .flex-container-new{
        margin-left: -15%;
        display: flex;
        justify-content: space-between; /* Distribute space between children */
        align-items: flex-start;
        gap: 20px;
        width: 100%;
    }

    @media (max-width: 768px)  {
        .flex-container-new{
            margin-left: 4%;
            display: flex;
            justify-content: space-between; /* Distribute space between children */
            align-items: flex-start;
            gap: 20px;
            width: 100%;
        }
    }
    
    /* Styles specifically for 1024x1366 resolution */
    @media (min-width: 768px) and (max-width: 819px) {
        .flex-container-new {
            margin-left: -36%;
 
        }
    }

    /* Styles specifically for 1024x1366 resolution */
    @media (min-width: 768px) and (max-width: 1024px) {
        .flex-container-new {
            margin-left: 3%;
 
        }
    }

    /* Styles specifically for 1024x1366 resolution */
    @media (min-width: 820px) and (max-width: 1180px) {
       .flex-container-new {
           margin-left: -32%;

       }
   }

   /* Styles specifically for 1024x1366 resolution */
   @media (min-width: 769px) and (max-width: 819px) {
    .flex-container-new {
        margin-left: -32%;

    }
    }

    /* Styles specifically for 1024x1366 resolution */
    @media (min-width: 1024px) and (max-width: 1366px) {
        .flex-container-new {
            margin-left: -26%;

        }
    }

    /* Styles specifically for 1024x1366 resolution */
    @media (min-width: 1366px) and (max-width: 1500px) {
        .flex-container-new {
            margin-left: -20%;

        }
    }


    .flex-container{
        display: -webkit-box;
        justify-content: space-between; /* Distribute space between children */
        align-items: flex-start;
        gap: 20px;
        width: 100%;
    }

    @media (max-width: 768px) {
        .flex-container {
            display: -webkit-box;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            width: 100%;
        }
    }

    


    #searchDivButton{

        border-radius: 4px;
        cursor: pointer;
        font-size: 17px;
        transform: scale(1);
        display: block;
        padding: 6px 16px;
        background-color: rgb(156, 156, 156);
        color: white;
        text-align: center;
        width: fit-content;
        margin-left: -7%;
        
    }

    #SearchButton{

        border-radius: 4px;
        cursor: pointer;
        font-size: 17px;
        transform: scale(1);
        
    }

    #searchForm{
        display: flex;
        gap: 10px;
        align-items: center; 
        margin-left: -7%;
    }

    .search-btn {
        padding: 5px 10px; 
        background-color: rgb(156, 156, 156); 
        z-index: 1;
        color: white; 
        border: none; 
        border-radius: 4px; 
        cursor: pointer; 
        font-size: 17px; 
        margin-right: -14%;
        ht:38px; 
        margin-top: 0px;
        margin-left: -150px;
        margin-right: -14%;
        transition: all 0.3s ease; /* Smooth transition for hover effects */
    }

    .img-div{
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 15px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #555;
        font-size: 14px;
        margin-left: -34px;
        width: 420px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 15px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #555;
        font-size: 14px;
        margin-left: -34px;
        width: 420px;
    }

    #projectName{
        padding: 5px;
        border: 2px solid #ccc;
        border-radius: 4px; 
        font-size: 14px;
        height: 38px;
    }

    #unitCodeSearchNew{
        padding: 8px;
        border: 2px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
        width:150px;
        box-sizing: border-box;
        transition: border-color 0.3s ease;
    }

    .container{
        margin-left: 6%;
    }

    .temp-search-unit{
        width: 120px;
    }

    .temp-label{
        margin-bottom: 5px; 
    }
    @media (min-width: 321px) and (max-width: 449px) {
        #projectName {
            max-width: 100%;
            margin-top: 17%;
        }

        .temp-label{
            margin-bottom: -26px; 
        }
    }

    @media (max-width: 320px) {
        .PoweredBy{
            margin-left: 66%;
            z-index: -1;
            margin-top: 0%;
        }
        .temp-label{
            margin-bottom: -14px; 
        }

        #projectName {
            max-width: 100%;
            margin-top: 17%;
        }

        #projectName{
            padding: 5px;
            border: 2px solid #ccc;
            border-radius: 4px; 
            font-size: 14px;
            height: 38px;
            margin-top: 15px;
        }

        .temp-div {
            position: relative;
            display: inline-block;
            margin-top: 17px;

            
        }

        .temp-search-unit{
            width: 106px;
        }

    }

    /* Media Query for Mobile Phones */
    @media (max-width: 450px) {
        .search-btn {
            margin-top: -20%;
            margin-left: -53%;
            margin-right: 100%;
        }

        .temp-div {
            position: relative; 
            display: inline-block;
            margin-left: 0%;
            margin-top: 17px;

          }

        .search-button {
            margin-top: -23%;
            margin-left: -78%;
        }

        .search-form{
            margin-top: 8%;
        }


        .container {
            margin-top: 60px;
            padding: 20px;
            margin-left: 0%;
        }


        .img-div{
            margin-left: -117%;
            margin-top: -30%;
        }

        #projectName {
            max-width: 100%;
        }
        
        #unitCodeSearchNew{
            max-width: 50%;
        }

        .PoweredBy{
            margin-left: 57%;
            z-index: -1;
            margin-top: 0%;
        }

        .flex-container {
            display: block;
            t: space-between;
            align-items: flex-start;
            gap: 20px;
            width: 83%;
        }

        .hold-modal{
            background:#fff; 
            padding:20px; 
            border-radius:8px; 
            max-width:400px; 
            margin:100px auto;
            position:fixed;
            margin-left: 3%;
            margin-top: 15%;
        }

        #unitCodeSearch{
            width:113px;
        }

        #searchForm{
            display: flex;
            gap: 10px;
            align-items: center; 
            margin-left: 0%;
        }
    
        

    }

    .search-form{
        display: flex;
    }

    /* Scrollable Table Container */

    #addUnitBtn{
        padding: 11px 26px; 
        background-color: rgb(156, 156, 156); 
        color: white; 
        border: none; 
        border-radius: 4px; 
        cursor: pointer; 
        font-size: 18px; 
        height: fit-content; 
        margin-top: auto;
        transition: all 0.3s ease; 
        margin-right: 25px;
        width: 48%;
    }


/* Responsive Styles for Mobile Devices */
    @media (max-width: 460px) {

    .scrollable-table-container {
        overflow-x: auto; /* Enable horizontal scrolling */
        white-space: nowrap; /* Prevent wrapping of table content */
        margin-left: 0;
        margin-right: 0;
        padding: 10px 0; /* Add some padding for better spacing */
    }
    
    /* Installment Table */
    .installment-table {
        width: auto; /* Allow the table to expand beyond the screen width */
        min-width: 100%; /* Ensure it spans at least the full width of the container */
        border-collapse: collapse;
        margin: 0 auto; /* Center the table */
        font-size: 14px; /* Adjust font size for better readability */
    }
    .scrollable-table-container {
        margin-left: -2px; /* Adjust margins for smaller screens */
        margin-right: -10px;
    }

    .installment-table {
        font-size: 12px; /* Reduce font size further for mobile screens */
    }

    .installment-table th,
    .installment-table td {
        border: 1px solid #ccc; /* Add borders for clarity */
        padding: 8px; /* Add padding for better spacing */
        text-align: center; /* Align text in the center */
        max-width: 150px; /* Set a maximum width for each column */
        word-wrap: break-word; /* Wrap long text within cells */
    }

    .flex-container-new {
        margin-left: 4%;
        display: block;
        justify-content: space-between;
        align-items: flex-start;
        gap: 20px;
        width: 83%;
    }

}

@media (max-width: 450px) {

    .search-bar-class{
        display: flex;
        flex-direction: column;
        width: 76%;
        max-width: 300px;
        margin-top:5%;
    }
    #input-container {
      display: flex;
      flex-direction: column;
      gap: 20px; /* ‚¨ÖÔ∏è Increased vertical spacing between Grouped Rows */
    }
  
    .grouped-row {
      display: flex;
      justify-content: space-between;
      gap: 17%; /* ‚¨ÖÔ∏è Increased horizontal spacing between Groups */
    }
  
    .group {
      width: 48%;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
  
    .input-group {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
  
    .input-group label {
      font-size: 16px;         /* ‚¨ÖÔ∏è Bigger label */
      font-weight: bold;
      margin-bottom: 2px;
    }
  
    .input-group input {
        width: 100%;
        font-size: 13px;
        font-style:  italic;
        font-weight: bold;
        padding: 4px 6px;
        text-align: center; /* ‚úÖ Center the data */
      }

      #searchDivButton{
        margin-left: -82%;
        margin-top: -22%;
      }

      .flex-container {
        margin-left: 6%;
      }

      
  }

  .button-container {
    display: flex;
    flex-direction: column; /* Stack buttons vertically by default */
    gap: 10px; /* Add spacing between buttons */
}

/* Horizontal Layout for Small Screens (450px or less) */
@media (max-width: 450px) {
    .button-container {
        flex-direction: row; /* Display buttons horizontally */
        justify-content: space-between; /* Distribute buttons evenly */
        flex-wrap: wrap; /* Allow wrapping if needed */
    }

    .button-container button {
        flex: 1; /* Make buttons take equal width */
        margin: 5px; /* Add spacing between buttons */
    }

    #addUnitBtn{
        width: 89%;
    }
}
  
  .temp-div {
    position: relative; 
    display: inline-block;

  }

    /* Ensure search buttons are hidden but functionally exist */
    #searchDivButton,
    .search-btn,
    #SearchButton {
        display: none !important;
    }

    .search-bar-class{
        display: flex;
        flex-direction: column;
        width: 76%;
        max-width: 300px;
    }

    /* Simple CSS Spinner */
    .spinner {
        margin: 0 auto;
        width: 30px;
        height: 30px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff; /* Blue color */
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Discount price styling */
    #discount-input-group {
        margin-top: 5px;
    }

    #discount-input-group input {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 4px 8px;
        text-align: center;
    }

    #discount-input-group input:focus {
        border-color: #007bff;
        outline: none;
    }

    #discounted-price-group label {
        color: #28a745;
        font-weight: bold;
    }

    #discounted_price {
        color: #28a745 !important;
        font-weight: bold !important;
    }
</style>



{% with user_groups=request.user.groups.all|join:"," %}
    {% if "Sales" in user_groups or "Controller" in user_groups or "Manager" in user_groups  or "SalesHead" in user_groups  or "Viewer" in user_groups%}
        <!-- Customer Support Button -->
        <img 
            id="customerSupportBtn"
            src="{% static 'images/customer-service.png' %}" 
            alt="Customer Support"
            style="
                position: fixed;
                bottom: 20px;
                right: 20px;

                width: 70px;
                height: 60px;

                width: 50px;
                height: 40px;

                border-radius: 50%;
                cursor: pointer;
                z-index: 9999;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
                transition: transform 0.3s ease;
                background: transparent;
                padding: 0;
    "
            onclick="document.getElementById('supportModal').style.display = 'block';"
        />


        <!-- Support Modal -->
        <div id="supportModal">
            <div class="support-modal-content">
                <span class="close-modal" onclick="closeSupportModal()">&times;</span>
                
                <button class="support-button whatsapp-btn" onclick="openWhatsApp()">Chat on WhatsApp</button>
                
                <button class="support-button email-btn" onclick="toggleEmailForm()">Send Email</button>

                <div id="emailFormContainer">
                <form id="supportEmailForm" method="POST" action="{% url 'send_support_email' %}">
                    {% csrf_token %}
                    <input type="hidden" name="sender_email" value="{{ request.user.email }}">
                    <textarea name="message" id="emailMessage" placeholder="Type your message here..."></textarea>
                    <div 
                        class="support-button email-btn" 
                        onclick="document.getElementById('supportEmailForm').submit();"
                        style="text-align: center; user-select: none;"
                        >
                            Send
                    </div>
                </form>
                </div>
            </div>
        </div>

        <script>
            const supportModal = document.getElementById("supportModal");
            const emailForm = document.getElementById("emailFormContainer");
        
            document.getElementById("customerSupportBtn").addEventListener("click", function () {
            supportModal.style.display = "block";
            });
        
            function closeSupportModal() {
            supportModal.style.display = "none";
            emailForm.style.display = "none"; // optional: reset form visibility
            }
        
            function toggleEmailForm() {
            emailForm.style.display = emailForm.style.display === "block" ? "none" : "block";
            }
        
            function openWhatsApp() {
            const phoneNumber = '201080321565'; // replace with actual number
            window.open(`https://wa.me/${phoneNumber}`, '_blank');
            }
        
            window.onclick = function (event) {
            if (event.target === supportModal) {
                closeSupportModal();
            }
            };
        </script>
    {% endif %} 
{% endwith %} 


{% if messages %}
    {% for message in messages %}
        <p style="color: {% if message.tags == 'success' %}green{% else %}red{% endif %};">
            {{ message }}
        </p>
    {% endfor %}
{% endif %}

<div 
  id="alert-url" 
  class="alert alert-success" 
  role="alert" 
  style="display: none; width: fit-content; padding: 8px 16px; font-size: 20px; "
    >
  Unit is held successfully!
</div>

{% if is_company_active is not None %}

    {% if is_company_active %}
    
        <!-- Combined Search Form -->
        <div  class="div1" style="text-align: left;">
            <form id="searchForm2" method="POST" class="search-form" style="gap: 10px; align-items: center;">
                {% csrf_token %}
                <!-- Dropdown for Project Names -->
                <div style="display: flex; flex-direction: column;">
                    <label for="projectName" style="font-size: 14px; font-weight: bold; margin-bottom: 5px; " ></label>
                    <select 
                        id="projectName" name="project_name" style="color: grey;"
                    >

                    
                    <script>
                        const select = document.getElementById('projectName');

                        function updateColor() {
                            if (select.value === '') {
                                select.style.color = 'grey';
                            } else {
                                select.style.color = 'black';  // or your default text color
                            }
                        }

                        // Update color on page load
                        updateColor();

                        // Update color on change
                        select.addEventListener('change', updateColor);
                    </script>

                    <option value="">Project</option>                        
                        {% if projects.exists %}
                            {% for project in projects %}
                                <option 
                                    value="{{ project.name }}" 
                                    {% if project.name == project_query %}selected{% endif %} 
                                    style="font-size: 14px;"
                                >
                                
                                    {{ project.name }}
                                </option>
                            {% endfor %}
                        {% else %}
                            <option value="" disabled style="font-size: 14px;">No projects available</option>
                        {% endif %}
                    </select>
                </div>

<div class="search-bar-class">
    <label for="unitCodeSearchNew" style="font-size: 14px; font-weight: bold; margin-bottom: 5px;"></label>
    <div style="position: relative; width: 100%;">
        <input 
            type="text" 
            id="unitCodeSearchNew" 
            name="unit_code" 
            list="unitCodeOptionsNew" 
            placeholder="Unit Code" 
            onfocus="this.style.borderColor = '#007bff';"
            onblur="this.style.borderColor = '#ccc';"
            value="{{ unit.unit_code }}"
        >
        <datalist id="unitCodeOptionsNew">
            {% if units %}
                {% for unit in units %}
                    <option 
                        value="{{ unit.unit_code }}" 
                        data-project="{{ unit.project }}"
                    >
                        {{ unit.unit_code }}
                    </option>
                {% endfor %}
            {% else %}
                <option value="" disabled>No Units available</option>
            {% endif %}
        </datalist>
    </div>
</div>
  

<button 
    type="submit" 
    class="search-btn"
    id="SearchButton"
    style="display: none;"
    onmouseover="this.style.backgroundColor='rgb(120, 120, 120)'; this.style.transform='scale(1.05)';"
    onmouseout="this.style.backgroundColor='rgb(156, 156, 156)'; this.style.transform='scale(1)';"
>
    Search
</button>

<script>
    // Logic to show/hide search button and auto-submit
    document.addEventListener("DOMContentLoaded", function () {
        const unitCodeInput = document.getElementById("unitCodeSearchNew");
        const searchButton = document.getElementById("SearchButton");

        if (unitCodeInput) {
            // Check initial state
            if(unitCodeInput.value.trim()) {
                searchButton.style.display = "inline-block";
            }

            // Listen for typing
            unitCodeInput.addEventListener("input", function () {
                if (this.value.trim()) {
                    searchButton.style.display = "inline-block";
                    // Mobile responsive adjustment
                    if (window.innerWidth <= 768) { 
                        document.querySelectorAll(".img-div").forEach(div => div.style.marginLeft = "-109%");
                    }
                } else {
                    searchButton.style.display = "none";
                }
            });

            // Auto-submit when selecting from datalist
            unitCodeInput.addEventListener("change", function() {
                if (this.value.trim()) {
                    document.getElementById("searchForm2").submit();
                }
            });
        }
    });
</script>

                


                <div class="img-div" >
                     {% comment %} <img 
                        src="{{ company.logo.url }}" 
                        alt="Logo" 
                        style=" margin-left: -52%;
                                height: 70px;
                                object-fit: contain;
                                width: 39%;
                                height: 98px;
                                margin-top: -33px;
                                margin-bottom: -4%;"
                    >  {% endcomment %}
                    {% comment %} <img 
                        src="{{ request.scheme }}://{{ request.get_host }}/top2{{ company.logo.url }}" 
                        alt="Logo" 
                        style=" margin-left: -52%;
                                height: 70px;
                                object-fit: contain;
                                width: 39%;
                                height: 98px;
                                margin-top: -33px;
                                margin-bottom: -4%;"
                    > {% endcomment %}
                </div>

                {% with user_groups=request.user.groups.all|join:"," %}
                    {% if "Sales" in user_groups or "SalesHead" in user_groups  or "Manager" in user_groups or "Viewer" in user_groups%}  
                        <div class="PoweredBy" id="PoweredBy">
                                <span style="margin-left: 4%;font-size: initial;">Powered By</span>
                                <img 
                                    src="{% static 'images/logo serag-final_page-0002.png' %}" 
                                    alt="Serag Logo" 
                                    style="object-fit: contain;width: 135px;"
                                >
                        </div>
                    {% endif %} 
                {% endwith %} 
            </form>

            

            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    const projectSelect = document.getElementById("projectName");
                
                    // First case (ERP)
                    const unitCodeSearchERP = document.getElementById("unitCodeSearchNewNew");
                    const unitCodeOptionsERP = document.getElementById("unitCodeOptionsNewNew");
                
                    // Second case (local DB)
                    const unitCodeSearchLocal = document.getElementById("unitCodeSearchNew");
                    const unitCodeOptionsLocal = document.getElementById("unitCodeOptionsNew");
                
                    // Helper function to attach filtering logic
                    function setupFiltering(unitCodeSearch, unitCodeOptions) {
                        if (!unitCodeSearch || !unitCodeOptions || !projectSelect) return;
                
                        const allUnits = Array.from(unitCodeOptions.querySelectorAll("option")).map(option => ({
                            value: option.value,
                            text: option.textContent,
                            project: option.dataset.project || ""
                        }));
                
                        unitCodeSearch.disabled = true;
                
                        projectSelect.addEventListener("change", function () {
                            const selectedProject = this.value;
                
                            unitCodeSearch.disabled = !selectedProject;
                            unitCodeSearch.value = "";
                            unitCodeOptions.innerHTML = "";
                
                            if (selectedProject) {
                                const filteredUnits = allUnits.filter(unit => unit.project === selectedProject);
                
                                filteredUnits.forEach(unit => {
                                    const opt = document.createElement("option");
                                    opt.value = unit.value;
                                    opt.textContent = unit.text;
                                    unitCodeOptions.appendChild(opt);
                                });
                
                                if (filteredUnits.length === 0) {
                                    const noOption = document.createElement("option");
                                    noOption.textContent = "No units for selected project";
                                    noOption.disabled = true;
                                    unitCodeOptions.appendChild(noOption);
                                }
                            }
                        });
                    }
                
                    // Call for both cases
                    setupFiltering(unitCodeSearchERP, unitCodeOptionsERP);
                    setupFiltering(unitCodeSearchLocal, unitCodeOptionsLocal);
                });
                </script>
                
            

        </div>


        <script>
            const isImpersonating = {{ is_impersonating|yesno:"true,false" }};
            const userCanEdit = {{ user_can_edit|yesno:"true,false" }};
            const userCanChangeYears = {{ user_can_change_years|yesno:"true,false" }};

            // console.log(`userCanEdit = ${userCanEdit}`)
        </script>
        
        
        {% if user_company.erp_url_leads %}
            <!-- üü† Hold Modal -->
            <div id="holdModal">
                <div class="hold-modal">
                    <h3>Unit (<i id="unit-code-in-hold">{{unit.unit_code}}</i>)  Hold Request</h3>
                
                    <div style="position: relative;">
                        <label for="clientInput">Lead Name: 
                            <span id="client-error" style="display: none; color:red">Lead Name Must be Set</span>
                        </label>
                        
                        <input id="clientInput" name="client_id" type="text"
                            placeholder="Search lead name..."
                            style="width: 100%; padding: 8px 28px 8px 8px; margin-top: 5px; margin-bottom: 10px;
                                   border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box;">
                    
                        <!-- Dropdown icon -->
                        <div id="clientDropdownArrow" style="position: absolute; top: 42px; right: 10px;
                             transform: translateY(-50%); cursor: pointer;">&#9662;</div>
                    
                        <ul id="clientSuggestions"
                            style="border: 1px solid #ccc; border-radius: 6px; max-height: 150px;
                                   overflow-y: auto; padding: 0; margin: 0; list-style: none;
                                   position: absolute; background-color: white; display: none;
                                   width: 100%; z-index: 1000;"></ul>
                    </div>
                    
                    <span id="id-error" style="display: none; color:red">Lead Name Must be Set</span>

                    <div id="holdModalButtons" style="text-align:right;">
                        <button onclick="closeHoldModal()" style="margin-left:10px; background-color: rgb(200, 61, 61); padding:8px 12px; border:none; border-radius:4px; color:white; cursor:pointer;"
                            onmouseover="this.style.backgroundColor='rgb(200, 61, 61)'; this.style.transform='scale(1.05)';"
                            onmouseout="this.style.backgroundColor='rgb(200, 61, 61)'; this.style.transform='scale(1)';">
                            Cancel
                        </button>
                        
                        <button onclick="submitHold()" style="background-color:#28a745; color:white; padding:8px 12px; border:none; border-radius:4px; cursor:pointer;"
                            onmouseover="this.style.backgroundColor='#28a745'; this.style.transform='scale(1.05)';"
                            onmouseout="this.style.backgroundColor='#28a745'; this.style.transform='scale(1)';">
                            Submit
                        </button>
                    </div>

                    <div id="holdModalLoading" style="display:none; text-align:center; margin-top:15px;">
                        <div class="spinner"></div>
                        <p style="margin-top:10px; color:#666; font-size:14px;">Processing Hold Request...</p>
                    </div>
                </div>
            </div>
            



        {% else %}

            <!-- üü† Hold Modal -->
            <div id="holdModal">
                <div class="hold-modal">
                  <h3>Unit (<i id="unit-code-in-hold">{{unit.unit_code}}</i>)  Hold Request</h3>
              
                  <label for="clientIdInput">Client ID 
                    <span id="id-error" style="display:none;color:red">Client Id and Phone Must be Set</span>
                  </label>
                  <input type="text" id="clientIdInput" style="width:100%;padding:8px;margin-top:5px;margin-bottom:10px;">
              
                  <!-- NEW: Client Phone Number (optional) -->
                  <label for="clientPhoneInput">Client Phone</label>
                  <input type="text" id="clientPhoneInput" placeholder="+201xxxxxxxx" 
                         style="width:100%;padding:8px;margin-top:5px;margin-bottom:10px;">
              
                  <div id="holdModalButtons" style="text-align:right;">
                        <button onclick="closeHoldModal()" style="margin-left:10px; background-color: rgb(200, 61, 61); padding:8px 12px; border:none; border-radius:4px; color:white; cursor:pointer;"
                            onmouseover="this.style.backgroundColor='rgb(200, 61, 61)'; this.style.transform='scale(1.05)';"
                            onmouseout="this.style.backgroundColor='rgb(200, 61, 61)'; this.style.transform='scale(1)';">
                            Cancel
                        </button>
                        
                        <button onclick="submitHold()" style="background-color:#28a745; color:white; padding:8px 12px; border:none; border-radius:4px; cursor:pointer;"
                            onmouseover="this.style.backgroundColor='#28a745'; this.style.transform='scale(1.05)';"
                            onmouseout="this.style.backgroundColor='#28a745'; this.style.transform='scale(1)';">
                            Submit
                        </button>
                    </div>

                    <div id="holdModalLoading" style="display:none; text-align:center; margin-top:15px;">
                        <div class="spinner"></div>
                        <p style="margin-top:10px; color:#666; font-size:14px;">Processing Hold Request...</p>
                    </div>
                </div>
              </div>
              

        {% endif %}

    {% else %}
        <p style="color: red; font-weight: bold;">Your company is inactive. Please contact support.</p>
    {% endif %}
{% endif %}

{% with user_groups=request.user.groups.all|join:"," %}
    <!-- Main Content -->
    {% if "Sales" not in user_groups and "Manager"  not in user_groups  and "SalesHead" not in user_groups and "Viewer" not in user_groups %} 
        <!-- Combined Search Form -->
        
        <div style="text-align: left;">
            <form id="searchForm" method="POST" class="search-form">
                
                {% csrf_token %}
                <!-- Dropdown for Company Names -->
                <div style="display: flex; flex-direction: column;">
                    <label for="companyFilter" style="font-size: 14px; font-weight: bold; margin-bottom: 5px;"></label>
                    <select 
                        id="companyFilter" 
                        name="company_name" 
                        style="
                            padding: 5px; 
                            border: 2px solid #ccc; 
                            border-radius: 4px; 
                            font-size: 12px; 
                            height: 39px; 
                            margin-top: -3px;
                        "
                    >
                        <option value="" style="font-size: 14px;">Company</option>
                        {% if companies.exists %}
                            {% for company in companies %}
                                <option value="{{ company.name }}" style="font-size: 14px;">{{ company.name }}</option>
                            {% endfor %}
                        {% else %}
                            <option value="" disabled style="font-size: 14px;">No companies available</option>
                        {% endif %}
                    </select>
                </div>

                <!-- Dropdown for Project Names -->
                <div style="display: flex; flex-direction: column;">
                    <label class="temp-label" for="projectName" style="font-size: 14px; font-weight: bold;" ></label>
                    <select id="projectName" name="project_name" style="
                                                                            padding: 8px;
                                                                            border: 2px solid #ccc;
                                                                            border-radius: 6px;
                                                                            font-size: 14px;
                                                                            width:150px;
                                                                            box-sizing: border-box;
                                                                            transition: border-color 0.3s ease;
                                                                            ">
                        <option value="">-- Select Project --</option>
                        {% if projects.exists %}
                            {% for project in projects %}
                                <option 
                                    value="{{ project.name }}" 
                                    data-company="{{ project.company.name }}"
                                    {% if project.name == project_query %}selected{% endif %}
                                >
                                    {{ project.name }}
                                </option>
                            {% endfor %}
                        {% else %}
                            <option value="" disabled>No projects available</option>
                        {% endif %}
                    </select>
                </div>

                <!-- Search Bar for Unit Code -->
                <div class="search-bar-class">
                    <label for="unitCodeSearch" style="font-size: 14px; font-weight: bold; margin-bottom: 5px;"></label>
                    <div style="position: relative; width: 100%;">
                        <input 
                            type="text" 
                            id="unitCodeSearch" 
                            name="unit_code" 
                            list="unitCodeOptions" 
                            placeholder="Unit Code" 
                            onfocus="this.style.borderColor = '#007bff';"
                            onblur="this.style.borderColor = '#ccc';"
                            value="{{ unit.unit_code }}"
                        >
                        <datalist id="unitCodeOptions">
                            {% if units.exists %}
                                {% for unit in units %}
                                    <option 
                                        value="{{ unit.unit_code }}" 
                                        data-project="{{ unit.project }}"
                                        data-company="{{ unit.company.name }}" 
                                    >
                                        {{ unit.unit_code }}
                                    </option>
                                {% endfor %}
                            {% else %}
                                <option value="" disabled>No Units available</option>
                            {% endif %}
                        </datalist>
                    </div>
                </div>

                <!-- Submit Button -->
                <button 
                    type="submit" 
                    class= "search-btn"
                    style="display: none;"
                    onmouseover="this.style.backgroundColor='rgb(120, 120, 120)'; this.style.transform='scale(1.05)';"
                    onmouseout="this.style.backgroundColor='rgb(156, 156, 156)'; this.style.transform='scale(1)';"
                    >
                    Search
                </button>
            </form>
        </div>
    {% endif %} 
{% endwith %} 

<!-- Modal -->
<div class="modal fade" id="warningModal" tabindex="-1" aria-labelledby="warningModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="warningModalLabel">Warning</h5>
                <button onclick="closeModal()"  type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                Please choose both Project Name and Unit Code.
            </div>

            <div class="modal-footer">
                <button onclick="closeModal()"  type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>

{% if request.session.saved_units %}
    <!-- Clear All Units Button -->
    <div style="text-align: left; margin-top: 15px;">
        <a href="{% url 'clear_saved_units' %}" class="btn btn-outline-danger" style="width: 139px;">Clear Saved Units</a>
        <a href="{% url 'download_all_units_pdf' %}" class="btn btn-outline-success" style=" margin-left: 3px;font-size: 15px;">
            Download Units as PDF
        </a>

        {% comment %} <!-- Trigger Button -->
        <a href="#" class="btn btn-outline-success" style="margin-left: 3px; font-size: 15px;" data-bs-toggle="modal" data-bs-target="#clientIDModal">
            Export Units as PDF
        </a>

        <form id="exportForm" method="post" action="{% url 'download_all_units_pdf' %}">
            {% csrf_token %}
            <input type="hidden" id="hidden_client_id" name="client_id" />
        </form>

        <!-- Modal -->
        <div class="modal fade" id="clientIDModal" tabindex="-1" aria-labelledby="clientIDModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="clientIDModalLabel">Enter Client ID</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label for="clientIDInput" class="form-label">Client ID:</label>
                    <input type="text" class="form-control" id="clientIDInput" placeholder="Enter client ID">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitClientIdBtn">Submit</button>
                </div>
                </div>
            </div>
        </div>

        <script>
            document.getElementById("submitClientIdBtn").addEventListener("click", function () {
                const clientIdInput = document.getElementById("clientIDInput");
                const clientId = clientIdInput.value.trim();
            
                if (!clientId) {
                    alert("Please enter a Client ID.");
                    return;
                }
            
                // Set hidden input value
                document.getElementById("hidden_client_id").value = clientId;
            
                // Submit the form
                document.getElementById("exportForm").submit();
            });
        </script> {% endcomment %}
    
    </div>
{%endif%}


<!-- Project Details -->
{% if project %}

    <span class="hidden">{{ project.name }}</span>
    <span class="hidden">{{ project.company }}</span>

    {% if project_config %}
        <span class="hidden">{{ project_config.interest_rate|default:"-" }}</span>
        <span class="hidden">{{ project_config.base_dp|default:"-" }}</span>
        <span class="hidden">{{ project_config.base_tenor_years|default:"-" }}</span>
        <span class="hidden">{{ project_config.base_payment_frequency|default:"-" }}</span>
        <span class="hidden">{{ project_config.use_static_base_npv|yesno:"Yes,No" }}</span>
    {% endif %}



    {% if base_npv %}
        <span class="hidden">{{ base_npv.term_period|default:"-" }}</span>
        <span class="hidden">{{ base_npv.npv_value|default:"-" }}</span>
    {% endif %}

    
    </div>


    <div {% if "Sales" not in user_groups and "Manager" not in user_groups and "SalesHead" not in user_groups and "Viewer" not in user_groups%} class="flex-container-new" {% else %} class="flex-container" {% endif %}>
        <!-- Input Container -->
        <div class="input-container {% if 'Sales' not in user_groups and 'Manager' not in user_groups and 'SalesHead' not in user_groups and 'Viewer' not in user_groups %}responsive-container{% endif %}" id="input-container">

        <div class="grouped-row">
            <div class="group group-1">
                <div class="input-group">
                    <label for="unit_code">Unit Code</label>
                    <input type="text" name="unit_code" id="unit_code" readonly value="{{ unit.unit_code }}" style="background-color: transparent; border: none; color: #000; font-weight: bold;text-align: left;" class="uniform-input">
                </div>


                {% if "Sales" not in user_groups or "SalesHead" not in user_groups or "Viewer" not in user_groups%}
                    <div class="input-group">
                        <label for="status">Status</label>
                        <input type="text" name="status" id="status" readonly value="{{ unit.status }}" style="background-color: transparent; border: none; color: #000; font-weight: bold;text-align: left;" class="uniform-input">
                    </div>

                    <div class="input-group">

                        {%if unit.sales_phasing == 0 or unit.sales_phasing == "None" or not unit.sales_phasing %}
                    
                        {%else%}
                            <label for="sales_phasing">Phasing</label>
                            <input type="text" name="sales_phasing" id="sales_phasing" readonly value="{{ unit.sales_phasing }}" style="background-color: transparent; border: none; color: #000; font-weight: bold;text-align: left;" class="uniform-input">
                        
                        {%endif%}
                    </div>
                {% endif %}

                <div class="input-group">
                    <label for="project_name">Project</label>
                    <input type="text" name="project_name" id="project_name" readonly value="{{ project.name }}" style="background-color: transparent; border: none; color: #000; font-weight: bold;text-align: left;" class="uniform-input">
                </div>
    
                <div class="input-group">
                    
                    {%if unit.num_bedrooms == 0 or unit.num_bedrooms == "None" or not unit.num_bedrooms %}
                    
                    {%else%}
                        <label for="num_bedrooms">N. Bedroomes</label>
                        <input type="text" name="num_bedrooms" id="num_bedrooms" readonly  value="{{ unit.num_bedrooms }}" style="background-color: transparent; border: none; color: #000; font-weight: bold;text-align: left;" class="uniform-input">
                    
                    {%endif%}

                </div>
    
                <div class="input-group">
                    <label for="finishing_specs">Finishing Type</label>
                    <input type="text" name="finishing_specs" id="finishing_specs" readonly  value="{{ unit.finishing_specs }}" style="background-color: transparent; border: none; color: #000; font-weight: bold;text-align: left;" class="uniform-input">
                </div>
            </div>
            <div class="group group-2">
    
                {# Gross Area #}
                {% if unit.gross_area %}
                    <div class="input-group">
                        <label for="net_area">Gross Area</label>
                        <input type="text" name="net_area" id="net_area" readonly value="{{ unit.gross_area }}" style="background-color: transparent; border: none; color: #000; font-weight: bold;text-align: left;" class="uniform-input">
                    </div>
                {% endif %}

                {# Garden Area #}
                {% if unit.garden_area %}
                    <div class="input-group">
                        <label for="garden_area">Garden Area</label>
                        <input type="text" name="garden_area" id="garden_area" readonly value="{{ unit.garden_area }}" style="background-color: transparent; border: none; color: #000; font-weight: bold;text-align: left;" class="uniform-input">
                    </div>
                {% endif %}

                {# Land Area #}
                {% if unit.land_area %}
                    <div class="input-group">
                        <label for="land_area">Land Area</label>
                        <input type="text" name="land_area" id="land_area" readonly value="{{ unit.land_area|floatformat:0 }}" style="background-color: transparent; border: none; color: #000; font-weight: bold;text-align: left;" class="uniform-input">
                    </div>
                {% endif %}

                {# Penthouse Area #}
                {% if unit.penthouse_area %}
                    <div class="input-group">
                        <label for="penthouse_area">Penthouse Area</label>
                        <input type="text" name="penthouse_area" id="penthouse_area" readonly value="{{ unit.penthouse_area }}" style="background-color: transparent; border: none; color: #000; font-weight: bold;text-align: left;" class="uniform-input">
                    </div>
                {% endif %}

                {# Terrace / Roof Area #}
                {% if total_uncovered_area %}
                    <div class="input-group">
                        <label for="uncovered_terraces">Terrace / Roof Area</label>
                        <input type="text" name="uncovered_terraces" id="uncovered_terraces" readonly value="{{ total_uncovered_area }}" style="background-color: transparent; border: none; color: #000; font-weight: bold;text-align: left;" class="uniform-input">
                    </div>
                {% endif %}

            </div>
        </div>
        
        <div class="grouped-row">
            <div class="group group-3">
                
                {% comment %} {% if user_can_change_years %}
                {% else %}  
                <div class="input-group" style="display: none;">
                    {% endif %} {% endcomment %}
                    <div class="input-group">
                    
                    <label for="tenor_years">Tenor Years</label>
                    <select name="tenor_years" id="tenor_years" required onchange="generateInstallmentTable()" class="uniform-input" style="text-align: center; text-align-last: center;">
                        {% for year in tenor_range %}
                            <option value="{{ year }}">{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>

                {% if special_offers %}
                    <div class="input-group" style="margin-top: 13px; margin-bottom: 13px;">
                        <label for="specia_offers">Special Offers</label>
                        <select name="special_offers" id="special_offers" required onchange="handleSpecialOfferChange()" class="uniform-input" style="text-align: center; text-align-last: center; max-width: 60%;">
                            <option value="" selected>-- No Special Offer --</option>
                            {% for offer in special_offers %}
                                <option value="{{ offer }}">{{ offer }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <script>
                        function handleSpecialOfferChange() {
                            const specialOffer = document.getElementById("special_offers").value;
                            const currency = document.getElementById("currency");
                            const contractDate = document.getElementById("contract_date");
                            const contractDateDisplay = document.getElementById("contract_date_display");
                            const tenorYears = document.getElementById("tenor_years");
                            const basePaymentFreq = document.getElementById("base_payment_frequency");
                            const paymentScheme = document.getElementById("payment-scheme")
                            
                            if (specialOffer !== "") {
                                // Disable
                                contractDate.disabled = true;
                                contractDateDisplay.disabled = true;
                                contractDateDisplay.style.backgroundColor = "#eee";
                                contractDateDisplay.style.cursor = "not-allowed";

                                tenorYears.disabled = true;
                                currency.disabled = true;
                                try{
                                    paymentScheme.style.display = "none"
    
                                    basePaymentFreq.style.pointerEvents = "none";
                                    basePaymentFreq.style.opacity = 0.6;
                                    basePaymentFreq.style.backgroundColor = "#eee";
                                    basePaymentFreq.style.cursor = "not-allowed";
                                }
                                catch(e) {

                                }

                                let special_offer = document.getElementById("special_offers").value;
                                const match = special_offer.match(/(\d+)\s*years/i);
                                let years = 0

                                if (match) {
                                    years = parseInt(match[1], 10);
                                    tenorYears.value = years;
                                }

                                

                                hideInstallmentInputs()
                                

                            } else {
                                // Re-enable
                                contractDate.disabled = false;
                                contractDateDisplay.disabled = false;
                                contractDateDisplay.style.backgroundColor = "";
                                contractDateDisplay.style.cursor = "pointer";

                                tenorYears.disabled = false;
                                currency.disabled = false;

                                paymentScheme.style.display = "flex"

                                basePaymentFreq.style.pointerEvents = "";
                                basePaymentFreq.style.opacity = 1;
                                basePaymentFreq.style.backgroundColor = "";
                                basePaymentFreq.style.cursor = "pointer";
                                showInstallmentInputs()
                            }
                        }
                    </script>



                {% endif %}

        
                {% if project_web_config.show_payment_frequency %}
                    <div class="input-group">
                {% else %}
                    <div class="input-group" style="display:none;">
                {% endif %} 
                        <label for="payment_frequency">Payment Freq.</label>
                        <div class="custom-dropdown uniform-input">
                            <!-- Selected Option -->
                            <div 
                                id="base_payment_frequency" 
                                class="selected-option" 
                                onclick="toggleDropdown()"
                            >
                                {{ project_config.base_payment_frequency | capfirst }}
                            </div>
                            <!-- Dropdown Options -->
                            <ul class="dropdown-options">
                                <li data-value="Quarterly" {% if project_config.base_payment_frequency|lower == "quarterly" %}class="selected"{% endif %}>Quarterly</li>
                                <li data-value="Monthly" {% if project_config.base_payment_frequency|lower == "monthly" %}class="selected"{% endif %}>Monthly</li>
                                <li data-value="Semi-Annually" {% if project_config.base_payment_frequency|lower == "semi-annually" %}class="selected"{% endif %}>Semi-Annually</li>
                                <li data-value="Annually" {% if project_config.base_payment_frequency|lower == "annually" %}class="selected"{% endif %}>Annually</li>
                            </ul>
                        </div>
                    </div>

                {% if project_web_config.show_payment_scheme %}
                    <div class="input-group" id="payment-scheme">
                {% else %}
                    <div class="input-group" style="display:none;">
                {% endif %} 
                        <label for="payment_scheme">Payment Scheme</label>
                        <div class="custom-dropdown-2 uniform-input">
                            <!-- Selected Option -->
                            <div 
                                id="default_scheme" 
                                class="selected-option-2" 
                                onclick="toggleDropdown2()"
                            >
                                {{ project_config.default_scheme | capfirst }}
                            </div>
                            <!-- Dropdown Options -->
                            <ul class="dropdown-options">
                                {% if "Flat" in project_web_config.payment_schemes_to_show %}
                                    <li data-value="Flat" {% if project_config.default_scheme|lower == "Flat" %}class="selected"{% endif %}>Flat</li>
                                {% endif %}

                                {% if "Flat Back Loaded" in project_web_config.payment_schemes_to_show %}
                                    <li data-value="FlatBackLoaded" {% if project_config.default_scheme|lower == "FlatBackLoaded" %}class="selected"{% endif %}>Flat Back Loaded</li>
                                {% endif %}

                                {% if "Bullet" in project_web_config.payment_schemes_to_show %}
                                    <li data-value="Bullet" {% if project_config.default_scheme|lower == "Bullet" %}class="selected"{% endif %}>Bullet</li>
                                {% endif %}

                                {% if "Bullet Back Loaded" in project_web_config.payment_schemes_to_show %}
                                    <li data-value="BulletBackLoaded" {% if project_config.default_scheme|lower == "BulletBackLoaded" %}class="selected"{% endif %}>Bullet Back Loaded</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>



                

                 
        
        
                <div class="input-group" style="position: relative;">
                    <label for="contract_date_display">Reservation Date</label>
                    
                    <input 
                        type="date" 
                        id="contract_date" 
                        class="uniform-input" 
                        style="opacity: 0; position: absolute; bottom: 0; left: 0; height: 0; width: 100%; z-index: -1;"
                    >
                    
                    <input 
                        type="text" 
                        id="contract_date_display" 
                        class="uniform-input" 
                        placeholder="DD/MM/YYYY" 
                        readonly 
                        onclick="document.getElementById('contract_date').showPicker()"
                    >
                </div>

                <script>
                    document.addEventListener("DOMContentLoaded", function() {
                        const dateInput = document.getElementById("contract_date");
                        const textInput = document.getElementById("contract_date_display");

                        if(dateInput && textInput) {
                            dateInput.addEventListener("change", function() {
                                // When date is picked, format it to DD/MM/YYYY and set to text input
                                const val = this.value; // YYYY-MM-DD
                                if(val) {
                                    const [year, month, day] = val.split("-");
                                    textInput.value = `${day}/${month}/${year}`;
                                    
                                    // Trigger any existing change events if you have calculations relying on this
                                    // const event = new Event('change');
                                    // textInput.dispatchEvent(event);
                                }
                            });
                        }
                    });
                </script>


                
                


                {% if project_web_config.show_currecny %}
                    <div class="input-group">
                        <label for="currency">Currency</label>
                        <select id="currency" class="uniform-input"  style="text-align: center; text-align-last: center;">
                            <!-- Currency options will be populated by JavaScript -->
                        </select>
                    </div>

                {% else %}
                    <div class="input-group" style="display: none;">
                        <label for="currency">Currency</label>
                        <input id="currency">
                    </div>
                {% endif %}
                
                <script>
                // Global state (safe on window)
                window.selectedCurrencyRate = 1;
                window.selectedCurrencyName = "EGP";

                document.addEventListener("DOMContentLoaded", () => {
                    const currencySelect = document.getElementById("currency");
                    const basicPriceInput = document.getElementById("basic_price");
                    const finalPriceInput = document.getElementById("final_price");

                    const allowedCurrencies = [
                    "EGP", "USD", "EUR", "SAR", "AED", "KWD", "QAR", "BHD",
                    "OMR", "GBP", "JOD", "LYD", "MAD", "TND", "DZD", "LBP",
                    "TRY", "CAD", "AUD"
                    ];

                    // Populate dropdown
                    if (currencySelect) {
                    currencySelect.innerHTML = "";
                    allowedCurrencies.forEach(code => {
                        const option = document.createElement("option");
                        option.value = code;
                        option.textContent = code;
                        if (code === "EGP") option.selected = true;
                        currencySelect.appendChild(option);
                    });
                    }

                    // ---- Caching (important to avoid rate limits) ----
                    const CACHE_KEY = "fx_rates_base_EGP_v1";
                    const CACHE_TTL_MS = 12 * 60 * 60 * 1000; // 12h (FloatRates updates ~12h) :contentReference[oaicite:3]{index=3}

                    function readCache() {
                    try {
                        const raw = localStorage.getItem(CACHE_KEY);
                        if (!raw) return null;
                        const obj = JSON.parse(raw);
                        if (!obj?.ts || !obj?.rates) return null;
                        if (Date.now() - obj.ts > CACHE_TTL_MS) return null;
                        return obj.rates;
                    } catch {
                        return null;
                    }
                    }

                    function writeCache(rates) {
                    try {
                        localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), rates }));
                    } catch {}
                    }

                    // ---- Providers ----
                    async function fetchJson(url, timeoutMs = 8000) {
                    const ctrl = new AbortController();
                    const t = setTimeout(() => ctrl.abort(), timeoutMs);
                    try {
                        const res = await fetch(url, { signal: ctrl.signal });
                        if (!res.ok) throw new Error("HTTP " + res.status);
                        return await res.json();
                    } finally {
                        clearTimeout(t);
                    }
                    }

                    // 1) ExchangeRate-API Open Access (no key) :contentReference[oaicite:4]{index=4}
                    async function getRatesFromOpenER() {
                    const data = await fetchJson("https://open.er-api.com/v6/latest/EGP");
                    if (data?.result !== "success" || !data?.rates) throw new Error("OpenER bad payload");
                    return data.rates; // {USD:..., EUR:..., EGP:1, ...}
                    }

                    // 2) FloatRates fallback (base=EGP feed) :contentReference[oaicite:5]{index=5}
                    async function getRatesFromFloatRates() {
                    const data = await fetchJson("https://www.floatrates.com/daily/egp.json");
                    // data keys are lowercase codes, each item has alphaCode + rate :contentReference[oaicite:6]{index=6}
                    const rates = { EGP: 1 };
                    for (const k of Object.keys(data || {})) {
                        const item = data[k];
                        const code = item?.alphaCode;
                        const rate = Number(item?.rate);
                        if (code && Number.isFinite(rate)) rates[code] = rate;
                    }
                    return rates;
                    }

                    async function loadRatesBaseEGP() {
                    const cached = readCache();
                    if (cached) return cached;

                    // Try primary, then fallback
                    try {
                        const r1 = await getRatesFromOpenER();
                        writeCache(r1);
                        return r1;
                    } catch (e1) {
                        const r2 = await getRatesFromFloatRates();
                        writeCache(r2);
                        return r2;
                    }
                    }

                    // ---- Display + conversion ----
                    function roundDisplay(value, currencyCode) {
                    // Your old rounding to 1000 makes USD/EUR look crazy.
                    // Keep 1000-step only for EGP; use 10-step for others.
                    const step = (currencyCode === "EGP") ? 1000 : 10;
                    return Math.ceil(value / step) * step;
                    }

                    function getRawEgpPrice() {
                    // safer than parseFloat if Django prints commas
                    const s = String("{{ unit.interest_free_unit_price }}").replace(/,/g, "");
                    const n = Number(s);
                    return Number.isFinite(n) ? n : NaN;
                    }

                    function updateBasicPriceDisplay(rates) {
                    if (!basicPriceInput) return;

                    const rawEgp = getRawEgpPrice();
                    if (!Number.isFinite(rawEgp)) return;

                    const selected = currencySelect ? currencySelect.value : "EGP";
                    const rate = Number(rates?.[selected] ?? 1); // because base is EGP
                    const converted = rawEgp * rate;

                    const rounded = roundDisplay(converted, selected);
                    basicPriceInput.value = `${rounded.toLocaleString()} ${selected}`;
                    }

                    // ---- Init ----
                    (async () => {
                    try {
                        const rates = await loadRatesBaseEGP();

                        // Initial paint
                        updateBasicPriceDisplay(rates);

                        // Change handler
                        if (currencySelect) {
                        currencySelect.addEventListener("change", () => {
                            const target = currencySelect.value;
                            window.selectedCurrencyName = target;
                            window.selectedCurrencyRate = Number(rates?.[target] ?? 1);

                            // Trigger your existing recalcs
                            if (typeof generateInstallmentTable === "function") generateInstallmentTable();
                            if (typeof applyBordersToTable === "function") applyBordersToTable();
                            if (typeof sendInstallmentData === "function") sendInstallmentData();

                            updateBasicPriceDisplay(rates);

                            // Optional: final price display (if you have a global EGP final price)
                            // if (finalPriceInput && typeof final_price_egp !== "undefined") {
                            //   const convertedFinal = Number(final_price_egp) * window.selectedCurrencyRate;
                            //   finalPriceInput.value = `${roundDisplay(convertedFinal, target).toLocaleString()} ${target}`;
                            // }
                        });
                        }

                        // If discount depends on displayed price, call after rates load
                        if (typeof applyPriceDiscount === "function") applyPriceDiscount();

                    } catch (err) {
                        console.error("FX failed, fallback to EGP only:", err);
                        window.selectedCurrencyRate = 1;
                        if (basicPriceInput) {
                        const rawEgp = getRawEgpPrice();
                        if (Number.isFinite(rawEgp)) basicPriceInput.value = `${Math.ceil(rawEgp / 1000) * 1000} EGP`;
                        }
                    }
                    })();
                });
                </script>

                                  
            </div>

            <div class="group group-4">
                <div class="input-group">
                    <label for="delivery_date">Delivery Date</label>
                    <input type="text" name="delivery_date" id="delivery_date" value="{{ unit.development_delivery_date}}" readonly style="background-color: transparent; border: none; color: #000; font-weight: bold;text-align: left;" class="uniform-input">
                </div>

                {% if project_web_config.show_standerd_price %}

                    <div class="input-group">
                {% else %}
                    <div class="input-group" style="display: none;">
                
                {% endif %}
                        <label for="basic_price">Standerd Price</label>
                        <input type="text" name="basic_price" id="basic_price" readonly value="{{ unit.interest_free_unit_price}}"
                            style="background-color: transparent; border: none; color: #000; font-weight: bold; text-align: left;"
                            class="uniform-input">
                    </div>

                {% with user_groups=request.user.groups.all|join:"," %}
                    {% if "Sales" not in user_groups and "SalesHead" not in user_groups %}
                        {% if project_web_config.show_standerd_price %}
                            <div class="input-group" id="discount-input-group">
                                <label for="price_discount">Price Discount</label>
                                <div style="position: relative; display: inline-block;">
                                    <input type="number" name="price_discount" id="price_discount" 
                                        step="0.1" min="0" max="100" 
                                        placeholder="ex: 1"
                                        oninput="applyPriceDiscount()"
                                        style="text-align: center; width: 90px; padding-right: 25px;"
                                        class="uniform-input">
                                    <span style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); 
                                        color: #666; font-weight: bold; pointer-events: none;">
                                        %
                                    </span>
                                </div>
                            </div>

                            <div class="input-group" id="discounted-price-group" style="display: none;">
                                <label for="discounted_price">Discounted Price</label>
                                <input type="text" name="discounted_price" id="discounted_price" readonly
                                    style="background-color: transparent; border: none; color: #28a745; font-weight: bold; text-align: left;"
                                    class="uniform-input">
                            </div>
                        {% endif %}
                    {% endif %}
                {% endwith %}

                
                <div class="input-group">
                    <label for="final_price">Final Price</label>
                    <input type="text" name="final_price" id="final_price" readonly
                        style="background-color: transparent; border: none; color: #000; font-weight: bold; text-align: left;"
                        class="uniform-input">
                </div>


                
                    
                {% if project_web_config.show_discount %}
                    <div class="input-group">
                        <label for="percentage_change">Percentage Change</label>
                        <input type="text" name="percentage_change" id="percentage_change" readonly  style="background-color: transparent; border: none; color: red; font-weight: bold;text-align: left;" class="uniform-input">
                    </div>
                {% endif %}

                {% if project_web_config.show_additional_discount %}
                    <div class="input-group">
                        <label for="percentage_change">Additional Discount</label>
                        <input type="text" name="additional_discount" id="additional_discount" readonly  style="background-color: transparent; border: none; color: red; font-weight: bold;text-align: left;" class="uniform-input">
                    </div>
                {% endif %}


                {% if project_web_config.show_maintenance %}
                    <div class="input-group">
                        <label for="maintenance_fees">Maintenance Fees</label>
                        <input type="text" name="maintenance_fees" id="maintenance_fees" readonly style="background-color: transparent; border: none; color: #000; font-weight: bold;text-align: left;" class="uniform-input">
                    </div>                
                {% endif %}


                {% if project_web_config.show_gas %}
        
                    <div class="input-group">
                        <label for="gas_fees">Gas Fees</label>
                        <input type="text" name="gas_fees" id="gas_fees" readonly style="background-color: transparent; border: none; color: #000; font-weight: bold;text-align: left;" class="uniform-input">
                    </div> 
                {% endif %}
        
             
            </div>
        </div>
            
        <div class="button-container">
            
            {% with user_groups=request.user.groups.all|join:"," %}
                {% if "Sales" in user_groups  or "SalesHead" in user_groups%}         


                        <button type="button" class="submit-button" onclick="openHoldModal()" id="hold-button" style="
                                                                                                                        padding: 11px 26px; 
                                                                                                                        background-color: rgb(156, 156, 156); 
                                                                                                                        color: white; 
                                                                                                                        border: none; 
                                                                                                                        border-radius: 4px; 
                                                                                                                        cursor: pointer; 
                                                                                                                        font-size: 18px; 
                                                                                                                        height: fit-content; 
                                                                                                                        margin-top: auto;
                                                                                                                        transition: all 0.3s ease; 
                                                                                                                        margin-right: 25px;
                                                                                                                        width: 48%;
                                                                                                                        display: block;
                                                                                                                        "
                            onmouseover="this.style.backgroundColor='rgb(120, 120, 120)'; this.style.transform='scale(1.05)';"

                        onmouseout="this.style.backgroundColor='rgb(156, 156, 156)'; this.style.transform='scale(1)';">

                    

                            Hold
                        </button>
                            
                    <!-- Add Another Unit Button -->
                    <form id="addUnitForm" method="POST" action="{% url 'save_unit_to_session' %}" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="unit_code" value="{{ unit.unit_code }}">
                        <input type="hidden" name="payment_data" id="unit_payment_data_field">
                        <input type="hidden" name="payment_all_data" id="unit_all_data_field">
                        <input type="hidden" name="client_id" id="form_client_id"> <!-- üëà Add this -->
        
        
        
                        <!-- Change type to "button" and remove inline submit -->
                        <button type="button" id="addUnitBtn" data-bs-toggle="modal" data-bs-target="#clientIdModal"
                            onmouseover="this.style.backgroundColor='rgb(120, 120, 120)'; this.style.transform='scale(1.05)';"
                            onmouseout="this.style.backgroundColor='rgb(156, 156, 156)'; this.style.transform='scale(1)';">
                            
                                Save & Add
                        </button>
                    </form>
                {% endif %} 
            {% endwith %} 
                


            <!-- Export as PDF Button -->
            <button id="exportPdfButton" class="btn btn-primary" 
                style="
                padding: 11px 26px; 
                background-color: rgb(156, 156, 156); 
                color: white; 
                border: none; 
                border-radius: 4px; 
                cursor: pointer; 
                font-size: 18px; 
                height: fit-content; 
                margin-top: auto;
                transition: all 0.3s ease; 
                display: none;
                margin-right: 25px;
                width: 48%;
                "
                onmouseover="this.style.backgroundColor='rgb(120, 120, 120)'; this.style.transform='scale(1.05)';"
                onmouseout="this.style.backgroundColor='rgb(156, 156, 156)'; this.style.transform='scale(1)';"
                >
                    Save as PDF
            </button>
    
    
            <button id="exportExcelButton" class="btn btn-primary" style="
                                                                            padding: 11px 26px; 
                                                                            background-color: rgb(156, 156, 156); 
                                                                            color: white; 
                                                                            border: none; 
                                                                            border-radius: 4px; 
                                                                            cursor: pointer; 
                                                                            font-size: 18px; 
                                                                            height: fit-content; 
                                                                            margin-top: auto;
                                                                            transition: all 0.3s ease; 
                                                                            display: none;
                                                                            margin-right: 25px;
                                                                            width: 48%;
                                                                        "
                onmouseover="this.style.backgroundColor='rgb(120, 120, 120)'; this.style.transform='scale(1.05)';"
                onmouseout="this.style.backgroundColor='rgb(156, 156, 156)'; this.style.transform='scale(1)';">
                Save as Excel
            </button>

             <script>
                (function() {

                    function checkDp2(){
                        
                        try{

                            let a_raw= document.getElementById("dp_needed_percentage_2").innerHTML
                            a = parseFloat(a_raw);
                            let b = document.getElementById("dp_needed_amount_2").innerHTML
                            
                            if (b == 0 && a != 0){
                                showWelcomeToast()
                            }
                            
                        }
                        catch(e){
    
                        }
                    }

                    function showWelcomeToast() {
                        // 1. Create the toast element

                        const toast = document.createElement('div');
                        toast.textContent = "Please Erase D.P 1 ";

                        // 2. Apply all styling directly via JavaScript
                        Object.assign(toast.style, {
                            position: 'fixed',
                            bottom: '20px',
                            right: '20px',
                            minWidth: '200px',
                            backgroundColor: '#df1c1cff',
                            color: '#ffffff',
                            padding: '16px 24px',
                            borderRadius: '8px',
                            fontFamily: 'system-ui, -apple-system, sans-serif',
                            fontSize: '16px',
                            boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                            zIndex: '9999',
                            textAlign: 'center',
                            // Animation initial state
                            opacity: '0',
                            transform: 'translateY(20px)',
                            transition: 'opacity 0.5s ease, transform 0.5s ease'
                        });

                        // 3. Append to the document body
                        document.body.appendChild(toast);

                        // 4. Trigger the "Enter" animation
                        // We use a tiny timeout to ensure the DOM has updated with the initial state first
                        setTimeout(() => {
                            toast.style.opacity = '1';
                            toast.style.transform = 'translateY(0)';
                        }, 10);

                        // 5. Trigger the "Exit" animation after 5 seconds
                        setTimeout(() => {
                            toast.style.opacity = '0';
                            toast.style.transform = 'translateY(20px)';

                            // 6. Remove from DOM after the transition finishes (0.5s)
                            setTimeout(() => {
                                if (toast.parentNode) {
                                    toast.parentNode.removeChild(toast);
                                }
                            }, 500);
                        }, 4000);

                    }
                    
                    if (userCanEdit){
                        setInterval(checkDp2, 10000);
                    }
                    
                    // Note: setInterval waits 10s before the FIRST run. 
                    // If you want one to appear immediately on load, uncomment the line below:
                    // showWelcomeToast();
                })();
            </script>
            
    


            


            {% if user_company.erp_url_leads %}


                <!-- Client ID Modal -->
                <div class="modal fade" id="clientIdModal" tabindex="-1" aria-labelledby="clientIdModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="clientIdModalLabel">Choose Lead Name</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <label for="clientIdInput2" class="form-label" style="margin-bottom: 3%;">Lead Name:</label>
                    
                                <select id="clientIdInput2" style="width:100%; padding:8px; margin-top:5px; margin-bottom:10px;">
                                    <option value="">-- Select Lead --</option>
                                </select>

                                {% comment %} <input type="text" class="form-control" id="clientIdInput2" placeholder="Enter client ID"> {% endcomment %}
                                <div id="clientIdError" class="text-danger mt-2 d-none">Please Choose Client Name</div>
                            </div>
                                <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="submitClientIdBtn">Submit</button>
                            </div>
                        </div>
                    </div>
                </div>
            

            {% else %}

                <!-- Client ID Modal -->
                <div class="modal fade" id="clientIdModal" tabindex="-1" aria-labelledby="clientIdModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="clientIdModalLabel">Enter Client ID</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div id="clientIdError" class="text-danger mt-2 d-none">Please enter a client ID.</div>
                                <label for="clientIdInput2" class="form-label" style="margin-bottom: 3%;">Client ID:</label>
                                <input type="text" class="form-control" id="clientIdInput2" placeholder="Enter client ID">

                                <label for="clientPhoneInput2" class="form-label" style="margin-bottom: 3%;">Client Phone:</label>
                                <input type="text" class="form-control" id="clientPhoneInput2" placeholder="Enter client Phone Number">
                            </div>
                                <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="submitClientIdBtn">Submit</button>
                            </div>
                        </div>
                    </div>
                </div>

            {% endif %}
    
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const form = document.getElementById("addUnitForm");
            
                document.getElementById("submitClientIdBtn").addEventListener("click", function () {

                    if (isImpersonating) {
                        alert("Access Denied to the Admin");
                        return;
                    }
                    
                    let clientIdInput = null;
                    let clientId = null;
                    let clientPhoneNumber2 = null;
                    let clientName = null;
                    let errorDiv = null;
                    errorDiv = document.getElementById("clientIdError");
                    
                    try{
                        clientIdInput = document.getElementById("clientIdInput2");
                        clientId = clientIdInput.value.trim();
                        clientName = clientIdInput.options[clientIdInput.selectedIndex]?.dataset.name;
                        clientPhoneNumber2 = clientIdInput.options[clientIdInput.selectedIndex]?.dataset.phone;
                    }
                    catch(e){
                        clientId = document.getElementById("clientIdInput2").value;
                        clientPhoneNumber2 = document.getElementById("clientPhoneInput2").value;

                        if (!clientPhoneNumber2) {
                            errorDiv.classList.remove("d-none");
                            return;
                        }
                    }

                    if (!clientId) {
                        errorDiv.classList.remove("d-none");
                        return;
                    }
            
                    errorDiv.classList.add("d-none");
            
                    // Collect table data
                    const rows = document.querySelectorAll("#installmentTableContainer tbody tr");
                    let paymentData = [];

                    if(!hasMaintenance && !hasGas){
                        rows.forEach(row => {
                            const cells = row.querySelectorAll("td");
                            
                            const data = {
                                type: cells[0]?.textContent.trim(),
                                date: cells[1]?.textContent.trim(),
                                installment: cells[3]?.textContent.trim(),
                                amount: cells[4]?.textContent.trim(),
                            };
    
                            paymentData.push(data);
                        });
                    }
                    else if(hasMaintenance && !hasGas){
                        rows.forEach(row => {
                            const cells = row.querySelectorAll("td");
                            
                            const data = {
                                type: cells[0]?.textContent.trim(),
                                date: cells[1]?.textContent.trim(),
                                installment: cells[3]?.textContent.trim(),
                                amount: cells[4]?.textContent.trim(),
                                maintenance: cells[6]?.textContent.trim(),
                            };
    
                            paymentData.push(data);
                        });
                    }
                    else if(!hasMaintenance && hasGas){
                        rows.forEach(row => {
                            const cells = row.querySelectorAll("td");
                            
                            const data = {
                                type: cells[0]?.textContent.trim(),
                                date: cells[1]?.textContent.trim(),
                                installment: cells[3]?.textContent.trim(),
                                amount: cells[4]?.textContent.trim(),
                                gas: cells[6]?.textContent.trim(),
                            };
    
                            paymentData.push(data);
                        });
                    }
                    else if(hasMaintenance && hasGas){
                        rows.forEach(row => {
                            const cells = row.querySelectorAll("td");
                            
                            const data = {
                                type: cells[0]?.textContent.trim(),
                                date: cells[1]?.textContent.trim(),
                                installment: cells[3]?.textContent.trim(),
                                amount: cells[4]?.textContent.trim(),
                                maintenance: cells[6]?.textContent.trim(),
                                gas: cells[7]?.textContent.trim(),
                            };
    
                            paymentData.push(data);
                        });
                    }
            
                    

                    if (dp_temp == 0){
                        dp_temp = getBaseDp()
                    }

                    let payments = []
                    if (hasMultipleDp){
                        payments = [dp_temp, dp_temp_2, ...realPercentage];
                    }
                    else{
                        payments = [dp_temp, ...realPercentage];
                    }
                    // Build full payload


                    let temp = 0
                    let temp_3 = 0;
                    if (contract_date != -1) temp = new Date(contract_date);
                    
                    let newDates = [];

                    if (hasMultipleDp){
                        if (contract_date_2 != -1) {
                            temp_3 = new Date(contract_date_2);
                            temp_3.setMonth(temp_3.getMonth() + periodBetweenDPs);
                        }
                        newDates = [temp, temp_3].concat(dates)
                    }
                    else{
                        newDates = [temp].concat(dates)
                    }


                    let final_maintenance = ""
                    let final_gas = ""
                    if(hasMaintenance){
                        if (hasMultipleDp){
                            final_maintenance = ["", "",...maintenance_fees];
                        }
                        else{
                            final_maintenance = ["", ...maintenance_fees];
                        }
                    }
                    else{
                        final_maintenance = null
                    }

                    if(hasGas){
                        if (hasMultipleDp){
                            final_gas = ["","", ...gas_fees];
                        }
                        else{
                            final_gas = ["", ...gas_fees];
                        }
                        
                    }
                    else{
                        final_gas = null
                    }

            
                    let unitCode = document.getElementById("unit_code").value;
                    let tenor_years = document.getElementById("tenor_years").value;
                    let project_name = "{{ project.name|default:'' }}";
                    let companyName = window.companyName; // Make sure this is defined globally
                    let codeOnly = unitCode.replace("_" + companyName, "");
                    let basic_price_value = Number(document.getElementById("basic_price").value.replace(/\D/g, ""));
                    let payload = {}
                    try{
                        if(hasMaintenance && hasGas){
                            // Example payload ‚Äî expand with more fields later
                            payload = {
                                client_name: clientName,
                                client_id: clientId,
                                client_phone_number : clientPhoneNumber2,
                                timestamp: new Date().toISOString(),
                                user_email: "{{ request.user.email }}",  // example user field
                                payments: payments,
                                maintenance_fees: final_maintenance,
                                gas_fees: final_gas,
                                final_price: final_price,
                                basic_price: basic_price_value,
                                dates: newDates,
                                companyName: companyName,
                                unitCode: codeOnly,
                                tenor_years: tenor_years,
                                project_name: project_name,
                                selected_currency_name : document.getElementById("currency").value
                            };
            
                        }
                        else if (!hasMaintenance && !hasGas){
                            // Example payload ‚Äî expand with more fields later
                            payload = {
                                client_name: clientName,
                                client_phone_number : clientPhoneNumber2,
                                client_id: clientId,
                                timestamp: new Date().toISOString(),
                                user_email: "{{ request.user.email }}",  // example user field
                                payments: payments,
                                final_price: final_price,
                                basic_price: basic_price_value,
                                dates: newDates,
                                companyName: companyName,
                                unitCode: codeOnly,
                                tenor_years: tenor_years,
                                project_name: project_name,
                                selected_currency_name : document.getElementById("currency").value
                            };
            
                        }
                        else if (!hasMaintenance && hasGas){
                            // Example payload ‚Äî expand with more fields later
                            payload = {
                                client_name: clientName,
                                client_phone_number : clientPhoneNumber2,
                                client_id: clientId,
                                timestamp: new Date().toISOString(),
                                user_email: "{{ request.user.email }}",  // example user field
                                payments: payments,
                                gas_fees: final_gas,
                                final_price: final_price,
                                basic_price: basic_price_value,
                                dates: newDates,
                                companyName: companyName,
                                unitCode: codeOnly,
                                tenor_years: tenor_years,
                                project_name: project_name,
                                selected_currency_name : document.getElementById("currency").value
                            };
            
                        }
                        else if (hasMaintenance && !hasGas){
                            // Example payload ‚Äî expand with more fields later
                            payload = {
                                client_name: clientName,
                                client_phone_number : clientPhoneNumber2,
                                client_id: clientId,
                                timestamp: new Date().toISOString(),
                                user_email: "{{ request.user.email }}",  // example user field
                                payments: payments,
                                maintenance_fees: final_maintenance,
                                final_price: final_price,
                                basic_price: basic_price_value,
                                dates: newDates,
                                companyName: companyName,
                                unitCode: codeOnly,
                                tenor_years: tenor_years,
                                project_name: project_name,
                                selected_currency_name : document.getElementById("currency").value
                            };
            
                        }
                    }
                    catch(e){
                        if(hasMaintenance && hasGas){
                            // Example payload ‚Äî expand with more fields later
                            payload = {
                                client_id: clientId,
                                client_phone_number : clientPhoneNumber2,
                                timestamp: new Date().toISOString(),
                                user_email: "{{ request.user.email }}",  // example user field
                                payments: payments,
                                maintenance_fees: final_maintenance,
                                gas_fees: final_gas,
                                final_price: final_price,
                                basic_price: basic_price_value,
                                dates: newDates,
                                companyName: companyName,
                                unitCode: codeOnly,
                                tenor_years: tenor_years,
                                project_name: project_name,
                                selected_currency_name : document.getElementById("currency").value
                            };
            
                        }
                        else if (!hasMaintenance && !hasGas){
                            // Example payload ‚Äî expand with more fields later
                            payload = {
                                client_id: clientId,
                                client_phone_number : clientPhoneNumber2,
                                timestamp: new Date().toISOString(),
                                user_email: "{{ request.user.email }}",  // example user field
                                payments: payments,
                                final_price: final_price,
                                basic_price: basic_price_value,
                                dates: newDates,
                                companyName: companyName,
                                unitCode: codeOnly,
                                tenor_years: tenor_years,
                                project_name: project_name,
                                selected_currency_name : document.getElementById("currency").value
                            };
            
                        }
                        else if (!hasMaintenance && hasGas){
                            // Example payload ‚Äî expand with more fields later
                            payload = {
                                client_id: clientId,
                                client_phone_number : clientPhoneNumber2,
                                timestamp: new Date().toISOString(),
                                user_email: "{{ request.user.email }}",  // example user field
                                payments: payments,
                                gas_fees: final_gas,
                                final_price: final_price,
                                basic_price: basic_price_value,
                                dates: newDates,
                                companyName: companyName,
                                unitCode: codeOnly,
                                tenor_years: tenor_years,
                                project_name: project_name,
                                selected_currency_name : document.getElementById("currency").value
                            };
            
                        }
                        else if (hasMaintenance && !hasGas){
                            // Example payload ‚Äî expand with more fields later
                            payload = {
                                client_id: clientId,
                                client_phone_number : clientPhoneNumber2,
                                timestamp: new Date().toISOString(),
                                user_email: "{{ request.user.email }}",  // example user field
                                payments: payments,
                                maintenance_fees: final_maintenance,
                                final_price: final_price,
                                basic_price: basic_price_value,
                                dates: newDates,
                                companyName: companyName,
                                unitCode: codeOnly,
                                tenor_years: tenor_years,
                                project_name: project_name,
                                selected_currency_name : document.getElementById("currency").value
                            };
            
                        }
                    }
                    
                    
                    // Set hidden inputs
                    document.getElementById("unit_payment_data_field").value = JSON.stringify(paymentData);
                    document.getElementById("unit_all_data_field").value = JSON.stringify(payload);
                    document.getElementById("form_client_id").value = clientId;            
                    // Submit the form
                    form.submit();
                    
                    console.log(payload)
                });
            });
        </script>
        
          
        </div>

        <!-- Installment Table Container -->
    
        <div id="installmentTableContainer" style="display: none;">
        <div class="scrollable-table-container">
            <table class="installment-table" style="margin-top: 2.5%;">
                <thead>
                    <tr>
                        <th draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" style="max-width: 175px; border: 1px solid #ccc; text-align: center;"></th>
                        <th draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" style="max-width: 175px; border: 1px solid #ccc; text-align: center;">Date</th>
                        <th draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" style="max-width: 175px; border: 1px solid #ccc; text-align: center;">Inputs</th>
                        <th draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" style="max-width: 175px; border: 1px solid #ccc; text-align: center;">Amount</th>
                        <th draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" style="max-width: 175px; border: 1px solid #ccc; text-align: center;">Installment</th>
                        <th draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" style="max-width: 175px; border: 1px solid #ccc; text-align: center;">Cumulative</th>
                        {% if project_web_config.show_maintenance %}
                            <th draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" style="max-width: 175px; border: 1px solid #ccc; text-align: center;">Maintenance</th>
                        {% endif %}

                        {% if project_web_config.show_gas %}
                            <th draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" style="max-width: 175px; border: 1px solid #ccc; text-align: center;">Gas Payments</th> 
                        {% endif %}
                        
                    </tr>
                </thead>
<tbody>
    
    {# LOGIC: Show Multiple DP rows only if configured AND user is NOT restricted #}
    {% if project_web_config.has_multiple_dp %}
        
        {% if project_web_config.one_dp_for_sales and is_restricted_sales_user %}
            <tr id="first-row">
                <td style="max-width: 175px; border: 1px solid #ccc">D.P 1</td>
                <td id="dp_date" style="max-width: 175px; border: 1px solid #ccc"></td>
                {# base_dp here will contain the sum (dp1+dp2) from backend calculation #}
                <td style="max-width: 175px; border: 1px solid #ccc"><input type="number" name="dp" id="dp" step="any" value="{{ base_dp }}" style="max-width:35px; background-color:#eaeaea;">%</td>
                <td style="max-width: 175px;" id="dp_needed_amount_container"><span id="dp_needed_amount"></span></td>
                <td style="max-width: 175px;" id="dp_needed_percentage_container"><span id="dp_needed_percentage"></span></td>
                <td style="max-width: 175px;" id="dp_needed_percentage_cumulative_container"><span id="dp_needed_percentage_cumulative"></span></td>
                {% if project_web_config.show_maintenance %}
                    <td id="dp_maintenance" style="max-width: 175px;"><span id="dp_needed_maintenance"></span></td>
                {% endif %}
                {% if project_web_config.show_gas %}
                    <td id="dp_gas" style="max-width: 175px;"><span id="dp_needed_gas"></span></td> 
                {% endif %}
            </tr>

        {% else %}
            <tr id="first-row">
                <td style="max-width: 175px; border: 1px solid #ccc">D.P 1</td>
                <td id="dp_date" style="max-width: 175px; border: 1px solid #ccc"></td>
                <td style="max-width: 175px; border: 1px solid #ccc"><input type="number" name="dp" id="dp" step="any" value="{{ half_base_dp }}" style="max-width:35px; background-color:#eaeaea;">%</td>
                <td style="max-width: 175px;" id="dp_needed_amount_container"><span id="dp_needed_amount"></span></td>
                <td style="max-width: 175px;" id="dp_needed_percentage_container"><span id="dp_needed_percentage"></span></td>
                <td style="max-width: 175px;" id="dp_needed_percentage_cumulative_container"><span id="dp_needed_percentage_cumulative"></span></td>
                {% if project_web_config.show_maintenance %}
                    <td id="dp_maintenance" style="max-width: 175px;"><span id="dp_needed_maintenance"></span></td>
                {% endif %}
                {% if project_web_config.show_gas %}
                    <td   id="dp_gas" style="max-width: 175px;"><span id="dp_needed_gas"></span></td> 
                {% endif %}
            </tr>

            <tr id="second-row">
                <td style="max-width: 175px; border: 1px solid #ccc">D.P 2</td>
                <td id="dp_date_2" style="max-width: 175px; border: 1px solid #ccc"></td>
                <td style="max-width: 175px; border: 1px solid #ccc" id="dp_2_container"><input type="number" name="dp_2" id="dp_2" step="any" value="{{ half_base_dp}}" style="max-width:35px; background-color:#eaeaea;">%</td>
                <td style="max-width: 175px;" id="dp_needed_amount_container_2"><span id="dp_needed_amount_2"></span></td>
                <td style="max-width: 175px;" id="dp_needed_percentage_container_2"><span id="dp_needed_percentage_2"></span></td>
                <td style="max-width: 175px;" id="dp_needed_percentage_cumulative_container_2"><span id="dp_needed_percentage_cumulative_2"></span></td>
                {% if project_web_config.show_maintenance %}
                    <td id="dp_maintenance_2" style="max-width: 175px;"><span id="dp_needed_maintenance_2"></span></td>                    
                {% endif %}
                {% if project_web_config.show_gas %}
                    <td  id="dp_gas_2" style="max-width: 175px;"><span id="dp_needed_gas_2"></span></td>                   
                {% endif %}
            </tr>
        {% endif %}

    {% else %}
        <tr id="first-row">
            <td style="max-width: 175px; border: 1px solid #ccc">D.P 1</td>
            <td id="dp_date" style="max-width: 175px; border: 1px solid #ccc"></td>
            <td style="max-width: 175px; border: 1px solid #ccc"><input type="number" name="dp" id="dp" step="any" value="{{ base_dp }}" style="max-width:35px; background-color:#eaeaea;">%</td>
            <td style="max-width: 175px;" id="dp_needed_amount_container"><span id="dp_needed_amount"></span></td>
            <td style="max-width: 175px;" id="dp_needed_percentage_container"><span id="dp_needed_percentage"></span></td>
            <td style="max-width: 175px;" id="dp_needed_percentage_cumulative_container"><span id="dp_needed_percentage_cumulative"></span></td>
            {% if project_web_config.show_maintenance %}
                <td id="dp_maintenance" style="max-width: 175px;"><span id="dp_needed_maintenance"></span></td>
            {% endif %}
            {% if project_web_config.show_gas %}
                <td   id="dp_gas" style="max-width: 175px;"><span id="dp_needed_gas"></span></td> 
            {% endif %}
        </tr>
    {% endif %}

    <tbody id="installmentTableBody">
        </tbody>
</tbody>
            </table>
        </div>
    
    </div>

        <span id="base_dp_init" class="hidden">{{base_dp}}</span>
            
        <!-- Result Table Container -->
        <div id="resultTableContainer" >
            <table class="results-table">
                <tr style="display:none;">
                    <td><pre id="calculated_pmt_percentages"></pre></td>
                </tr>
                <tr style="display:none;">
                    <td id="delivery_payment_index">-</td>
                </tr>
                <tr style="display:none;">
                    <td id="new_npv">-</td>
                </tr>
                <tr style="display:none;">
                    <td id="percentage_change">-</td>
                </tr>
                <tr style="display:none;">
                    <td id="price_with_interest">-</td>
                </tr>
            </table>
        </div>

        <!-- Hidden Fields -->
        <input type="hidden" id="unit_base_price" name="unit_base_price" value="{{ unit.interest_free_unit_price }}">
        <input type="hidden" id="unit_base_price_original" value="{{ unit.interest_free_unit_price }}">
        <input type="hidden" id="unit_code" name="unit_code" value="{{ unit.unit_code }}">
        <input type="hidden" id="unit_maintenance_value" name="unit_maintenance_value" value="{{ unit.maintenance_percent }}">
        <input type="hidden" id="unit_contract_date" name="unit_contract_date" value="{{ unit.contract_date }}">
        <input type="hidden" id="project_config_interest_rate" name="project_config_interest_rate" value="{{ project_config.interest_rate }}">
        <input type="hidden" id="project_config_base_dp" name="project_config_base_dp" value="{{ project_config.base_dp }}">
        <input type="hidden" id="project_config_base_tenor" name="project_config_base_tenor" value="{{ project_config.base_tenor_years }}">
        <input type="hidden" id="project_config_max_tenor" name="project_config_max_tenor" value="{{ project_config.max_tenor_years }}">
        <input type="hidden" id="project_config_payment_frequency" name="project_config_payment_frequency" value="{{ project_config.base_payment_frequency }}">
        <input type="hidden" id="project_config_default_scheme" name="project_config_default_scheme" value="{{ project_config.default_scheme }}">
        <input type="hidden" id="project_config_static_npv" name="project_config_static_npv" value="{{ project_config.use_static_base_npv }}">
        <input type="hidden" id="project_constraints_dp_min" name="project_constraints_dp_min" value="{{ project_constraints.dp_min }}">
        <input type="hidden" id="project_constraints_max_discount" name="project_constraints_max_discount" value="{{ project_constraints.max_discount }}">
        <input type="hidden" id="currency_rate" name="currency_rate">
        <input type="hidden" id="base_npv_term_period" name="base_npv_term_period" value="{{ base_npv.term_period }}">
        <input type="hidden" id="delivery_date" name="delivery_date" value="{{ unit.development_delivery_date }}">
        <input type="hidden" id="project_config_id" name="project_config_id" value="{{ project_config.id }}">
        <input type="hidden" id="base_npv_npv_value" name="base_npv_npv_value" value="{{ base_npv.npv_value }}">
        <input type="hidden" id="installmentData" name="installment_data" value="[]">
        
{% elif project_query %}
    <p class="error-message">No project found with the name "{{ project_query }}"</p>
{% endif %}

    <script>
        {% if user_company.erp_url_leads %}
            let isCompanyERPUnits = true
            
                clients = [
                    // Example data; replace with Django context in your real case
                    // { ID: 1, Name: "John Smith" },
                    // { ID: 2, Name: "Sarah Johnson" },
                    {% for client in clients %}
                    { ID: "{{ client.ID }}", Name: "{{ client.Name }}", PhoneNumber: "{{client.PhoneNumber}}"},
                    {% endfor %}
                ];
            
                const clientInput = document.getElementById("clientInput");
                const clientSuggestions = document.getElementById("clientSuggestions");
                const clientDropdownArrow = document.getElementById("clientDropdownArrow");
            
                function renderClientSuggestions(list) {
                    clientSuggestions.innerHTML = '';
                    list.forEach(client => {
                        const li = document.createElement('li');
                        li.textContent = `${client.Name} ${client.PhoneNumber}`;
                        li.style.padding = '8px';
                        li.style.cursor = 'pointer';
                        li.dataset.clientId = client.ID;
            
                        li.addEventListener('click', () => {
                            clientInput.value = client.Name;
                            clientInput.dataset.clientId = client.ID;  // store ID for submission
                            clientInput.dataset.clientPhone = client.PhoneNumber;
                            clientSuggestions.style.display = 'none';
                        });
            
                        clientSuggestions.appendChild(li);
                    });
                    clientSuggestions.style.display = 'block';
                }
            
                clientInput.addEventListener('input', () => {
                    const query = clientInput.value.toLowerCase();
                    if (query.length === 0) {
                        clientSuggestions.style.display = 'none';
                        return;
                    }
            
                    const filtered = clients.filter(c => c.Name.toLowerCase().includes(query));

                    if (filtered.length > 0) {
                        renderClientSuggestions(filtered);
                    } else {
                        clientSuggestions.style.display = 'none';
                    }

                });
            
                clientDropdownArrow.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (clientSuggestions.style.display === 'block') {
                        clientSuggestions.style.display = 'none';
                    } else {
                        renderClientSuggestions(clients);
                    }
                });
            
                document.addEventListener('click', function (e) {
                    if (e.target !== clientInput && e.target !== clientDropdownArrow) {
                        clientSuggestions.style.display = 'none';
                    }
                });
            
                // Example access: clientInput.dataset.clientId for submitting selected lead
                
                

            document.addEventListener("DOMContentLoaded", function () {
                const clientsSelect = document.getElementById("clientIdInput2");

                if (clientsSelect) { 
                    clients.forEach(client => {
                        const option = document.createElement("option");
                        option.value = client.ID;
                        
                        // Visual text (Still shows "Name + Phone")
                        option.textContent = `${client.Name} ${client.PhoneNumber}`; 
                        
                        // --- UPDATED LINES ---
                        option.dataset.phone = client.PhoneNumber; 
                        option.dataset.name = client.Name; // Store pure name here
                        // ---------------------

                        clientsSelect.appendChild(option);
                    });
                }
            });


            

        {% else %}
            let isCompanyERPUnits = false
        {% endif %}

        
        
    </script>

    {% comment %} <script>
        document.addEventListener("DOMContentLoaded", function () {
            const unitCodeInput = document.getElementById("unitCodeSearch");
            const projectDropdown = document.getElementById("projectName");
            const searchButton = document.querySelector("form#searchForm button[type='submit']");
            
            const navbarLeftItems = document.getElementById("navbar-left-items");
            // ‚úÖ Reset input values on page load
            if (unitCodeInput) unitCodeInput.value = "";
            if (projectDropdown) projectDropdown.value = "";
            
            // ‚úÖ Hide the search button initially
            if (searchButton) searchButton.style.display = "none";
        
            // ‚úÖ Toggle search button visibility based on unit code input
            unitCodeInput.addEventListener("input", function () {
                if (this.value.trim()) {
                    searchButton.style.display = "inline-block";
                    //document.getElementById("PoweredBy").style.marginLeft = "81%"
                    if (window.innerWidth <= 768) { // üëà Example: only apply if screen width ‚â§ 768px
                        document.querySelectorAll(".img-div").forEach(div => div.style.marginLeft = "-109%");
                        const navbarLeftItems = document.getElementById("navbar-left-items");
                        //navbarLeftItems.style.marginRight = "150px";
                }}                
                 else {
                    searchButton.style.display = "none";
                    const navbarLeftItems = document.getElementById("navbar-left-items");
                       // navbarLeftItems.style.marginRight = "32px";
                    //document.getElementById("PoweredBy").style.marginLeft = "60%"
                }
            });
        });
    </script>
     {% endcomment %}


    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const unitCodeInput = document.getElementById("unitCodeSearchNew");
            const projectDropdown = document.getElementById("projectName");
            const searchButton = document.querySelector("button[type='submit']");
        
            // ‚úÖ Clear values on page load
            if (unitCodeInput) unitCodeInput.value = "";
            if (projectDropdown) projectDropdown.value = "";
        
            // ‚úÖ Hide search button initially
            if (searchButton) searchButton.style.display = "none";
        
            // ‚úÖ Show button only if unit code is entered

            try{
                unitCodeInput.addEventListener("input", function () {
                    if (this.value.trim()) {
                        searchButton.style.display = "inline-block";
                        //document.getElementById("PoweredBy").style.marginLeft = "81%"
                        if (window.innerWidth <= 768) { // üëà Example: only apply if screen width ‚â§ 768px
                            document.querySelectorAll(".img-div").forEach(div => div.style.marginLeft = "-109%");
                            const navbarLeftItems = document.getElementById("navbar-left-items");
                            //navbarLeftItems.style.marginRight = "150px";
                        }
                    } else {
                        searchButton.style.display = "none";
                       // const navbarLeftItems = document.getElementById("navbar-left-items");
                            //navbarLeftItems.style.marginRight = "32px";
                        //document.getElementById("PoweredBy").style.marginLeft = "60%"
    
                    }
                });
            }
            catch(e){

            }
        });
        

        document.addEventListener("DOMContentLoaded", function () {
            const unitCodeInput = document.getElementById("unitCodeSearchNew");
            const searchButton = document.getElementById("SearchButton")

            // Initially hide the search button if input is empty

            try{
                searchButton.style.display = unitCodeInput.value.trim() ? "inline-block" : "none";
            }
            catch(e){}

            try{
                unitCodeInput.addEventListener("input", function () {
                    if (this.value.trim()) {
                        searchButton.style.display = "inline-block";
                        //document.getElementById("PoweredBy").style.marginLeft = "81%"
                        if (window.innerWidth <= 768) { // üëà Example: only apply if screen width ‚â§ 768px
                            document.querySelectorAll(".img-div").forEach(div => div.style.marginLeft = "-109%");
                            const navbarLeftItems = document.getElementById("navbar-left-items");
                           // navbarLeftItems.style.marginRight = "150px";
                        }
    
                    } else {
                        searchButton.style.display = "none";
                        //const navbarLeftItems = document.getElementById("navbar-left-items");
                        //    navbarLeftItems.style.marginRight = "32px";
                        //document.getElementById("PoweredBy").style.marginLeft = "60%"
    
                    }
                });
            }
            catch(e){}

        });
    </script>


    <script>
        var unitCodeInHold= document.getElementById("unit-code-in-hold")
        var submitDataUrl = "{% url 'submit_data' %}";
        var csrfToken = "{{ csrf_token }}";
        var companyName = "{{ project.company }}";
        var userName = "{{user.email}}"; // Fetch dynamically if available
        var fullName = "{{user.full_name}}"; // Fetch dynamically if available
        let exchangeRates = {};      // Will hold EGP-based rates
        let selectedCurrency = "EGP";
        let baseFinalPriceEGP = 0;   // Will store roundedPrice in EGP
        let special_offers_exist = false


        try {
            clients = JSON.parse(`{{ clients|safe }}`);
        } catch (error) {
            clients = [];
        }
        let allProjects = [];
        let realPercentage = []
        let dates = []
        let hasMaintenance = false
        let hasCurrency = false
        let periodBetweenDPs = 0
        let periodBetweenDPandInstallment = 0
        let hasAdditionalDiscount = false
        let global_base_dp = 0

        try {
            // global_base_dp = Number(document.getElementById("project_config_base_dp").value) * 100;
        }
        catch (e){

        }

        {% if special_offers %}
            special_offers_exist = true
        {% endif %}


        {% if project_web_config.show_maintenance %}
             hasMaintenance = true
        {% endif %}


        let hasGas = false
        {% if project_web_config.show_gas %}
             hasGas = true
        {% endif %}

        {% if project_web_config.show_currecny %}
            hasCurrency = false
        {% endif %}


        {% if project_web_config.show_additional_discount %}
            hasAdditionalDiscount = true
        {% endif %}




        let hasMultipleDp = false

        let isClientUser = {{ is_client_user|yesno:"true,false" }};
        let userCanEditJS = {{ user_can_edit|yesno:"true,false" }};
        let userCanChangeYearsJS = {{ user_can_change_years|yesno:"true,false" }};
        
        

        // These will now render as true/false directly
        let isRestrictedSalesUser = {{ is_restricted_sales_user|yesno:"true,false" }};

        // --- UPDATED LOGIC FOR HAS MULTIPLE DP ---
        {% if project_web_config.has_multiple_dp %}
            hasMultipleDp = true;
            periodBetweenDPs = {{ project_web_config.period_between_DPs }};
            periodBetweenDPandInstallment = {{ project_web_config.period_between_DP_and_intsallment }};

            // Check if we need to force Single DP
            {% if project_web_config.one_dp_for_sales %}
                if (isRestrictedSalesUser) {
                    hasMultipleDp = false;
                    // Note: Date logic automatically adjusts because getContractDate checks hasMultipleDp
                }
            {% endif %}

        {% endif %}


        



        let maintenance_fees = []
        let gas_fees = [] 

        if(hasMaintenance){
            maintenance_fees = []
        }

        if(hasGas){
            gas_fees = [] 
        }
        
        let final_price  = 0
        let contract_date  = 0
        let contract_date_2  = 0
        let dp_temp = 0
        let dp_temp_2 = 0
        let dp_maintenance_temp = 0
        let dp_gas_temp = 0



        if(hasMaintenance){
            dp_maintenance_temp = 0
        }

        if(hasGas){
            dp_gas_temp = 0
        }

        //
        let is_not_native_company = "{{is_not_native_company}}"
        // console.log(clients)
        try {
            allProjects = {{ project_data|safe }};
        } catch (error) {
            console.error("Failed to load project_data from Django context:", error);
            allProjects = [];  // fallback to empty array
        }

        let draggedColIndex;

        function handleDragStart(e) {
            const th = e.target.closest("th");
            draggedColIndex = Array.from(th.parentNode.children).indexOf(th);
            e.dataTransfer.effectAllowed = "move";
        }

        function handleDragOver(e) {
            e.preventDefault(); // Necessary to allow drop
            e.target.closest("th").style.backgroundColor = "#f0f0f0";

            e.dataTransfer.dropEffect = "move";
        }

        function handleDrop(e) {
            e.preventDefault();
            const targetTh = e.target.closest("th");
            const targetColIndex = Array.from(targetTh.parentNode.children).indexOf(targetTh);
            document.querySelectorAll("th").forEach(th => th.style.backgroundColor = "");

            if (draggedColIndex === targetColIndex) return;

            reorderColumns(draggedColIndex, targetColIndex);
        }


        function reorderColumns(fromIndex, toIndex) {
            const table = document.querySelector(".installment-table");
            const rows = Array.from(table.rows);
        
            rows.forEach(row => {
                const cells = Array.from(row.children);
                if (cells.length <= Math.max(fromIndex, toIndex)) return;
        
                const cellToMove = cells[fromIndex];
                const referenceCell = cells[toIndex];
        
                if (fromIndex < toIndex) {
                    referenceCell.after(cellToMove);
                } else {
                    referenceCell.before(cellToMove);
                }
            });
        }

        function openHoldModal() {
            document.getElementById("holdModal").style.display = "block";
            let error = document.getElementById("id-error")
            error.style.display = "none";
            let unitCode = document.getElementById("unit_code").value;

            // Remove the companyName and the first underscore
            let codeOnly = unitCode.replace("_" + companyName, "");
            unitCodeInHold.innerHTML = codeOnly
        }
        
        function closeHoldModal() {
            document.getElementById("holdModal").style.display = "none";
            
            // Reset the UI state (Show buttons, hide loader) for next time
            const btnContainer = document.getElementById("holdModalButtons");
            const loaderContainer = document.getElementById("holdModalLoading");
            if(btnContainer) btnContainer.style.display = "block"; 
            if(loaderContainer) loaderContainer.style.display = "none";

            try {
                document.getElementById("clientIdInput").value = "";
            } catch (e) {}
        }
        
        function submitHold() {

            if (isImpersonating) {
                alert("Access Denied to the Admin");
                return;
            }
            let clientInput = null
            let clientId = null
            let clientName = null
            let clientPhoneNumber = null
            
            try{
                
                clientInput = document.getElementById("clientInput");
                clientId = clientInput.dataset.clientId;
                clientName = clientInput.value.trim();

                
                if (!clientId) {
                    const error = document.getElementById("client-error");
                    error.style.display = "block";
                    return;
                }

                console.log("okkkkkkkk")
            }
            catch(e){
                clientInput = document.getElementById("clientIdInput").value;
                console.log("not okkkkkkkk")
                
            }


            let payments = [];
            // Add dp_temp to the front of the realPercentage array
            
            if (dp_temp == 0){
                dp_temp = getBaseDp()
            }

            if (hasMultipleDp){
                payments = [dp_temp, dp_temp_2, ...realPercentage];
            }
            else{
                payments = [dp_temp, ...realPercentage];
            }

            let final_maintenance = ""
            let final_gas = ""
            if(hasMaintenance){
                if (hasMultipleDp){
                    final_maintenance = ["", "",...maintenance_fees];
                }
                else{
                    final_maintenance = ["", ...maintenance_fees];
                }
            }
            else{
                final_maintenance = null
            }

            if(hasGas){
                if (hasMultipleDp){
                    final_gas = ["","", ...gas_fees];
                }
                else{
                    final_gas = ["", ...gas_fees];
                }
            }
            else{
                final_gas = ""
            }

            
            let temp = 0
            let temp_3 = 0;
            if (contract_date != -1) temp = new Date(contract_date);
            
            let newDates = [];

            if (hasMultipleDp){
                if (contract_date_2 != -1) {
                    temp_3 = new Date(contract_date_2);
                    temp_3.setMonth(temp_3.getMonth() + periodBetweenDPs);
                }
                newDates = [temp, temp_3].concat(dates)
            }
            else{
                newDates = [temp].concat(dates)
            }

            
            
            let unitCode = document.getElementById("unit_code").value;
            let tenor_years = document.getElementById("tenor_years").value;
            let project_name = "";
            try {
                project_name = "{{ project.name }}";
            } catch (e) {
                project_name = "";
            }


            // Remove the companyName and the first underscore
            let codeOnly = unitCode.replace("_" + companyName, "");
            let payload = {}
            let basic_price_value = Number(document.getElementById("basic_price").value.replace(/\D/g, ""));
            let temp_payload = true

            if (clientName != null){


                clientPhoneNumber = clientInput.dataset.clientPhone

                
                document.getElementById("id-error").style.display = "none";


                if(hasMaintenance && hasGas){
                    // Example payload ‚Äî expand with more fields later
                    payload = {
                        client_name: clientName,
                        client_phone_number:clientPhoneNumber,
                        client_id: clientId,
                        timestamp: new Date().toISOString(),
                        user_email: "{{ request.user.email }}",  // example user field
                        payments: payments,
                        maintenance_fees: final_maintenance,
                        gas_fees: final_gas,
                        final_price: final_price,
                        basic_price: basic_price_value,
                        dates: newDates,
                        companyName: companyName,
                        unitCode: codeOnly,
                        tenor_years: tenor_years,
                        project_name: project_name,
                        selected_currency_name : document.getElementById("currency").value
                    };
    
                }
                else if (!hasMaintenance && !hasGas){
                    // Example payload ‚Äî expand with more fields later
                    payload = {
                        client_name: clientName,
                        client_phone_number:clientPhoneNumber,
                        client_id: clientId,
                        timestamp: new Date().toISOString(),
                        user_email: "{{ request.user.email }}",  // example user field
                        payments: payments,
                        final_price: final_price,
                        basic_price: basic_price_value,
                        dates: newDates,
                        companyName: companyName,
                        unitCode: codeOnly,
                        tenor_years: tenor_years,
                        project_name: project_name,
                        selected_currency_name : document.getElementById("currency").value
                    };
    
                }
                else if (!hasMaintenance && hasGas){
                    // Example payload ‚Äî expand with more fields later
                    payload = {
                        client_name: clientName,
                        client_phone_number:clientPhoneNumber,
                        client_id: clientId,
                        timestamp: new Date().toISOString(),
                        user_email: "{{ request.user.email }}",  // example user field
                        payments: payments,
                        gas_fees: final_gas,
                        final_price: final_price,
                        basic_price: basic_price_value,
                        dates: newDates,
                        companyName: companyName,
                        unitCode: codeOnly,
                        tenor_years: tenor_years,
                        project_name: project_name,
                        selected_currency_name : document.getElementById("currency").value
                    };
    
                }
                else if (hasMaintenance && !hasGas){
                    // Example payload ‚Äî expand with more fields later
                    payload = {
                        client_name: clientName,
                        client_phone_number:clientPhoneNumber,
                        client_id: clientId,
                        timestamp: new Date().toISOString(),
                        user_email: "{{ request.user.email }}",  // example user field
                        payments: payments,
                        maintenance_fees: final_maintenance,
                        final_price: final_price,
                        basic_price: basic_price_value,
                        dates: newDates,
                        companyName: companyName,
                        unitCode: codeOnly,
                        tenor_years: tenor_years,
                        project_name: project_name,
                        selected_currency_name : document.getElementById("currency").value
                    };
    
                }
            }
            else{

                

                if(hasMaintenance && hasGas){
                    // Example payload ‚Äî expand with more fields later
                    clientInput = document.getElementById("clientIdInput").value;
                    const clientPhoneRaw = document.getElementById("clientPhoneInput") 
                        ? document.getElementById("clientPhoneInput").value.trim() 
                        : "";
                    clientPhoneNumber = clientPhoneRaw || null; // send only if exists

                    
                    document.getElementById("id-error").style.display = "none";
                    if (clientInput == "" || clientPhoneNumber == null){
                        document.getElementById("id-error").style.display = "block";
                        temp_payload = false
                    }
    
                    payload = {
                        client_id: clientInput,
                        client_phone_number:clientPhoneNumber,
                        timestamp: new Date().toISOString(),
                        user_email: "{{ request.user.email }}",  // example user field
                        payments: payments,
                        maintenance_fees: final_maintenance,
                        gas_fees: final_gas,
                        final_price: final_price,
                        basic_price: basic_price_value,
                        dates: newDates,
                        companyName: companyName,
                        unitCode: codeOnly,
                        tenor_years: tenor_years,
                        project_name: project_name,
                        selected_currency_name : document.getElementById("currency").value
                    };
    
                }
                else if (!hasMaintenance && !hasGas){
                    clientInput = document.getElementById("clientIdInput").value;
                    const clientPhoneRaw = document.getElementById("clientPhoneInput") 
                        ? document.getElementById("clientPhoneInput").value.trim() 
                        : "";
                    clientPhoneNumber = clientPhoneRaw || null; // send only if exists

                    document.getElementById("id-error").style.display = "none";
                    if (clientInput == "" || clientPhoneNumber == null){
                        document.getElementById("id-error").style.display = "block";
                        temp_payload = false
                    }
    
                    // Example payload ‚Äî expand with more fields later
                    payload = {
                        client_id: clientInput,
                        client_phone_number:clientPhoneNumber,

                        timestamp: new Date().toISOString(),
                        user_email: "{{ request.user.email }}",  // example user field
                        payments: payments,
                        final_price: final_price,
                        basic_price: basic_price_value,
                        dates: newDates,
                        companyName: companyName,
                        unitCode: codeOnly,
                        tenor_years: tenor_years,
                        project_name: project_name,
                        selected_currency_name : document.getElementById("currency").value
                    };
    
                }
                else if (!hasMaintenance && hasGas){
                    // Example payload ‚Äî expand with more fields later
                    clientInput = document.getElementById("clientIdInput").value;
                    const clientPhoneRaw = document.getElementById("clientPhoneInput") 
                        ? document.getElementById("clientPhoneInput").value.trim() 
                        : "";
                    clientPhoneNumber = clientPhoneRaw || null; // send only if exists

                    document.getElementById("id-error").style.display = "none";
                    if (clientInput == "" || clientPhoneNumber == null){
                        document.getElementById("id-error").style.display = "block";
                        temp_payload = false
                    }
    
                    payload = {
                        client_id: clientInput,
                        client_phone_number:clientPhoneNumber,

                        timestamp: new Date().toISOString(),
                        user_email: "{{ request.user.email }}",  // example user field
                        payments: payments,
                        gas_fees: final_gas,
                        final_price: final_price,
                        basic_price: basic_price_value,
                        dates: newDates,
                        companyName: companyName,
                        unitCode: codeOnly,
                        tenor_years: tenor_years,
                        project_name: project_name,
                        selected_currency_name : document.getElementById("currency").value
                    };
    
                }
                else if (hasMaintenance && !hasGas){
                    // Example payload ‚Äî expand with more fields later
                    clientInput = document.getElementById("clientIdInput").value;
                    const clientPhoneRaw = document.getElementById("clientPhoneInput") 
                        ? document.getElementById("clientPhoneInput").value.trim() 
                        : "";
                    clientPhoneNumber = clientPhoneRaw || null; // send only if exists

                    console.log(`clientInput = ${clientInput}`)
                    console.log(`clientPhoneNumber = ${clientPhoneNumber}`)
    
                    payload = {
                        client_id: clientInput,
                        client_phone_number:clientPhoneNumber,

                        timestamp: new Date().toISOString(),
                        user_email: "{{ request.user.email }}",  // example user field
                        payments: payments,
                        maintenance_fees: final_maintenance,
                        final_price: final_price,
                        basic_price: basic_price_value,
                        dates: newDates,
                        companyName: companyName,
                        unitCode: codeOnly,
                        tenor_years: tenor_years,
                        project_name: project_name,
                        selected_currency_name : document.getElementById("currency").value
                    };
    
                }
            }
            



            
           if (temp_payload == false){
                
            }
            else{

                // --- UI UPDATE: SHOW LOADER ---
                document.getElementById("holdModalButtons").style.display = "none";
                document.getElementById("holdModalLoading").style.display = "block";

                fetch("{% url 'send_hold_to_erp' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify(payload)
                    })
                    .then(async (response) => {
                    // parse JSON safely
                    let data = {};
                    try { data = await response.json(); } catch (e) {}

                    // ‚úÖ handle HTTP errors properly
                    if (!response.ok || data.status !== "success") {
                        const msg = data.message || "Failed to Hold Unit!";
                        throw new Error(msg);
                    }

                    return data; // success path
                    })
                    .then(data => {
                    closeHoldModal();

                    // ‚úÖ show success only on real success
                    document.getElementById("alert-url").style.display = "block";

                    setTimeout(() => {
                        window.location.href = "{% url 'home' %}";
                    }, 1000);

                    document.getElementById("input-container").style.display = "none";
                    document.getElementById("installmentTableContainer").style.display = "none";
                    })
                    .catch(error => {
                    console.error("Error sending hold:", error);

                    // ‚úÖ show the real backend message (e.g. "Unit Already Blocked")
                    alert(error.message);

                    setTimeout(() => {
                        window.location.href = "{% url 'home' %}";
                    }, 1000);

                    document.getElementById("input-container").style.display = "none";
                    document.getElementById("installmentTableContainer").style.display = "none";

                    // REVERT UI ON ERROR
                    document.getElementById("holdModalButtons").style.display = "block";
                    document.getElementById("holdModalLoading").style.display = "none";
                    });

            }
                
            console.log(payload)
        }


        // Auto-submit when unit code is selected
        document.addEventListener("DOMContentLoaded", function () {
            // For ERP units (with dropdown)
            const unitInputERP = document.getElementById("unitInput");
            if (unitInputERP) {
                unitInputERP.addEventListener("change", function() {
                    if (this.value.trim()) {
                        document.getElementById("searchForm2").submit();
                    }
                });
            }

            // For regular unit search
            const unitCodeSearchNew = document.getElementById("unitCodeSearchNew");
            if (unitCodeSearchNew) {
                unitCodeSearchNew.addEventListener("change", function() {
                    if (this.value.trim()) {
                        document.getElementById("searchForm2").submit();
                    }
                });
            }

            // For controller view unit search
            const unitCodeSearch = document.getElementById("unitCodeSearch");
            if (unitCodeSearch) {
                unitCodeSearch.addEventListener("change", function() {
                    if (this.value.trim()) {
                        document.getElementById("searchForm").submit();
                    }
                });
            }

            // Auto-submit when selecting from datalist (for all unit inputs)
            document.addEventListener('input', function(e) {
                if (e.target.list && e.target.list.id === 'unitCodeOptionsNew') {
                    const input = e.target;
                    const options = document.getElementById('unitCodeOptionsNew').options;
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].value === input.value) {
                            document.getElementById("searchForm2").submit();
                            break;
                        }
                    }
                }
                
                if (e.target.list && e.target.list.id === 'unitCodeOptions') {
                    const input = e.target;
                    const options = document.getElementById('unitCodeOptions').options;
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].value === input.value) {
                            document.getElementById("searchForm").submit();
                            break;
                        }
                    }
                }
            });
        });

        

    </script>

    <div id="pdf-generator-container" style="position: absolute; left: -9999px; top: -9999px;">
        <canvas id="masterplanCanvas"></canvas>
    </div>

    <script>


        const apiUrls = {
            getProjectMasterplan: "{% url 'get_project_masterplan' 0 %}", 
            getUnitDetails: "{% url 'get_unit_details_for_masterplan' 'UNIT_CODE_PH' %}" ,
            getUnitPinData: "{% url 'get_unit_pin_data' 'UNIT_CODE_PH' %}" // <--- NEW URL
        };
        
        try{

        const App = {
    // ---------------------------------------------------------
    // Helper: Load Image to Data URL (with Debugging)
    // ---------------------------------------------------------
    loadImage: (url) => {
        // console.log(`[DEBUG] Attempting to load image: ${url}`);
        return new Promise((resolve) => {
            const img = new Image();
            img.crossOrigin = "Anonymous"; 
            img.onload = () => resolve(img);
            img.onerror = (e) => {
                console.error(`[DEBUG] FAILED to load image: ${url}`, e);
                resolve(null);
            };
            img.src = url;
        });
    },

    // ---------------------------------------------------------
    // Helper: Get Base64 from URL
    // ---------------------------------------------------------
    getBase64FromUrl: async (url) => {
        const img = await App.loadImage(url);
        if (!img) return null;
        
        const canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        return canvas.toDataURL("image/jpeg", 0.9); // Slight quality bump for PDF
    },

    // ---------------------------------------------------------
    // Helper: Calculate Aspect Ratio Fit
    // ---------------------------------------------------------
    getFittedImageDimensions: (imgWidth, imgHeight, maxWidth, maxHeight) => {
        const ratio = Math.min(maxWidth / imgWidth, maxHeight / imgHeight);
        return {
            width: imgWidth * ratio,
            height: imgHeight * ratio
        };
    },

    // ---------------------------------------------------------
    // Helper: Fetch Unit Layout Images
    // ---------------------------------------------------------
    getUnitLayoutImages: async (unitCode) => {
        try {
            const url = apiUrls.getUnitDetails.replace('UNIT_CODE_PH', unitCode);
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.data && data.data.layout_images && data.data.layout_images.length > 0) {
                return data.data.layout_images;
            }
            return [];
        } catch (e) {
            console.error("Error fetching layout images:", e);
            return [];
        }
    },

    // ---------------------------------------------------------
    // Helper: Generate Masterplan with Pin
    // ---------------------------------------------------------
    generateMasterplanWithPin: async (projectId, unitCode) => {
        try {
            const pinUrl = apiUrls.getUnitPinData.replace('UNIT_CODE_PH', unitCode);
            const response = await fetch(pinUrl);
            
            if (response.status !== 200) return null;

            const data = await response.json();
            if (!data.masterplan_url || !data.x_percent || !data.y_percent) return null;

            const bgImage = await App.loadImage(data.masterplan_url);
            if (!bgImage) return null;

            const canvas = document.createElement("canvas");
            canvas.width = bgImage.width;
            canvas.height = bgImage.height;
            const ctx = canvas.getContext('2d');

            ctx.drawImage(bgImage, 0, 0);

            const xPercent = parseFloat(data.x_percent);
            const yPercent = parseFloat(data.y_percent);

            if (isNaN(xPercent) || isNaN(yPercent)) return null;

            const x = (xPercent / 100) * canvas.width;
            const y = (yPercent / 100) * canvas.height;

            // Pin Styling
            const pinSize = canvas.width * 0.0075; // Slightly larger for high-res

            // Shadow
            ctx.shadowColor = "rgba(0, 0, 0, 0.6)";
            ctx.shadowBlur = 15;
            ctx.shadowOffsetY = 8;

            // Pin Head
            ctx.beginPath();
            ctx.arc(x, y - pinSize, pinSize, 0, 2 * Math.PI, false);
            ctx.fillStyle = "#dc3545"; 
            ctx.fill();
            ctx.lineWidth = pinSize / 3;
            ctx.strokeStyle = "#ffffff";
            ctx.stroke();

            // Pin Tip
            ctx.beginPath();
            ctx.moveTo(x - (pinSize * 0.7), y - (pinSize * 0.8));
            ctx.lineTo(x + (pinSize * 0.7), y - (pinSize * 0.8));
            ctx.lineTo(x, y);
            ctx.fillStyle = "#dc3545";
            ctx.fill();

            return canvas.toDataURL('image/jpeg', 0.9);
        } catch (e) {
            console.error("EXCEPTION in generateMasterplanWithPin:", e);
            return null;
        }
    },

    // ---------------------------------------------------------
    // Main Export Function (STYLED)
    // ---------------------------------------------------------
    exportPdf: function () {
        const exportBtn = document.getElementById("exportPdfButton");
        if(!exportBtn) return;

        exportBtn.addEventListener("click", async function () {
            const btn = this;
            const originalText = btn.innerText;
            btn.innerText = "Generating PDF...";
            btn.disabled = true;

            try {
                // 1. Validation
                let tableContainer = document.getElementById("installmentTableContainer");
                if (!tableContainer || tableContainer.style.display === "none") {
                    throw new Error("No payment plan available to export.");
                }

                // 2. Setup PDF (A4: 210mm x 297mm)
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
                const pageWidth = doc.internal.pageSize.getWidth(); // 210
                const pageHeight = doc.internal.pageSize.getHeight(); // 297
                const margin = 15;
                const maxContentWidth = pageWidth - (margin * 2);

                // Colors
                const colorPrimary = [211, 84, 0]; // Orange
                const colorDark = [44, 62, 80];    // Dark Blue/Grey
                const colorLight = [245, 245, 245]; // Light Grey

                // ------------------------------------------------
                // HEADER FUNCTION (To add to page 1)
                // ------------------------------------------------
                const addHeader = async () => {
                    const systemLogoUrl = "/static/images/logo serag-final_page-0002.png"; 
                    const companyLogoUrl = "{{ company.logo.url }}"; 
                    
                    const [systemLogoData, companyLogoData] = await Promise.all([
                        App.getBase64FromUrl(systemLogoUrl),
                        App.getBase64FromUrl(companyLogoUrl)
                    ]);

                    if (systemLogoData) doc.addImage(systemLogoData, 'JPEG', margin, margin, 35, 18);
                    if (companyLogoData) doc.addImage(companyLogoData, 'JPEG', pageWidth - margin - 20, margin, 20, 20);

                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(22);
                    doc.setTextColor(...colorPrimary);
                    doc.text("UNIT PROPOSAL", pageWidth / 2, margin + 12, { align: "center" });
                    
                    // Separator Line
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.5);
                    doc.line(margin, margin + 25, pageWidth - margin, margin + 25);
                };

                // ------------------------------------------------
                // PAGE 1: Unit Info
                // ------------------------------------------------
                await addHeader();

                const unitCode = document.getElementById("unit_code")?.value || "N/A";
                const currentDate = new Date().toLocaleString("en-GB", { dateStyle: 'medium' });

                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(`Generated on: ${currentDate}`, pageWidth / 2, margin + 32, { align: "center" });

                const getVal = (id) => {
                    const el = document.getElementById(id);
                    return el && el.value ? el.value : "-";
                };

                // Helper to format area: only add " m¬≤" if value exists and isn't "-"
                const fmtArea = (val) => (val && val !== "-" && val !== "null") ? val + " m¬≤" : null;
                const fmtPrice = (val) => (val && val !== "-" && val !== "null") ? val : null;
                const fmtDisc = (val) => (val && val !== "-" && val !== "null") ? val + "%" : null;
                
                // Remove commas (and any other currency formatting) before parsing
                const cleanBase = getVal("basic_price").replace(/,/g, '');
                const cleanFinal = getVal("final_price").replace(/,/g, '');

                const baseP = parseFloat(cleanBase);
                const finalP = parseFloat(cleanFinal);

                // Your existing logic remains the same
                let discountVal = null;
                if (!isNaN(baseP) && !isNaN(finalP) && baseP > 0) {
                    const diff = baseP - finalP;
                    if (diff > 0) {
                        discountVal = ((diff / baseP) * 100).toFixed(1) + "%";
                    }
                }


                // Prepare Data for Info Table
                // Define all potential rows
                const rawInfoBody = [
                    ["Project", getVal("project_name")],
                    ["Unit Code", getVal("unit_code")],
                    ["Unit Type", getVal("unit_type")],
                    ["Building", getVal("building_type")],
                    ["Floor", getVal("floor")],
                    ["Bedrooms", getVal("num_bedrooms")],
                    ["Finishing", getVal("finishing_specs")],
                    ["Delivery Date", getVal("delivery_date")],
                    
                    // --- Areas Section ---
                    [{content: 'Areas', colSpan: 2, styles: { fillColor: [230, 230, 230], fontStyle: 'bold', halign: 'center' }}],
                    ["Gross Area", fmtArea(getVal("net_area"))],
                    ["Garden Area", fmtArea(getVal("garden_area"))],
                    ["Land Area", fmtArea(getVal("land_area"))],
                    ["Penthouse", fmtArea(getVal("penthouse_area"))],
                    ["Roof/Terrace", fmtArea(getVal("uncovered_terraces"))],

                    // --- Pricing Section ---
                    [{content: 'Unit Pricing', colSpan: 2, styles: { fillColor: [230, 230, 230], fontStyle: 'bold', halign: 'center' }}],
                    ["Unit Base Price", fmtPrice(getVal("basic_price"))],
                    ["Discount", discountVal], // Automatically null if no discount or missing prices
                    ["Unit Final Price", fmtPrice(getVal("final_price"))]
                ];

                // --- FILTER LOGIC ---
                // Remove rows where the value (index 1) is null, empty, "-", or "null"
                const infoBody = rawInfoBody.filter((row, index, self) => {
                    // 1. Always keep the custom section headers ("Areas" and "Unit Pricing")
                    if (row.length === 1 && typeof row[0] === 'object') {
                        // Optional: Check if the section actually has any data below it
                        // to avoid showing a header for an empty section
                        return true; 
                    }

                    const val = row[1];
                    // 2. Filter out null, empty, or "-" values
                    return val && val !== "-" && val !== "null" && String(val).trim() !== "";
                });

                doc.autoTable({
                    startY: margin + 40,
                    head: [['Specification', 'Details']],
                    body: infoBody,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: colorDark, 
                        textColor: 255, 
                        fontSize: 12, 
                        fontStyle: 'bold',
                        halign: 'left'
                    },
                    bodyStyles: { 
                        fontSize: 11, 
                        cellPadding: 6,
                        textColor: 50
                    },
                    columnStyles: { 
                        0: { fontStyle: 'bold', width: 60, fillColor: colorLight },
                        1: { width: 'auto' }
                    },
                    margin: { left: margin, right: margin }
                });

                // ------------------------------------------------
                // PAGE 2: Masterplan (Dedicated Page)
                // ------------------------------------------------
                const mapDataUrl = await App.generateMasterplanWithPin(null, unitCode);
                
                if (mapDataUrl) {
                    doc.addPage();
                    
                    // Title
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(16);
                    doc.setTextColor(...colorDark);
                    doc.text("MASTERPLAN LOCATION", margin, margin + 5);

                    // Load image to get dimensions for aspect ratio
                    const mapImg = await App.loadImage(mapDataUrl);
                    if(mapImg) {
                        const availableWidth = maxContentWidth;
                        const availableHeight = pageHeight - (margin * 3); // Top + Bottom margin space
                        
                        // Calculate best fit
                        const dims = App.getFittedImageDimensions(mapImg.width, mapImg.height, availableWidth, availableHeight);
                        
                        // Center horizontal, fixed top margin
                        const xPos = (pageWidth - dims.width) / 2;
                        
                        doc.addImage(mapDataUrl, 'JPEG', xPos, margin + 15, dims.width, dims.height);
                    }
                }

                // ------------------------------------------------
                // SUBSEQUENT PAGES: Unit Layouts (One per page)
                // ------------------------------------------------
                const layoutImages = await App.getUnitLayoutImages(unitCode);

                for (let i = 0; i < layoutImages.length; i++) {
                    const layoutUrl = layoutImages[i];
                    const layoutImg = await App.loadImage(layoutUrl); // Load as object to get dims
                    
                    if (layoutImg) {
                        doc.addPage();
                        
                        // Title
                        doc.setFont("helvetica", "bold");
                        doc.setFontSize(16);
                        doc.setTextColor(...colorDark);
                        doc.text(`UNIT LAYOUT ${i + 1}`, margin, margin + 5);

                        const availableWidth = maxContentWidth;
                        const availableHeight = pageHeight - (margin * 3);
                        
                        // Calculate Aspect Ratio
                        const dims = App.getFittedImageDimensions(layoutImg.width, layoutImg.height, availableWidth, availableHeight);
                        
                        // Center Image
                        const xPos = (pageWidth - dims.width) / 2;
                        const yPos = (pageHeight - dims.height) / 2; // Center vertically as well

                        doc.addImage(layoutImg, 'JPEG', xPos, yPos, dims.width, dims.height);
                    }
                }

                // ------------------------------------------------
                // FINAL SECTION: Installment Plan (No Input Column)
                // ------------------------------------------------

                const tableEl = document.querySelector(".installment-table");
                if (tableEl) {
                    doc.addPage();

                    // Title
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(16);
                    doc.setTextColor(...colorPrimary);
                    doc.text("PAYMENT SCHEDULE", 10, 15); // Tighter top margin (10mm)

                    // Process Table Data: Remove 3rd Column
                    const headers = [];
                    const body = [];
                    
                    // Headers
                    const ths = Array.from(tableEl.querySelectorAll("thead th"));
                    const headerRow = ths
                        .filter((_, index) => index !== 2) 
                        .map(th => th.innerText);
                    headers.push(headerRow);

                    // Body
                    const trs = tableEl.querySelectorAll("tbody tr");
                    trs.forEach(tr => {
                        const tds = Array.from(tr.querySelectorAll("td"));
                        const rowData = tds
                            .filter((_, index) => index !== 2)
                            .map(td => td.innerText);
                        
                        if (rowData.some(cell => cell.trim() !== "" && cell !== "-")) {
                            body.push(rowData);
                        }
                    });

                    // Totals Row (Footer)
                    const tfoot = tableEl.querySelector("tfoot tr");
                    const foot = [];
                    if (tfoot) {
                         const tfs = Array.from(tfoot.querySelectorAll("th, td"));
                         const footRow = tfs
                            .filter((_, index) => index !== 2)
                            .map(tf => tf.innerText);
                         foot.push(footRow);
                    }

                    doc.autoTable({
                        startY: 20, // Start immediately after title
                        head: headers,
                        body: body,
                        foot: foot.length > 0 ? foot : undefined,
                        theme: 'striped',
                        
                        // --- COMPRESSION SETTINGS ---
                        styles: { 
                            fontSize: 7,       // Small font to fit many rows
                            cellPadding: 1,    // Minimal padding to reduce row height
                            halign: 'center',
                            valign: 'middle',
                            overflow: 'linebreak'
                        },
                        headStyles: { 
                            fillColor: colorPrimary, 
                            fontSize: 8,       // Slightly larger for header
                            fontStyle: 'bold',
                            cellPadding: 1.5   // Slightly more padding for header
                        },
                        footStyles: {
                            fillColor: colorDark,
                            fontSize: 8,
                            fontStyle: 'bold',
                            cellPadding: 1.5
                        },
                        // --- MAXIMIZE WIDTH ---
                        margin: { left: 5, right: 5, bottom: 5 } // Minimal margins
                    });
                }

                // ------------------------------------------------
                // Save
                // ------------------------------------------------
                doc.save(`Proposal_${unitCode}.pdf`);

            } catch (err) {
                console.error(">>> CRITICAL ERROR in exportPdf:", err);
                alert("Error generating PDF: " + err.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });
    },

    // ---------------------------------------------------------
    // Export to Excel
    // ---------------------------------------------------------
    exportExcel: function () {
        const excelBtn = document.getElementById("exportExcelButton");
        if(!excelBtn) return;

        excelBtn.addEventListener("click", function () {
            let tableContainer = document.getElementById("installmentTableContainer");
            if (!tableContainer || tableContainer.style.display === "none") {
                alert("No table to export!");
                return;
            }
            const XLSX = window.XLSX; 
            if(!XLSX) {
                alert("Excel library not loaded.");
                return;
            }
            const unitCode = document.getElementById("unit_code")?.value || "N/A";
            const table = document.querySelector(".installment-table");
            const wb = XLSX.utils.table_to_book(table, {sheet: "Installments"});
            XLSX.writeFile(wb, `Installment_Report_${unitCode}.xlsx`);
        });
    },

    // ---------------------------------------------------------
    // Helper: Floor Input Values
    // ---------------------------------------------------------
    floorInputValues: function () {
        function floorInputValue(inputId) {
            const inputElement = document.getElementById(inputId);
            if (inputElement) {
                const value = parseFloat(inputElement.value);
                if (!isNaN(value)) {
                    inputElement.value = Math.floor(value); 
                } else {
                    inputElement.value = "-"; 
                }
            }
        }
        floorInputValue("net_area"); 
        floorInputValue("garden_area"); 
        floorInputValue("penthouse_area"); 
        floorInputValue("uncovered_terraces");
    },

    // ---------------------------------------------------------
    // Initialize
    // ---------------------------------------------------------
    init: function () {
        document.addEventListener("DOMContentLoaded", function () {
            try {
                App.exportPdf();
                App.exportExcel();
                App.floorInputValues();
            } catch (e) {
                console.warn("App init error:", e);
            }
        });
    }
};

App.init();


        document.addEventListener("DOMContentLoaded", function () {
            try{

                // Store all original options for resetting the datalist
                const unitCodeSearch = document.getElementById("unitCodeSearch");
                const unitCodeOptions = document.getElementById("unitCodeOptions");
                const originalOptions = Array.from(unitCodeOptions.options);
                
                // Add event listener to filter options dynamically
                unitCodeSearch.addEventListener("input", function () {
                    const searchTerm = unitCodeSearch.value.trim().toLowerCase();

                    // Clear the datalist
                    unitCodeOptions.innerHTML = "";

                    // Filter and populate the datalist with matching options
                    const filteredOptions = originalOptions.filter(option => {
                        return option.value.toLowerCase().includes(searchTerm);
                    });

                    if (filteredOptions.length > 0) {
                        filteredOptions.forEach(option => unitCodeOptions.appendChild(option.cloneNode(true)));
                    } else {
                        // If no matches, show a "No results" option
                        const noResultsOption = document.createElement("option");
                        noResultsOption.value = "";
                        noResultsOption.textContent = "No matching Unit Codes";
                        noResultsOption.disabled = true;
                        unitCodeOptions.appendChild(noResultsOption);
                    }
                });
            }catch{
                
            }
            

            
        });


        document.addEventListener("DOMContentLoaded", function () {
            try{
                if (isCompanyERPUnits == false) {
                const projectSelect   = document.getElementById("projectName");
                const unitCodeSearch  = document.getElementById("unitCodeSearchNew");
                const unitCodeOptions = document.getElementById("unitCodeOptionsNew");
            
                // Cache all options with metadata
                const allUnits = Array.from(unitCodeOptions.querySelectorAll("option")).map(opt => ({
                    value:   opt.value,
                    text:    opt.textContent,
                    project: opt.dataset.project || "",
                    company: opt.dataset.company || ""
                }));
            
                function filterUnits() {
                    const searchTerm      = unitCodeSearch.value.trim().toLowerCase();
                    const selectedProject = projectSelect ? projectSelect.value : "";
            
                    unitCodeOptions.innerHTML = "";
            
            
                    const filtered = allUnits.filter(u =>
                    u.value.toLowerCase().includes(searchTerm) &&
                    (!selectedProject || u.project === selectedProject)
                    );
            
                    if (filtered.length === 0) {
                    const noRes = document.createElement("option");
                    noRes.value = "";
                    noRes.textContent = "No matching Unit Codes";
                    noRes.disabled = true;
                    unitCodeOptions.appendChild(noRes);
                    return;
                    }
            
                    filtered.forEach(u => {
                    const opt = document.createElement("option");
                    opt.value = u.value;
                    opt.textContent = u.text;
                    opt.dataset.project = u.project;
                    opt.dataset.company = u.company;
                    unitCodeOptions.appendChild(opt);
                    });
                }
            
                // üîπ Event listeners
                unitCodeSearch.addEventListener("input", filterUnits);
                if (projectSelect) projectSelect.addEventListener("change", filterUnits);
                }

            }
            catch(e){}
        });
        
        document.addEventListener("DOMContentLoaded", function () {
            const searchForm = document.getElementById("searchForm");
            const projectSelect = document.getElementById("projectName");
            const unitInput = document.getElementById("unitCodeSearch") || document.getElementById("unitCodeSearchNew");
            const warningModal = new bootstrap.Modal(document.getElementById("warningModal"));

            try{
                searchForm.addEventListener("submit", function (e) {
                    const projectValue = projectSelect.value.trim();
                    const unitValue = unitInput.value.trim();
            
                    if (!projectValue || !unitValue) {
                        e.preventDefault();
                        warningModal.show();
                    }
                    else{
                        let holdButton = document.getElementById("hold-button")
                        holdButton.style.display = "none";
                    }
                });
            
                // Hide modal when user interacts with dropdowns
                [projectSelect, unitInput].forEach(dropdown => {
                    dropdown.addEventListener("change", () => {
                        warningModal.hide(); // Hide the modal if user starts interacting
                    });
                });
            }
            catch(e){

            }
            
        });

        function closeModal() {
            const modal = document.getElementById("warningModal");

            // Hide the modal
            modal.style.display = "none";
            modal.classList.remove("show"); // remove bootstrap "show" class

            // Remove backdrop manually
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.remove();
            }

            // Allow body scrolling and remove blur/freeze effects
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }  


        document.addEventListener("DOMContentLoaded", function () {
            try {
            const companyFilter   = document.getElementById("companyFilter");
            const projectSelect   = document.getElementById("projectName");   // üÜï add project filter
            const unitCodeSearch  = document.getElementById("unitCodeSearch");
            const unitCodeOptions = document.getElementById("unitCodeOptions");
        
            // Cache all units with project + company info
            try{

                const allUnits = Array.from(unitCodeOptions.querySelectorAll("option")).map(option => ({
                    value:   option.value,
                    text:    option.textContent,
                    project: option.dataset.project || "",   // ‚Üê make sure each option has this attribute
                    company: option.dataset.company || ""    // ‚Üê if you store company too
                }));
            
                // Disable search initially
                unitCodeSearch.disabled = true;
            }
            catch(e){}
        
            function filterUnits() {
                
                try{
                    const selectedCompany = companyFilter.value;
                }
                catch(e){}
                const selectedProject = projectSelect.value;

                try{
                    unitCodeOptions.innerHTML = "";
                }
                catch(e){}
        
                
                try{
                    if (!selectedCompany || !selectedProject) {
                    unitCodeSearch.disabled = true;
                    unitCodeSearch.value = "";
                    return;
                    }

                }catch(e){}
        
                try{
                    unitCodeSearch.disabled = false;
                }
                catch(e){}
                
                try{
                    const filteredUnits = allUnits.filter(unit =>
                    unit.value.endsWith("_" + selectedCompany) &&
                    (!selectedProject || unit.project === selectedProject)
                    );
            
                    filteredUnits.forEach(unit => {
                    const option = document.createElement("option");
                    option.value = unit.value;
                    option.textContent = unit.text;
                    option.dataset.project = unit.project;
                    option.dataset.company = unit.company;
                    unitCodeOptions.appendChild(option);
                    });
                    
                }
                catch(e){}
            }
            
            try{
                companyFilter.addEventListener("change", filterUnits);
            }
            catch(e){}
            projectSelect.addEventListener("change", filterUnits);
        
            } catch (err) {
            console.error("Error in company/project filter setup:", err);
            }
        });
        

        document.addEventListener("DOMContentLoaded", function () {
            try {
            const companyFilter = document.getElementById("companyFilter");
            const projectSelect = document.getElementById("projectName");
        
            // Use whichever input/datalist exists on the page
            const unitCodeSearch = document.getElementById("unitCodeSearch") || document.getElementById("unitCodeSearchNew");
            const unitCodeOptions = document.getElementById("unitCodeOptions") || document.getElementById("unitCodeOptionsNew");
        
            if (!companyFilter || !projectSelect || !unitCodeSearch || !unitCodeOptions) return;
        
            // Cache ALL units with their metadata (value, label, project)
            const allUnits = Array.from(unitCodeOptions.querySelectorAll("option")).map(opt => ({
                value: opt.value,
                text: opt.textContent,
                project: opt.dataset.project || "",     // ‚Üê make sure your <option> has data-project="PROJECT_ID"
                company: opt.dataset.company || ""      // ‚Üê optional: if you embed company per option
            }));
        
            // Disable until company chosen (and optionally project)
            unitCodeSearch.disabled = true;
        
            companyFilter.addEventListener("change", () => {
                unitCodeSearch.value = "";
                unitCodeOptions.innerHTML = "";
                unitCodeSearch.disabled = !companyFilter.value;
                filterUnitCodes(); // refresh list for the new company
            });
        
            projectSelect.addEventListener("change", () => {
                unitCodeSearch.value = "";
                filterUnitCodes();
            });
        
            unitCodeSearch.addEventListener("input", () => {
                filterUnitCodes();
            });
        
            function filterUnitCodes() {
                const searchTerm = unitCodeSearch.value.trim().toLowerCase();
                const selectedCompany = companyFilter.value;     // e.g. "ACME"
                const selectedProject = projectSelect.value;     // your project id/value
        
                unitCodeOptions.innerHTML = "";
        
                // If you want to strictly require a project, bail out early when not selected:
                if (!selectedCompany || !selectedProject) {
                return; // no suggestions until both are selected
                }
        
                // Filter by company + project + searchTerm
                const filtered = allUnits.filter(u =>
                (!u.company || u.company === selectedCompany) &&     // if company stored per option
                u.project === selectedProject &&                     // MUST match selected project
                u.value.toLowerCase().includes(searchTerm)
                );
        
                if (filtered.length === 0) {
                const noResults = document.createElement("option");
                noResults.value = "";
                noResults.textContent = "No matching Unit Codes";
                noResults.disabled = true;
                unitCodeOptions.appendChild(noResults);
                return;
                }
        
                filtered.forEach(u => {
                const opt = document.createElement("option");
                opt.value = u.value;
                opt.textContent = u.text;
                opt.dataset.project = u.project;
                if (u.company) opt.dataset.company = u.company;
                unitCodeOptions.appendChild(opt);
                });
            }
            } catch (e) {
            console.error("Unit code filtering setup failed:", e);
            }
        });
        


        document.addEventListener("DOMContentLoaded", function () {
            try {
                const companyFilter = document.getElementById("companyFilter");
                const projectSelect = document.getElementById("projectName");

                // Store all project options initially
                const allProjectOptions = Array.from(projectSelect.options);

                try{
                    companyFilter.addEventListener("change", function () {
                        const selectedCompany = this.value;
            
                        // Clear current options except the placeholder
                        projectSelect.innerHTML = "";
                        const placeholderOption = document.createElement("option");
                        placeholderOption.textContent = "-- Select Project --";
                        placeholderOption.value = "";
                        projectSelect.appendChild(placeholderOption);
            
                        // Filter and append relevant projects
                        allProjectOptions.forEach(option => {
                            if (
                                option.value &&  // skip placeholder
                                option.dataset.company === selectedCompany
                            ) {
                                projectSelect.appendChild(option.cloneNode(true));
                            }
                        });
                    });
                }
                catch(e){}
                
            } catch (e) {
                console.error("Error filtering project dropdown:", e);
            }
        });

        }
        catch{
            
        }

    </script>
        
    <script>
        // 1. Receive the Units JSON
        // The |safe filter prevents Django from escaping the quotes
        var units = {{ units_json|safe }};

        // 2. Receive the Clients JSON (since we cleaned that up too)
        var clients = {{ clients|safe }};

        console.log(clients)

        // 3. Receive Project Data (restored in the view)
        var project_data = {{ project_data|safe }};
    </script>

    <script src="{% static 'script/index.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}
